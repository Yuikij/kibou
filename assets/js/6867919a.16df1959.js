"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[1868],{6059:(n,e,a)=>{a.r(e),a.d(e,{assets:()=>o,contentTitle:()=>s,default:()=>h,frontMatter:()=>r,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"basicKnowledge/programmingLanguage/Java/\u5e76\u53d1/\u5e76\u53d1\u7f16\u7a0b\u5bb9\u5668\u548c\u5de5\u5177","title":"\u5e76\u53d1\u7f16\u7a0b\u5bb9\u5668\u548c\u5de5\u5177","description":"ConcurrentHashMap","source":"@site/docs/basicKnowledge/programmingLanguage/Java/\u5e76\u53d1/\u5e76\u53d1\u7f16\u7a0b\u5bb9\u5668\u548c\u5de5\u5177.mdx","sourceDirName":"basicKnowledge/programmingLanguage/Java/\u5e76\u53d1","slug":"/basicKnowledge/programmingLanguage/Java/\u5e76\u53d1/\u5e76\u53d1\u7f16\u7a0b\u5bb9\u5668\u548c\u5de5\u5177","permalink":"/kibou/docs/basicKnowledge/programmingLanguage/Java/\u5e76\u53d1/\u5e76\u53d1\u7f16\u7a0b\u5bb9\u5668\u548c\u5de5\u5177","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"sidebar_position":4},"sidebar":"programmingLanguage","previous":{"title":"\u7ebf\u7a0b\u6c60","permalink":"/kibou/docs/basicKnowledge/programmingLanguage/Java/\u5e76\u53d1/\u7ebf\u7a0b\u6c60"},"next":{"title":"\u5e76\u53d1\u7f16\u7a0b\u6a21\u578b","permalink":"/kibou/docs/basicKnowledge/programmingLanguage/Java/\u5e76\u53d1/\u5e76\u53d1\u7f16\u7a0b\u6a21\u578b"}}');var l=a(74848),i=a(28453);const r={sidebar_position:4},s=void 0,o={},c=[{value:"ConcurrentHashMap",id:"concurrenthashmap",level:2},{value:"\u4e3b\u8981\u7528\u6cd5",id:"\u4e3b\u8981\u7528\u6cd5",level:3},{value:"JDK1.7",id:"jdk17",level:3},{value:"\u5bb9\u5668\u5b9e\u4f53",id:"\u5bb9\u5668\u5b9e\u4f53",level:4},{value:"segment\u76f8\u5173",id:"segment\u76f8\u5173",level:4},{value:"put",id:"put",level:4},{value:"JDK1.8",id:"jdk18",level:3},{value:"\u5bb9\u5668\u5b9e\u4f53",id:"\u5bb9\u5668\u5b9e\u4f53-1",level:4},{value:"put",id:"put-1",level:4},{value:"\u6269\u5bb9",id:"\u6269\u5bb9",level:3},{value:"Q&amp;A",id:"qa",level:3},{value:"CopyOnWriteArrayList",id:"copyonwritearraylist",level:2},{value:"CountDownLatch",id:"countdownlatch",level:2},{value:"LongAdder",id:"longadder",level:2}];function d(n){const e={blockquote:"blockquote",code:"code",h2:"h2",h3:"h3",h4:"h4",li:"li",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...n.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(e.h2,{id:"concurrenthashmap",children:"ConcurrentHashMap"}),"\n",(0,l.jsx)(e.h3,{id:"\u4e3b\u8981\u7528\u6cd5",children:"\u4e3b\u8981\u7528\u6cd5"}),"\n",(0,l.jsxs)(e.blockquote,{children:["\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u786e\u4fdd\u5199\u5165\u7684\u7ebf\u7a0b\u5b89\u5168\uff0c\u524d\u63d0\u662f\u5199\u5165\u7684\u503c\u4e0d\u80fd\u4f9d\u8d56ConcurrentHashMap\u672c\u8eab\u7684get\u7ed3\u679c"}),"\n",(0,l.jsx)(e.li,{children:"merge,compute\u4fdd\u8bc1\u7684\u8bfb\u5199\u7684\u539f\u5b50\u6027"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.h3,{id:"jdk17",children:"JDK1.7"}),"\n",(0,l.jsx)(e.h4,{id:"\u5bb9\u5668\u5b9e\u4f53",children:"\u5bb9\u5668\u5b9e\u4f53"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-java",children:"// \u6bcf\u4e2aSegment\u91cc\u9762\u90fd\u6709\u4e00\u4e2a Node<K,V>[] table\n    final Segment<K,V>[] segments;\n"})}),"\n",(0,l.jsx)(e.h4,{id:"segment\u76f8\u5173",children:"segment\u76f8\u5173"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-java",metastring:'title="Segment\u672c\u8eab\u5c31\u662f\u4e00\u628a\u9501\uff0c\u5e76\u4e14\u7ec4\u5408\u4e86table\u5c5e\u6027"',children:"static final class Segment<K,V> extends ReentrantLock implements Serializable {\n//    ...\n    transient volatile HashEntry<K,V>[] table;\n}\n"})}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-java",metastring:'title="\u83b7\u53d6\u9501\u7684\u65b9\u6cd5"',children:"        private HashEntry<K,V> scanAndLockForPut(K key, int hash, V value) {\n            HashEntry<K,V> first = entryForHash(this, hash);\n            HashEntry<K,V> e = first;\n            HashEntry<K,V> node = null;\n            // \u81ea\u9002\u5e94\u7f16\u7a0b\uff0c\u8ba1\u6570\u5c1d\u8bd5\u6b21\u6570\n            int retries = -1; // negative while locating node\n        // \u81ea\u65cb\n            while (!tryLock()) {\n                HashEntry<K,V> f; // to recheck first below\n                if (retries < 0) {\n                    if (e == null) {\n                        if (node == null) // speculatively create node\n                            node = new HashEntry<K,V>(hash, key, value, null);\n                        retries = 0;\n                    }\n                    else if (key.equals(e.key))\n                        retries = 0;\n                    else\n                        e = e.next;\n                }\n                // \u91cd\u8bd5\u5927\u4e8eMAX_SCAN_RETRIES\u5c31\u963b\u585e\n                else if (++retries > MAX_SCAN_RETRIES) {\n                    lock();\n                    break;\n                }\n                else if ((retries & 1) == 0 &&\n        // \u6839\u636ehash\u5f97\u5230\u7684node\u53d8\u4e86\uff0c\u6269\u5bb9\u4e86\uff1f\n                         (f = entryForHash(this, hash)) != first) {\n                    e = first = f; // re-traverse if entry changed\n                    retries = -1;\n                }\n            }\n            return node;\n        }\n"})}),"\n",(0,l.jsx)(e.h4,{id:"put",children:"put"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-java",children:"    public V put(K key, V value) {\n        Segment<K,V> s;\n        if (value == null)\n            throw new NullPointerException();\n        int hash = hash(key);\n        int j = (hash >>> segmentShift) & segmentMask;\n        if ((s = (Segment<K,V>)UNSAFE.getObject          // nonvolatile; recheck\n             (segments, (j << SSHIFT) + SBASE)) == null) //  in ensureSegment\n            s = ensureSegment(j);\n        // \u901a\u8fc7key\u627e\u5230\u6240\u5728\u7684\u6bb5\uff08Segment\uff09\n        return s.put(key, hash, value, false);\n    }\n"})}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-java",children:"        final V put(K key, int hash, V value, boolean onlyIfAbsent) {\n    // \u83b7\u53d6\u9501\uff0c\u7c92\u5ea6\u662f\u4e00\u6bb5\n            HashEntry<K,V> node = tryLock() ? null :\n                scanAndLockForPut(key, hash, value);\n            V oldValue;\n            try {\n                HashEntry<K,V>[] tab = table;\n                int index = (tab.length - 1) & hash;\n                HashEntry<K,V> first = entryAt(tab, index);\n                for (HashEntry<K,V> e = first;;) {\n                    if (e != null) {\n                        K k;\n                        if ((k = e.key) == key ||\n                            (e.hash == hash && key.equals(k))) {\n                            oldValue = e.value;\n                            if (!onlyIfAbsent) {\n                                e.value = value;\n                                ++modCount;\n                            }\n                            break;\n                        }\n                        e = e.next;\n                    }\n                    else {\n                        if (node != null)\n                            node.setNext(first);\n                        else\n                            node = new HashEntry<K,V>(hash, key, value, first);\n                        int c = count + 1;\n                        if (c > threshold && tab.length < MAXIMUM_CAPACITY)\n                            rehash(node);\n                        else\n                            setEntryAt(tab, index, node);\n                        ++modCount;\n                        count = c;\n                        oldValue = null;\n                        break;\n                    }\n                }\n            } finally {\n                unlock();\n            }\n            return oldValue;\n        }\n"})}),"\n",(0,l.jsx)(e.h3,{id:"jdk18",children:"JDK1.8"}),"\n",(0,l.jsx)(e.h4,{id:"\u5bb9\u5668\u5b9e\u4f53-1",children:"\u5bb9\u5668\u5b9e\u4f53"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-java",children:"    transient volatile Node<K,V>[] table;\n"})}),"\n",(0,l.jsx)(e.h4,{id:"put-1",children:"put"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-java",children:"    final V putVal(K key, V value, boolean onlyIfAbsent) {\n//    kv\u90fd\u4e0d\u80fd\u662fnull\n        if (key == null || value == null) throw new NullPointerException();\n        int hash = spread(key.hashCode());\n        int binCount = 0;\n        //\u627ekey\u7684\u4f4d\u7f6e\n        for (Node<K,V>[] tab = table;;) {\n            Node<K,V> f; int n, i, fh;\n            if (tab == null || (n = tab.length) == 0)\n                tab = initTable();\n            // \u6876\u6570\u7ec4\u91cc\u6ca1\u6709\u8fd9\u4e2akey\u5bf9\u5e94\u7684hash\uff0c\u76f4\u63a5\u65b0\u589e\u65b0\u7684\u8282\u70b9\n            else if ((f = tabAt(tab, i = (n - 1) & hash)) == null) {\n                if (casTabAt(tab, i, null,\n                            new Node<K,V>(hash, key, value, null)))\n                    break;                   // no lock when adding to empty bin\n            }\n            // f.hash\u88ab\u7528\u6765\u5b58\u72b6\u6001\u4e86\uff1f   MOVED=-1\n            else if ((fh = f.hash) == MOVED)\n                tab = helpTransfer(tab, f);\n            // \u627e\u5230\u8fd9\u4e2ahash\u5bf9\u5e94\u7684\u8282\u70b9\u4e86\n            else {\n                V oldVal = null;\n                // \u9501node\u8282\u70b9\n                synchronized (f) {\n                    if (tabAt(tab, i) == f) {\n                        if (fh >= 0) {\n                            binCount = 1;\n                            // \u904d\u5386\u94fe\u8868\uff0cwhile\u5faa\u73af\uff0c\u521d\u59cb\u5316\u8282\u70b9e\uff0c\u6bcf\u6b21\u5faa\u73afbinCount+1\n                            for (Node<K,V> e = f;; ++binCount) {\n                                K ek;\n                                if (e.hash == hash &&\n                                    ((ek = e.key) == key ||\n                                    (ek != null && key.equals(ek)))) {\n                                    oldVal = e.val;\n                                    // \u8c03\u7528putIfAbsent\u65f6\uff0c\u4e0d\u66f4\u65b0\uff0c\u56e0\u4e3a\u8fd9\u4e2akey\u627e\u5230\u4e86node\uff0c\u662f\u5b58\u5728\u7684\n                                    if (!onlyIfAbsent)\n                                        e.val = value;\n                                    break;\n                                }\n                                Node<K,V> pred = e;\n                                // \u904d\u5386\u5230\u94fe\u8868\u672b\u5c3e\u8fd8\u6ca1\u627e\u5230\uff0c\u521b\u5efa\u8282\u70b9\u5e76\u6dfb\u52a0\u5230\u5c3e\u90e8\n                                if ((e = e.next) == null) {\n                                    pred.next = new Node<K,V>(hash, key,value, null);\n                                    break;\n                                }\n                            }\n                        }\n                        // \u7ea2\u9ed1\u6811\u6dfb\u52a0key\n                        else if (f instanceof TreeBin) {\n                            Node<K,V> p;\n                            binCount = 2;\n                            if ((p = ((TreeBin<K,V>)f).putTreeVal(hash, key,value)) != null) {\n                                oldVal = p.val;\n                                if (!onlyIfAbsent)\n                                    p.val = value;\n                            }\n                        }\n                    }\n                }\n                if (binCount != 0) {\n                    if (binCount >= TREEIFY_THRESHOLD)\n                        treeifyBin(tab, i);\n                    if (oldVal != null)\n                        return oldVal;\n                    break;\n                }\n            }\n        }\n        addCount(1L, binCount);\n        return null;\n    }\n"})}),"\n",(0,l.jsx)(e.h3,{id:"\u6269\u5bb9",children:"\u6269\u5bb9"}),"\n",(0,l.jsxs)(e.blockquote,{children:["\n",(0,l.jsx)(e.p,{children:"1.8: \u5206\u6bb5\u6269\u5bb9\uff0c\u7528ForwardingNode\u8bb0\u5f55\u65e7\u6876\u7528\u6765get\uff0c\u5e76\u4e14\u5f53\u5176\u4ed6\u7ebf\u7a0b\u9047\u5230\u4e86ForwardingNode\u7684\u65f6\u5019\uff0c\u6839\u636etransferIndex\u627e\u5230\u4e0b\u4e00\u4e2a\u5f85\u6269\u5bb9\u6bb5"}),"\n"]}),"\n",(0,l.jsx)(e.h3,{id:"qa",children:"Q&A"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["1.7\u548c1.8\u7684\u533a\u522b","\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"1.7\u662f\u5206\u6bb5\u9501\uff0c\u7528ReentrantLock\u30021.8\u7684\u9501\u7c92\u5ea6\u662fnode\u8282\u70b9\uff0c\u5e76\u4e14\u963b\u585e\u9501\u7528\u7684\u662fSynchronized\uff0c\u5e76\u4e14\u5728\u6dfb\u52a0\u8282\u70b9\uff0c\u4fee\u6539\u72b6\u6001\u7684\u65f6\u5019\u7528\u4e86cas"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["\u5728\u8c03\u7528put\u4e4b\u540e\uff0c\u5728\u5b9e\u9645\u66ff\u6362node\u7684value\u4e4b\u524d\uff0c\u8c03\u7528get\uff0c\u90a3\u4e0d\u662f\u83b7\u53d6\u5230\u65e7\u503c\u4e86","\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u6709\u53ef\u80fd\uff0c\u4e0d\u63d0\u4f9b\u5f3a\u4e00\u81f4\u6027"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["ConcurrentHashMap\u7684key\u53ef\u4ee5\u662fnull\u5417","\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u4e0d\u53ef\u4ee5"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.h2,{id:"copyonwritearraylist",children:"CopyOnWriteArrayList"}),"\n",(0,l.jsx)(e.p,{children:"\u5bb9\u5668\u5b9e\u4f53:"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-java",children:" private transient volatile Object[] array;\n"})}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u53ea\u5728\u5199\u7684\u65f6\u5019\u52a0\u9501"}),"\n",(0,l.jsx)(e.li,{children:"\u5199\u65f6\u590d\u5236\u7684\u673a\u5236\uff0c\u4fee\u6539\u5171\u4eab\u6570\u636e\u7684\u65f6\u5019\u4f1a\u5148\u590d\u5236\u65e7\u7684\u6570\u7ec4\u518d\u4fee\u6539"}),"\n",(0,l.jsx)(e.li,{children:"\u5199\u5199\u4e4b\u95f4\u963b\u585e"}),"\n",(0,l.jsx)(e.li,{children:"\u6269\u5bb9\uff1a\u6bcf\u6b21add\u7684\u65f6\u5019copy\u65b0\u6570\u7ec4\u5bb9\u91cf+1"}),"\n",(0,l.jsx)(e.li,{children:"\u9002\u5408\u8bfb\u591a\u5199\u5c11\u7684\u573a\u666f"}),"\n"]}),"\n",(0,l.jsx)(e.h2,{id:"countdownlatch",children:"CountDownLatch"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-java",children:'import java.util.concurrent.CountDownLatch;\n\npublic class CountDownLatchExample {\n    public static void main(String[] args) throws InterruptedException {\n        // \u521b\u5efa\u4e00\u4e2a CountDownLatch\uff0c\u521d\u59cb\u8ba1\u6570\u4e3a 3\n        CountDownLatch latch = new CountDownLatch(3);\n\n        // \u521b\u5efa\u4e09\u4e2a\u5de5\u4f5c\u7ebf\u7a0b\n        Thread thread1 = new Thread(new Worker(latch, "Thread 1"));\n        Thread thread2 = new Thread(new Worker(latch, "Thread 2"));\n        Thread thread3 = new Thread(new Worker(latch, "Thread 3"));\n\n        // \u542f\u52a8\u5de5\u4f5c\u7ebf\u7a0b\n        thread1.start();\n        thread2.start();\n        thread3.start();\n\n        // \u7b49\u5f85\u6240\u6709\u5de5\u4f5c\u7ebf\u7a0b\u5b8c\u6210\n        latch.await();\n\n        System.out.println("All workers have finished!");\n    }\n}\n\nclass Worker implements Runnable {\n    private final CountDownLatch latch;\n    private final String name;\n\n    public Worker(CountDownLatch latch, String name) {\n        this.latch = latch;\n        this.name = name;\n    }\n\n    @Override\n    public void run() {\n        System.out.println(name + " is working");\n        latch.countDown();\n    }\n}\n\n'})}),"\n",(0,l.jsx)(e.h2,{id:"longadder",children:"LongAdder"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u7ef4\u62a4\u4e00\u4e2a base \u53d8\u91cf\u5b58\u50a8\u7d2f\u52a0\u503c\u3002"}),"\n",(0,l.jsx)(e.li,{children:"\u5f53\u5e76\u53d1\u8f83\u4f4e\u65f6\uff0c\u6240\u6709\u7d2f\u52a0\u64cd\u4f5c\u76f4\u63a5\u4fee\u6539 base\uff0c\u7c7b\u4f3c\u4e8e AtomicLong\u3002"}),"\n",(0,l.jsx)(e.li,{children:"\u5f53\u5e76\u53d1\u8f83\u9ad8\u65f6\uff0c\u4f1a \u81ea\u52a8\u6269\u5c55\u4e00\u4e2a\u6570\u7ec4\uff08cells \u6570\u7ec4\uff09\uff0c\u5e76\u628a\u4e0d\u540c\u7ebf\u7a0b\u7684\u503c\u5206\u6563\u5230\u4e0d\u540c\u7684 Cell \u91cc\uff0c\u51cf\u5c11 CAS \u7ade\u4e89\u3002"}),"\n",(0,l.jsx)(e.li,{children:"\u8bfb\u53d6\u65f6\uff0c\u5c06 base \u548c cells \u6570\u7ec4\u4e2d\u6240\u6709\u503c\u6c42\u548c\uff0c\u5f97\u5230\u6700\u7ec8\u503c\u3002"}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-java",children:'import java.util.concurrent.*;\nimport java.util.concurrent.atomic.LongAdder;\n\npublic class LongAdderConcurrencyTest {\n    private static final int THREAD_COUNT = 1000;\n    private static LongAdder counter = new LongAdder();\n\n    public static void main(String[] args) throws InterruptedException {\n        ExecutorService executor = Executors.newFixedThreadPool(THREAD_COUNT);\n\n        for (int i = 0; i < THREAD_COUNT; i++) {\n            executor.submit(() -> counter.increment());\n        }\n\n        executor.shutdown();\n        executor.awaitTermination(1, TimeUnit.MINUTES);\n\n        System.out.println("\u6700\u7ec8\u8ba1\u6570\u503c\uff1a" + counter.sum());\n    }\n}\n\n'})})]})}function h(n={}){const{wrapper:e}={...(0,i.R)(),...n.components};return e?(0,l.jsx)(e,{...n,children:(0,l.jsx)(d,{...n})}):d(n)}},28453:(n,e,a)=>{a.d(e,{R:()=>r,x:()=>s});var t=a(96540);const l={},i=t.createContext(l);function r(n){const e=t.useContext(i);return t.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function s(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(l):n.components||l:r(n.components),t.createElement(i.Provider,{value:e},n.children)}}}]);