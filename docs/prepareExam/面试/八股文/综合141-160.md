### 141. ä»€ä¹ˆæ˜¯ AOPï¼Ÿ
<details>
<summary>å±•å¼€ <span class="badge badge--info">ä¸­ç­‰</span> <span class="badge badge--primary">VIP</span> <span class="badge badge--secondary">åç«¯</span> <span class="badge badge--secondary">Spring</span></summary>

**AOPå®šä¹‰ï¼š**
AOPï¼ˆAspect-Oriented Programmingï¼‰é¢å‘åˆ‡é¢ç¼–ç¨‹ï¼Œæ˜¯ä¸€ç§ç¼–ç¨‹èŒƒå¼ï¼Œé€šè¿‡é¢„ç¼–è¯‘æ–¹å¼å’Œè¿è¡ŒæœŸåŠ¨æ€ä»£ç†å®ç°ç¨‹åºåŠŸèƒ½çš„ç»Ÿä¸€ç»´æŠ¤ã€‚

**æ ¸å¿ƒæ¦‚å¿µï¼š**

**1. åˆ‡é¢ï¼ˆAspectï¼‰**
- æ¨ªåˆ‡å…³æ³¨ç‚¹çš„æ¨¡å—åŒ–
- åŒ…å«é€šçŸ¥å’Œåˆ‡ç‚¹çš„å®šä¹‰

**2. è¿æ¥ç‚¹ï¼ˆJoin Pointï¼‰**
- ç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­èƒ½å¤Ÿåº”ç”¨é€šçŸ¥çš„æ‰€æœ‰ç‚¹
- Spring AOPä¸­åªæ”¯æŒæ–¹æ³•æ‰§è¡Œè¿æ¥ç‚¹

**3. åˆ‡ç‚¹ï¼ˆPointcutï¼‰**
- åŒ¹é…è¿æ¥ç‚¹çš„æ–­è¨€
- å®šä¹‰åœ¨å“ªäº›è¿æ¥ç‚¹ä¸Šåº”ç”¨é€šçŸ¥

**4. é€šçŸ¥ï¼ˆAdviceï¼‰**
- åœ¨ç‰¹å®šè¿æ¥ç‚¹æ‰§è¡Œçš„ä»£ç 
- äº”ç§ç±»å‹ï¼šå‰ç½®ã€åç½®ã€è¿”å›ã€å¼‚å¸¸ã€ç¯ç»•

**5. ç›®æ ‡å¯¹è±¡ï¼ˆTarget Objectï¼‰**
- è¢«ä¸€ä¸ªæˆ–å¤šä¸ªåˆ‡é¢æ‰€é€šçŸ¥çš„å¯¹è±¡

**6. ç»‡å…¥ï¼ˆWeavingï¼‰**
- å°†åˆ‡é¢ä¸ç›®æ ‡å¯¹è±¡é“¾æ¥ï¼Œåˆ›å»ºä»£ç†å¯¹è±¡çš„è¿‡ç¨‹

**Spring AOPå®ç°ï¼š**

**æ³¨è§£æ–¹å¼ï¼š**
```java
@Aspect
@Component
public class LoggingAspect {
    
    // åˆ‡ç‚¹å®šä¹‰
    @Pointcut("execution(* com.example.service.*.*(..))")
    public void serviceLayer() {}
    
    // å‰ç½®é€šçŸ¥
    @Before("serviceLayer()")
    public void logBefore(JoinPoint joinPoint) {
        log.info("Method {} called with args: {}", 
                joinPoint.getSignature().getName(), 
                Arrays.toString(joinPoint.getArgs()));
    }
    
    // åç½®é€šçŸ¥
    @After("serviceLayer()")
    public void logAfter(JoinPoint joinPoint) {
        log.info("Method {} execution completed", 
                joinPoint.getSignature().getName());
    }
    
    // è¿”å›é€šçŸ¥
    @AfterReturning(pointcut = "serviceLayer()", returning = "result")
    public void logAfterReturning(JoinPoint joinPoint, Object result) {
        log.info("Method {} returned: {}", 
                joinPoint.getSignature().getName(), result);
    }
    
    // å¼‚å¸¸é€šçŸ¥
    @AfterThrowing(pointcut = "serviceLayer()", throwing = "ex")
    public void logAfterThrowing(JoinPoint joinPoint, Exception ex) {
        log.error("Method {} threw exception: {}", 
                joinPoint.getSignature().getName(), ex.getMessage());
    }
    
    // ç¯ç»•é€šçŸ¥
    @Around("serviceLayer()")
    public Object logAround(ProceedingJoinPoint joinPoint) throws Throwable {
        long startTime = System.currentTimeMillis();
        try {
            Object result = joinPoint.proceed();
            long endTime = System.currentTimeMillis();
            log.info("Method {} executed in {} ms", 
                    joinPoint.getSignature().getName(), 
                    endTime - startTime);
            return result;
        } catch (Exception e) {
            log.error("Method {} execution failed", 
                    joinPoint.getSignature().getName(), e);
            throw e;
        }
    }
}
```

**åˆ‡ç‚¹è¡¨è¾¾å¼ï¼š**
```java
// æ‰§è¡Œæ–¹æ³•åˆ‡ç‚¹
@Pointcut("execution(public * com.example.service.*.*(..))")

// æ³¨è§£åˆ‡ç‚¹
@Pointcut("@annotation(org.springframework.transaction.annotation.Transactional)")

// ç±»å‹åˆ‡ç‚¹
@Pointcut("within(com.example.service.*)")

// Beanåç§°åˆ‡ç‚¹
@Pointcut("bean(*Service)")

// ç»„åˆåˆ‡ç‚¹
@Pointcut("serviceLayer() && @annotation(org.springframework.cache.annotation.Cacheable)")
```

**å®é™…åº”ç”¨åœºæ™¯ï¼š**

**1. æ—¥å¿—è®°å½•**
```java
@Aspect
@Component
public class AuditAspect {
    
    @Around("@annotation(Auditable)")
    public Object auditMethod(ProceedingJoinPoint joinPoint) throws Throwable {
        String methodName = joinPoint.getSignature().getName();
        String className = joinPoint.getTarget().getClass().getSimpleName();
        
        // è®°å½•æ“ä½œæ—¥å¿—
        AuditLog auditLog = AuditLog.builder()
                .operation(className + "." + methodName)
                .startTime(LocalDateTime.now())
                .build();
        
        try {
            Object result = joinPoint.proceed();
            auditLog.setStatus("SUCCESS");
            return result;
        } catch (Exception e) {
            auditLog.setStatus("FAILED");
            auditLog.setErrorMessage(e.getMessage());
            throw e;
        } finally {
            auditLog.setEndTime(LocalDateTime.now());
            auditLogService.save(auditLog);
        }
    }
}
```

**2. æƒé™æ§åˆ¶**
```java
@Aspect
@Component
public class SecurityAspect {
    
    @Before("@annotation(requiresRole)")
    public void checkPermission(JoinPoint joinPoint, RequiresRole requiresRole) {
        String[] roles = requiresRole.value();
        String currentUser = SecurityContextHolder.getContext()
                                                  .getAuthentication()
                                                  .getName();
        
        if (!userService.hasAnyRole(currentUser, roles)) {
            throw new AccessDeniedException("Access denied for user: " + currentUser);
        }
    }
}

// ä½¿ç”¨ç¤ºä¾‹
@Service
public class UserService {
    
    @RequiresRole({"ADMIN", "USER_MANAGER"})
    public void deleteUser(Long userId) {
        // åˆ é™¤ç”¨æˆ·é€»è¾‘
    }
}
```

**3. ç¼“å­˜ç®¡ç†**
```java
@Aspect
@Component
public class CacheAspect {
    
    @Around("@annotation(cacheable)")
    public Object cache(ProceedingJoinPoint joinPoint, Cacheable cacheable) throws Throwable {
        String key = generateCacheKey(joinPoint, cacheable.key());
        
        // å°è¯•ä»ç¼“å­˜è·å–
        Object cached = redisTemplate.opsForValue().get(key);
        if (cached != null) {
            return cached;
        }
        
        // æ‰§è¡Œæ–¹æ³•å¹¶ç¼“å­˜ç»“æœ
        Object result = joinPoint.proceed();
        redisTemplate.opsForValue().set(key, result, 
                Duration.ofSeconds(cacheable.expire()));
        
        return result;
    }
}
```

**AOPä¼˜åŠ¿ï¼š**
- å‡å°‘ä»£ç é‡å¤
- æé«˜æ¨¡å—åŒ–ç¨‹åº¦
- æ˜“äºç»´æŠ¤å’Œæ‰©å±•
- å…³æ³¨ç‚¹åˆ†ç¦»

</details>

### 142. ä»€ä¹ˆæ˜¯æœåŠ¡é™çº§ï¼Ÿ
<details>
<summary>å±•å¼€ <span class="badge badge--info">ä¸­ç­‰</span> <span class="badge badge--primary">VIP</span> <span class="badge badge--secondary">Spring Cloud</span> <span class="badge badge--secondary">å¾®æœåŠ¡</span> <span class="badge badge--secondary">åç«¯</span> <span class="badge badge--secondary">æœåŠ¡é™çº§</span></summary>

**æœåŠ¡é™çº§å®šä¹‰ï¼š**
æœåŠ¡é™çº§æ˜¯æŒ‡åœ¨ç³»ç»Ÿå‹åŠ›å‰§å¢æˆ–éƒ¨åˆ†æœåŠ¡ä¸å¯ç”¨æ—¶ï¼Œä¸»åŠ¨å…³é—­éƒ¨åˆ†éæ ¸å¿ƒåŠŸèƒ½æˆ–è¿”å›ç®€åŒ–ç»“æœï¼Œä»¥ä¿è¯æ ¸å¿ƒåŠŸèƒ½æ­£å¸¸è¿è¡Œçš„ä¸€ç§ä¿æŠ¤æœºåˆ¶ã€‚

**é™çº§ç­–ç•¥ï¼š**

**1. åŠŸèƒ½é™çº§**
- å…³é—­éæ ¸å¿ƒåŠŸèƒ½
- ç®€åŒ–ä¸šåŠ¡é€»è¾‘
- è¿”å›é»˜è®¤å€¼æˆ–ç¼“å­˜æ•°æ®

**2. æ€§èƒ½é™çº§**
- é™ä½æ•°æ®ç²¾åº¦
- å‡å°‘æŸ¥è¯¢èŒƒå›´
- ç®€åŒ–è®¡ç®—é€»è¾‘

**3. å®¹é‡é™çº§**
- é™åˆ¶å¹¶å‘è¯·æ±‚æ•°
- ä¸¢å¼ƒéƒ¨åˆ†è¯·æ±‚
- å»¶è¿Ÿå¤„ç†éç´§æ€¥ä»»åŠ¡

**å®ç°æ–¹å¼ï¼š**

**1. Hystrixå®ç°**
```java
@Component
public class UserService {
    
    @HystrixCommand(
        fallbackMethod = "getUserFallback",
        commandProperties = {
            @HystrixProperty(name = "execution.isolation.thread.timeoutInMilliseconds", value = "3000"),
            @HystrixProperty(name = "circuitBreaker.requestVolumeThreshold", value = "10"),
            @HystrixProperty(name = "circuitBreaker.errorThresholdPercentage", value = "50")
        }
    )
    public User getUser(Long userId) {
        // è°ƒç”¨è¿œç¨‹æœåŠ¡
        return userClient.getUser(userId);
    }
    
    // é™çº§æ–¹æ³•
    public User getUserFallback(Long userId) {
        return User.builder()
                .id(userId)
                .name("é»˜è®¤ç”¨æˆ·")
                .email("default@example.com")
                .build();
    }
    
    // é™çº§åŸå› 
    public User getUserFallback(Long userId, Throwable ex) {
        log.error("Get user failed, fallback triggered", ex);
        return getUserFallback(userId);
    }
}
```

**2. Sentinelå®ç°**
```java
@Service
public class OrderService {
    
    @SentinelResource(
        value = "getOrder",
        fallback = "getOrderFallback",
        blockHandler = "getOrderBlocked"
    )
    public Order getOrder(Long orderId) {
        return orderClient.getOrder(orderId);
    }
    
    // é™çº§æ–¹æ³•ï¼ˆå¼‚å¸¸é™çº§ï¼‰
    public Order getOrderFallback(Long orderId, Throwable ex) {
        log.warn("Get order fallback triggered for orderId: {}", orderId, ex);
        return Order.builder()
                .id(orderId)
                .status("UNKNOWN")
                .build();
    }
    
    // é™æµé™çº§
    public Order getOrderBlocked(Long orderId, BlockException ex) {
        log.warn("Get order blocked for orderId: {}", orderId);
        return Order.builder()
                .id(orderId)
                .status("BUSY")
                .message("ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•")
                .build();
    }
}
```

**3. è‡ªå®šä¹‰é™çº§å®ç°**
```java
@Component
public class DegradationManager {
    
    private final Map<String, Boolean> degradationFlags = new ConcurrentHashMap<>();
    private final RedisTemplate<String, Object> redisTemplate;
    
    // æ£€æŸ¥æ˜¯å¦éœ€è¦é™çº§
    public boolean shouldDegrade(String service) {
        // æœ¬åœ°ç¼“å­˜æ£€æŸ¥
        Boolean localFlag = degradationFlags.get(service);
        if (localFlag != null) {
            return localFlag;
        }
        
        // Redisé…ç½®æ£€æŸ¥
        Boolean redisFlag = (Boolean) redisTemplate.opsForValue()
                .get("degradation:" + service);
        
        if (redisFlag != null) {
            degradationFlags.put(service, redisFlag);
            return redisFlag;
        }
        
        return false;
    }
    
    // åŠ¨æ€è®¾ç½®é™çº§çŠ¶æ€
    public void setDegradation(String service, boolean degrade) {
        degradationFlags.put(service, degrade);
        redisTemplate.opsForValue().set("degradation:" + service, degrade);
    }
}

@Service
public class ProductService {
    
    @Autowired
    private DegradationManager degradationManager;
    
    public ProductDetails getProductDetails(Long productId) {
        if (degradationManager.shouldDegrade("product-detail")) {
            // é™çº§ï¼šè¿”å›åŸºæœ¬ä¿¡æ¯
            return getBasicProductInfo(productId);
        }
        
        // æ­£å¸¸ï¼šè¿”å›å®Œæ•´ä¿¡æ¯
        return getFullProductDetails(productId);
    }
    
    private ProductDetails getBasicProductInfo(Long productId) {
        // ä»ç¼“å­˜æˆ–æ•°æ®åº“è·å–åŸºæœ¬ä¿¡æ¯
        Product product = productRepository.findById(productId);
        return ProductDetails.builder()
                .id(product.getId())
                .name(product.getName())
                .price(product.getPrice())
                .build();
    }
    
    private ProductDetails getFullProductDetails(Long productId) {
        // è·å–å®Œæ•´ä¿¡æ¯ï¼ˆå¯èƒ½è°ƒç”¨å¤šä¸ªæœåŠ¡ï¼‰
        Product product = productRepository.findById(productId);
        List<Review> reviews = reviewService.getReviews(productId);
        List<Recommendation> recommendations = recommendationService.getRecommendations(productId);
        
        return ProductDetails.builder()
                .id(product.getId())
                .name(product.getName())
                .price(product.getPrice())
                .description(product.getDescription())
                .reviews(reviews)
                .recommendations(recommendations)
                .build();
    }
}
```

**é™çº§çº§åˆ«ï¼š**

**1. é¡µé¢é™çº§**
```java
@Controller
public class HomeController {
    
    @GetMapping("/")
    public String home(Model model) {
        if (degradationManager.shouldDegrade("homepage")) {
            // è¿”å›ç®€åŒ–é¡µé¢
            return "home-simple";
        }
        
        // è¿”å›å®Œæ•´é¡µé¢
        loadRecommendations(model);
        loadPersonalizedContent(model);
        return "home-full";
    }
}
```

**2. æ¥å£é™çº§**
```java
@RestController
public class ApiController {
    
    @GetMapping("/api/search")
    public SearchResult search(@RequestParam String keyword) {
        if (degradationManager.shouldDegrade("search")) {
            // é™çº§ï¼šè¿”å›ç¼“å­˜ç»“æœ
            return getCachedSearchResult(keyword);
        }
        
        // æ­£å¸¸ï¼šå®æ—¶æœç´¢
        return searchService.search(keyword);
    }
}
```

**3. æ•°æ®é™çº§**
```java
@Service
public class ReportService {
    
    public Report generateReport(String type, Date startDate, Date endDate) {
        if (degradationManager.shouldDegrade("report")) {
            // é™çº§ï¼šå‡å°‘æ•°æ®ç²¾åº¦
            return generateSimplifiedReport(type, startDate, endDate);
        }
        
        return generateDetailedReport(type, startDate, endDate);
    }
    
    private Report generateSimplifiedReport(String type, Date startDate, Date endDate) {
        // æŒ‰å¤©èšåˆè€Œä¸æ˜¯æŒ‰å°æ—¶
        return reportRepository.findDailyReport(type, startDate, endDate);
    }
}
```

**é™çº§ç›‘æ§ï¼š**
```java
@Component
public class DegradationMonitor {
    
    @EventListener
    public void onDegradationTriggered(DegradationEvent event) {
        // è®°å½•é™çº§äº‹ä»¶
        log.warn("Degradation triggered for service: {}, reason: {}", 
                event.getService(), event.getReason());
        
        // å‘é€å‘Šè­¦
        alertService.sendAlert("Service degradation", event);
        
        // è®°å½•æŒ‡æ ‡
        meterRegistry.counter("degradation.triggered", 
                "service", event.getService())
                .increment();
    }
    
    @Scheduled(fixedRate = 30000)
    public void checkSystemHealth() {
        double cpuUsage = systemMetrics.getCpuUsage();
        double memoryUsage = systemMetrics.getMemoryUsage();
        
        if (cpuUsage > 80 || memoryUsage > 85) {
            // è‡ªåŠ¨è§¦å‘é™çº§
            degradationManager.setDegradation("non-essential", true);
        } else if (cpuUsage < 60 && memoryUsage < 70) {
            // æ¢å¤æœåŠ¡
            degradationManager.setDegradation("non-essential", false);
        }
    }
}
```

**æœ€ä½³å®è·µï¼š**
- æ˜ç¡®æ ¸å¿ƒå’Œéæ ¸å¿ƒåŠŸèƒ½
- è®¾è®¡ä¼˜é›…çš„é™çº§ç­–ç•¥
- å»ºç«‹è‡ªåŠ¨åŒ–é™çº§æœºåˆ¶
- ç›‘æ§é™çº§æ•ˆæœ
- åŠæ—¶æ¢å¤æœåŠ¡

</details>

### 143. Synchronized å’Œ ReentrantLock æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ
<details>
<summary>å±•å¼€ <span class="badge badge--info">ä¸­ç­‰</span> <span class="badge badge--secondary">Javaå¹¶å‘</span> <span class="badge badge--secondary">Java</span></summary>

**åŸºæœ¬å¯¹æ¯”ï¼š**

| ç‰¹æ€§ | synchronized | ReentrantLock |
|------|-------------|---------------|
| é”ç±»å‹ | å†…ç½®é”ï¼ˆç›‘è§†å™¨é”ï¼‰ | æ˜¾å¼é” |
| ä½¿ç”¨æ–¹å¼ | å…³é”®å­— | APIè°ƒç”¨ |
| é‡Šæ”¾æ–¹å¼ | è‡ªåŠ¨é‡Šæ”¾ | æ‰‹åŠ¨é‡Šæ”¾ |
| å¯ä¸­æ–­æ€§ | ä¸å¯ä¸­æ–­ | å¯ä¸­æ–­ |
| è¶…æ—¶è·å– | ä¸æ”¯æŒ | æ”¯æŒ |
| å…¬å¹³æ€§ | éå…¬å¹³ | å¯é€‰å…¬å¹³/éå…¬å¹³ |
| æ¡ä»¶å˜é‡ | å•ä¸€æ¡ä»¶ï¼ˆwait/notifyï¼‰ | å¤šæ¡ä»¶å˜é‡ |
| æ€§èƒ½ | JVMä¼˜åŒ–ï¼Œè¾ƒå¥½ | ç”¨æˆ·æ€å®ç° |

**ä½¿ç”¨ç¤ºä¾‹å¯¹æ¯”ï¼š**

**synchronizedä½¿ç”¨ï¼š**
```java
public class SynchronizedExample {
    private final Object lock = new Object();
    private int count = 0;
    
    // æ–¹æ³•åŒæ­¥
    public synchronized void increment() {
        count++;
    }
    
    // ä»£ç å—åŒæ­¥
    public void decrement() {
        synchronized (lock) {
            count--;
        }
    }
    
    // é™æ€æ–¹æ³•åŒæ­¥
    public static synchronized void staticMethod() {
        // é”çš„æ˜¯ç±»å¯¹è±¡
    }
    
    public synchronized void waitExample() throws InterruptedException {
        while (condition) {
            wait(); // ç­‰å¾…æ¡ä»¶
        }
        // æ‰§è¡Œé€»è¾‘
        notifyAll(); // å”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹
    }
}
```

**ReentrantLockä½¿ç”¨ï¼š**
```java
public class ReentrantLockExample {
    private final ReentrantLock lock = new ReentrantLock();
    private final Condition condition = lock.newCondition();
    private int count = 0;
    
    // åŸºæœ¬åŠ é”
    public void increment() {
        lock.lock();
        try {
            count++;
        } finally {
            lock.unlock(); // å¿…é¡»åœ¨finallyä¸­é‡Šæ”¾
        }
    }
    
    // å¯ä¸­æ–­é”
    public void interruptibleIncrement() throws InterruptedException {
        lock.lockInterruptibly();
        try {
            count++;
        } finally {
            lock.unlock();
        }
    }
    
    // å°è¯•è·å–é”
    public boolean tryIncrement() {
        if (lock.tryLock()) {
            try {
                count++;
                return true;
            } finally {
                lock.unlock();
            }
        }
        return false;
    }
    
    // è¶…æ—¶è·å–é”
    public boolean timeoutIncrement(long timeout, TimeUnit unit) {
        try {
            if (lock.tryLock(timeout, unit)) {
                try {
                    count++;
                    return true;
                } finally {
                    lock.unlock();
                }
            }
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
        return false;
    }
    
    // æ¡ä»¶å˜é‡ä½¿ç”¨
    public void conditionExample() throws InterruptedException {
        lock.lock();
        try {
            while (someCondition) {
                condition.await(); // ç­‰å¾…æ¡ä»¶
            }
            // æ‰§è¡Œé€»è¾‘
            condition.signalAll(); // å”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹
        } finally {
            lock.unlock();
        }
    }
}
```

**é«˜çº§ç‰¹æ€§å¯¹æ¯”ï¼š**

**1. å…¬å¹³æ€§**
```java
// ReentrantLockæ”¯æŒå…¬å¹³é”
ReentrantLock fairLock = new ReentrantLock(true); // å…¬å¹³é”
ReentrantLock unfairLock = new ReentrantLock(false); // éå…¬å¹³é”

// synchronizedæ€»æ˜¯éå…¬å¹³çš„
public synchronized void method() {
    // éå…¬å¹³é”
}
```

**2. å¤šæ¡ä»¶å˜é‡**
```java
public class MultiConditionExample {
    private final ReentrantLock lock = new ReentrantLock();
    private final Condition notFull = lock.newCondition();
    private final Condition notEmpty = lock.newCondition();
    private final Object[] buffer = new Object[10];
    private int count, putIndex, takeIndex;
    
    public void put(Object x) throws InterruptedException {
        lock.lock();
        try {
            while (count == buffer.length) {
                notFull.await(); // ç­‰å¾…ä¸æ»¡æ¡ä»¶
            }
            buffer[putIndex] = x;
            if (++putIndex == buffer.length) putIndex = 0;
            ++count;
            notEmpty.signal(); // é€šçŸ¥ä¸ç©ºæ¡ä»¶
        } finally {
            lock.unlock();
        }
    }
    
    public Object take() throws InterruptedException {
        lock.lock();
        try {
            while (count == 0) {
                notEmpty.await(); // ç­‰å¾…ä¸ç©ºæ¡ä»¶
            }
            Object x = buffer[takeIndex];
            if (++takeIndex == buffer.length) takeIndex = 0;
            --count;
            notFull.signal(); // é€šçŸ¥ä¸æ»¡æ¡ä»¶
            return x;
        } finally {
            lock.unlock();
        }
    }
}
```

**3. é”çŠ¶æ€æŸ¥è¯¢**
```java
public class LockInfoExample {
    private final ReentrantLock lock = new ReentrantLock();
    
    public void showLockInfo() {
        System.out.println("Hold count: " + lock.getHoldCount());
        System.out.println("Queue length: " + lock.getQueueLength());
        System.out.println("Is fair: " + lock.isFair());
        System.out.println("Is locked: " + lock.isLocked());
        System.out.println("Is held by current thread: " + lock.isHeldByCurrentThread());
    }
}
```

**æ€§èƒ½å¯¹æ¯”ï¼š**

**1. JVMä¼˜åŒ–**
```java
// synchronizedäº«å—JVMå±‚é¢çš„ä¼˜åŒ–
// - åå‘é”ï¼šå¤§å¤šæ•°æƒ…å†µä¸‹é”ä¸å­˜åœ¨ç«äº‰
// - è½»é‡çº§é”ï¼šå°‘é‡ç«äº‰æ—¶ä½¿ç”¨CAS
// - é‡é‡çº§é”ï¼šæ¿€çƒˆç«äº‰æ—¶æ‰å‡çº§
public synchronized void optimizedByJVM() {
    // JVMä¼šæ ¹æ®ç«äº‰æƒ…å†µè‡ªåŠ¨ä¼˜åŒ–
}
```

**2. ç”¨æˆ·æ€å®ç°**
```java
// ReentrantLockæ˜¯Javaå±‚é¢å®ç°
// - åŸºäºAQSï¼ˆAbstractQueuedSynchronizerï¼‰
// - æ›´å¤šåŠŸèƒ½ä½†å¼€é”€ç¨å¤§
public void reentrantLockMethod() {
    lock.lock();
    try {
        // ç”¨æˆ·æ€å®ç°ï¼ŒåŠŸèƒ½æ›´ä¸°å¯Œ
    } finally {
        lock.unlock();
    }
}
```

**é€‰æ‹©å»ºè®®ï¼š**

**ä½¿ç”¨synchronizedçš„åœºæ™¯ï¼š**
- ç®€å•çš„åŒæ­¥éœ€æ±‚
- ä¸éœ€è¦è¶…æ—¶æˆ–ä¸­æ–­
- ä»£ç ç®€æ´æ€§è¦æ±‚é«˜
- JVMè‡ªåŠ¨ä¼˜åŒ–åœºæ™¯

**ä½¿ç”¨ReentrantLockçš„åœºæ™¯ï¼š**
- éœ€è¦å¯ä¸­æ–­çš„é”è·å–
- éœ€è¦è¶…æ—¶çš„é”è·å–
- éœ€è¦å…¬å¹³é”
- éœ€è¦å¤šä¸ªæ¡ä»¶å˜é‡
- éœ€è¦é”çŠ¶æ€æŸ¥è¯¢

**å®é™…åº”ç”¨ç¤ºä¾‹ï¼š**
```java
@Service
public class OrderService {
    private final Map<String, ReentrantLock> orderLocks = new ConcurrentHashMap<>();
    
    // ä½¿ç”¨ReentrantLockå®ç°è®¢å•çº§åˆ«çš„é”
    public void processOrder(String orderId) {
        ReentrantLock orderLock = orderLocks.computeIfAbsent(orderId, k -> new ReentrantLock());
        
        try {
            // å°è¯•è·å–é”ï¼Œæœ€å¤šç­‰å¾…5ç§’
            if (orderLock.tryLock(5, TimeUnit.SECONDS)) {
                try {
                    // å¤„ç†è®¢å•
                    handleOrder(orderId);
                } finally {
                    orderLock.unlock();
                }
            } else {
                throw new OrderProcessingException("Order is being processed by another thread");
            }
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
            throw new OrderProcessingException("Order processing interrupted");
        }
    }
    
    // ä½¿ç”¨synchronizedå®ç°ç®€å•çš„è®¡æ•°
    private final Object countLock = new Object();
    private int processedCount = 0;
    
    public void incrementProcessedCount() {
        synchronized (countLock) {
            processedCount++;
        }
    }
}
```

</details>

### 144. Redis çš„ Lua è„šæœ¬åŠŸèƒ½æ˜¯ä»€ä¹ˆï¼Ÿå¦‚ä½•ä½¿ç”¨ï¼Ÿ
<details>
<summary>å±•å¼€ <span class="badge badge--info">ä¸­ç­‰</span> <span class="badge badge--primary">VIP</span> <span class="badge badge--secondary">åç«¯</span> <span class="badge badge--secondary">Redis</span></summary>

**Luaè„šæœ¬ç®€ä»‹ï¼š**
Redisçš„Luaè„šæœ¬åŠŸèƒ½å…è®¸åœ¨RedisæœåŠ¡å™¨ç«¯æ‰§è¡ŒLuaè„šæœ¬ï¼Œç¡®ä¿å¤šä¸ªRedisæ“ä½œçš„åŸå­æ€§ï¼Œå‡å°‘ç½‘ç»œå¾€è¿”æ¬¡æ•°ï¼Œæé«˜æ€§èƒ½ã€‚

**æ ¸å¿ƒç‰¹æ€§ï¼š**
- **åŸå­æ€§**ï¼šè„šæœ¬æ‰§è¡ŒæœŸé—´ä¸ä¼šè¢«å…¶ä»–å‘½ä»¤æ‰“æ–­
- **æœåŠ¡å™¨ç«¯æ‰§è¡Œ**ï¼šå‡å°‘ç½‘ç»œå¼€é”€
- **å¯å¤ç”¨**ï¼šè„šæœ¬å¯ä»¥è¢«ç¼“å­˜å’Œé‡å¤ä½¿ç”¨
- **çµæ´»æ€§**ï¼šæ”¯æŒå¤æ‚çš„ä¸šåŠ¡é€»è¾‘

**åŸºæœ¬ä½¿ç”¨ï¼š**

**1. EVALå‘½ä»¤**
```redis
# åŸºæœ¬è¯­æ³•
EVAL script numkeys key [key ...] arg [arg ...]

# ç®€å•ç¤ºä¾‹
EVAL "return redis.call('set', KEYS[1], ARGV[1])" 1 mykey myvalue

# å¤æ‚ç¤ºä¾‹ï¼šåŸå­æ€§å¢åŠ å¹¶è·å–å€¼
EVAL "
local current = redis.call('get', KEYS[1])
if current == false then
    current = 0
else
    current = tonumber(current)
end
current = current + tonumber(ARGV[1])
redis.call('set', KEYS[1], current)
return current
" 1 counter 5
```

**2. EVALSHAå‘½ä»¤**
```redis
# åŠ è½½è„šæœ¬è·å–SHA1
SCRIPT LOAD "return redis.call('get', KEYS[1])"
# è¿”å›: "6b1bf486c81ceb7edf3c093f4c48582e38c0e791"

# ä½¿ç”¨SHA1æ‰§è¡Œè„šæœ¬
EVALSHA 6b1bf486c81ceb7edf3c093f4c48582e38c0e791 1 mykey
```

**Javaå®¢æˆ·ç«¯ä½¿ç”¨ï¼š**

**1. Jediså®ç°**
```java
@Component
public class RedisLuaService {
    
    @Autowired
    private JedisPool jedisPool;
    
    // åˆ†å¸ƒå¼é”è„šæœ¬
    private static final String LOCK_SCRIPT = 
        "if redis.call('get', KEYS[1]) == ARGV[1] then " +
        "    return redis.call('del', KEYS[1]) " +
        "else " +
        "    return 0 " +
        "end";
    
    // é™æµè„šæœ¬
    private static final String RATE_LIMIT_SCRIPT = 
        "local key = KEYS[1] " +
        "local limit = tonumber(ARGV[1]) " +
        "local window = tonumber(ARGV[2]) " +
        "local current = redis.call('get', key) " +
        "if current == false then " +
        "    redis.call('setex', key, window, 1) " +
        "    return 1 " +
        "elseif tonumber(current) < limit then " +
        "    return redis.call('incr', key) " +
        "else " +
        "    return 0 " +
        "end";
    
    public boolean releaseLock(String lockKey, String lockValue) {
        try (Jedis jedis = jedisPool.getResource()) {
            Object result = jedis.eval(LOCK_SCRIPT, 
                    Collections.singletonList(lockKey), 
                    Collections.singletonList(lockValue));
            return "1".equals(result.toString());
        }
    }
    
    public boolean isAllowed(String key, int limit, int windowSeconds) {
        try (Jedis jedis = jedisPool.getResource()) {
            Object result = jedis.eval(RATE_LIMIT_SCRIPT,
                    Collections.singletonList(key),
                    Arrays.asList(String.valueOf(limit), String.valueOf(windowSeconds)));
            return !"0".equals(result.toString());
        }
    }
}
```

**2. RedisTemplateå®ç°**
```java
@Service
public class RedisScriptService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    // åŸå­æ€§å¢å‡åº“å­˜è„šæœ¬
    private static final String STOCK_SCRIPT = 
        "local stock = redis.call('get', KEYS[1]) " +
        "if stock == false then " +
        "    return {-1, 'Stock not found'} " +
        "end " +
        "stock = tonumber(stock) " +
        "local quantity = tonumber(ARGV[1]) " +
        "if stock >= quantity then " +
        "    redis.call('decrby', KEYS[1], quantity) " +
        "    return {stock - quantity, 'Success'} " +
        "else " +
        "    return {stock, 'Insufficient stock'} " +
        "end";
    
    // æ‰¹é‡æ“ä½œè„šæœ¬
    private static final String BATCH_SET_SCRIPT = 
        "for i=1,#KEYS do " +
        "    redis.call('set', KEYS[i], ARGV[i]) " +
        "end " +
        "return #KEYS";
    
    public StockResult decreaseStock(String productId, int quantity) {
        DefaultRedisScript<List> script = new DefaultRedisScript<>();
        script.setScriptText(STOCK_SCRIPT);
        script.setResultType(List.class);
        
        List<Object> result = redisTemplate.execute(script, 
                Collections.singletonList(productId), 
                String.valueOf(quantity));
        
        if (result != null && result.size() == 2) {
            return new StockResult(
                Integer.parseInt(result.get(0).toString()),
                result.get(1).toString()
            );
        }
        
        return new StockResult(-1, "Script execution failed");
    }
    
    public int batchSet(Map<String, String> keyValues) {
        DefaultRedisScript<Long> script = new DefaultRedisScript<>();
        script.setScriptText(BATCH_SET_SCRIPT);
        script.setResultType(Long.class);
        
        List<String> keys = new ArrayList<>(keyValues.keySet());
        List<String> values = new ArrayList<>(keyValues.values());
        
        Long result = redisTemplate.execute(script, keys, values.toArray());
        return result != null ? result.intValue() : 0;
    }
}
```

**å®é™…åº”ç”¨åœºæ™¯ï¼š**

**1. åˆ†å¸ƒå¼é”**
```java
@Component
public class DistributedLock {
    
    // è·å–é”è„šæœ¬
    private static final String ACQUIRE_LOCK_SCRIPT = 
        "if redis.call('setnx', KEYS[1], ARGV[1]) == 1 then " +
        "    redis.call('expire', KEYS[1], ARGV[2]) " +
        "    return 1 " +
        "else " +
        "    return 0 " +
        "end";
    
    // é‡Šæ”¾é”è„šæœ¬
    private static final String RELEASE_LOCK_SCRIPT = 
        "if redis.call('get', KEYS[1]) == ARGV[1] then " +
        "    return redis.call('del', KEYS[1]) " +
        "else " +
        "    return 0 " +
        "end";
    
    public boolean acquireLock(String lockKey, String lockValue, int expireSeconds) {
        DefaultRedisScript<Long> script = new DefaultRedisScript<>();
        script.setScriptText(ACQUIRE_LOCK_SCRIPT);
        script.setResultType(Long.class);
        
        Long result = redisTemplate.execute(script,
                Collections.singletonList(lockKey),
                lockValue, String.valueOf(expireSeconds));
        
        return Long.valueOf(1L).equals(result);
    }
    
    public boolean releaseLock(String lockKey, String lockValue) {
        DefaultRedisScript<Long> script = new DefaultRedisScript<>();
        script.setScriptText(RELEASE_LOCK_SCRIPT);
        script.setResultType(Long.class);
        
        Long result = redisTemplate.execute(script,
                Collections.singletonList(lockKey),
                lockValue);
        
        return Long.valueOf(1L).equals(result);
    }
}
```

**2. æ»‘åŠ¨çª—å£é™æµ**
```java
@Component
public class SlidingWindowRateLimit {
    
    private static final String SLIDING_WINDOW_SCRIPT = 
        "local key = KEYS[1] " +
        "local window = tonumber(ARGV[1]) " +
        "local limit = tonumber(ARGV[2]) " +
        "local now = tonumber(ARGV[3]) " +
        
        "-- æ¸…ç†è¿‡æœŸæ•°æ® " +
        "redis.call('zremrangebyscore', key, 0, now - window * 1000) " +
        
        "-- è·å–å½“å‰çª—å£å†…çš„è¯·æ±‚æ•° " +
        "local current = redis.call('zcard', key) " +
        
        "if current < limit then " +
        "    -- æ·»åŠ å½“å‰è¯·æ±‚ " +
        "    redis.call('zadd', key, now, now) " +
        "    redis.call('expire', key, window) " +
        "    return {1, limit - current - 1} " +
        "else " +
        "    return {0, 0} " +
        "end";
    
    public RateLimitResult checkLimit(String key, int windowSeconds, int limit) {
        DefaultRedisScript<List> script = new DefaultRedisScript<>();
        script.setScriptText(SLIDING_WINDOW_SCRIPT);
        script.setResultType(List.class);
        
        long now = System.currentTimeMillis();
        List<Object> result = redisTemplate.execute(script,
                Collections.singletonList(key),
                String.valueOf(windowSeconds),
                String.valueOf(limit),
                String.valueOf(now));
        
        if (result != null && result.size() == 2) {
            boolean allowed = "1".equals(result.get(0).toString());
            int remaining = Integer.parseInt(result.get(1).toString());
            return new RateLimitResult(allowed, remaining);
        }
        
        return new RateLimitResult(false, 0);
    }
}
```

**3. æ’è¡Œæ¦œæ“ä½œ**
```java
@Component
public class LeaderboardService {
    
    // æ›´æ–°æ’è¡Œæ¦œè„šæœ¬
    private static final String UPDATE_LEADERBOARD_SCRIPT = 
        "local key = KEYS[1] " +
        "local member = ARGV[1] " +
        "local score = tonumber(ARGV[2]) " +
        "local maxSize = tonumber(ARGV[3]) " +
        
        "-- æ·»åŠ æˆ–æ›´æ–°æˆå‘˜åˆ†æ•° " +
        "redis.call('zadd', key, score, member) " +
        
        "-- è·å–æ’è¡Œæ¦œå¤§å° " +
        "local size = redis.call('zcard', key) " +
        
        "-- å¦‚æœè¶…è¿‡æœ€å¤§å¤§å°ï¼Œç§»é™¤æœ€ä½åˆ†æ•°çš„æˆå‘˜ " +
        "if size > maxSize then " +
        "    redis.call('zremrangebyrank', key, 0, size - maxSize - 1) " +
        "end " +
        
        "-- è¿”å›æˆå‘˜å½“å‰æ’åï¼ˆä»1å¼€å§‹ï¼‰ " +
        "return redis.call('zrevrank', key, member) + 1";
    
    public int updateScore(String leaderboard, String member, double score, int maxSize) {
        DefaultRedisScript<Long> script = new DefaultRedisScript<>();
        script.setScriptText(UPDATE_LEADERBOARD_SCRIPT);
        script.setResultType(Long.class);
        
        Long rank = redisTemplate.execute(script,
                Collections.singletonList(leaderboard),
                member, String.valueOf(score), String.valueOf(maxSize));
        
        return rank != null ? rank.intValue() : -1;
    }
}
```

**è„šæœ¬ç®¡ç†ï¼š**
```java
@Component
public class ScriptManager {
    
    private final Map<String, String> scriptShas = new ConcurrentHashMap<>();
    
    @PostConstruct
    public void loadScripts() {
        // é¢„åŠ è½½è„šæœ¬
        loadScript("rate_limit", RATE_LIMIT_SCRIPT);
        loadScript("distributed_lock", LOCK_SCRIPT);
    }
    
    private void loadScript(String name, String script) {
        try (Jedis jedis = jedisPool.getResource()) {
            String sha = jedis.scriptLoad(script);
            scriptShas.put(name, sha);
            log.info("Loaded script '{}' with SHA: {}", name, sha);
        }
    }
    
    public Object executeScript(String scriptName, List<String> keys, List<String> args) {
        String sha = scriptShas.get(scriptName);
        if (sha == null) {
            throw new IllegalArgumentException("Script not found: " + scriptName);
        }
        
        try (Jedis jedis = jedisPool.getResource()) {
            return jedis.evalsha(sha, keys, args);
        }
    }
}
```

**æœ€ä½³å®è·µï¼š**
- é¢„åŠ è½½å¸¸ç”¨è„šæœ¬æé«˜æ€§èƒ½
- åˆç†ä½¿ç”¨KEYSå’ŒARGVå‚æ•°
- æ³¨æ„è„šæœ¬çš„åŸå­æ€§ç‰¹æ€§
- é¿å…åœ¨è„šæœ¬ä¸­æ‰§è¡Œè€—æ—¶æ“ä½œ
- å¤„ç†è„šæœ¬æ‰§è¡Œå¼‚å¸¸æƒ…å†µ

</details>

### 145. HTTP 2.0 å’Œ 3.0 æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ
<details>
<summary>å±•å¼€ <span class="badge badge--info">ä¸­ç­‰</span> <span class="badge badge--primary">VIP</span> <span class="badge badge--secondary">ç½‘ç»œ</span></summary>

**ä¸»è¦åŒºåˆ«å¯¹æ¯”ï¼š**

| ç‰¹æ€§ | HTTP/2.0 | HTTP/3.0 |
|------|----------|----------|
| ä¼ è¾“åè®® | TCP | QUIC (UDP) |
| è¿æ¥å»ºç«‹ | TCPæ¡æ‰‹ + TLSæ¡æ‰‹ | QUICæ¡æ‰‹ï¼ˆåˆå¹¶ï¼‰ |
| é˜Ÿå¤´é˜»å¡ | åº”ç”¨å±‚è§£å†³ï¼Œä¼ è¾“å±‚ä»å­˜åœ¨ | å®Œå…¨è§£å†³ |
| è¿æ¥è¿ç§» | ä¸æ”¯æŒ | æ”¯æŒ |
| 0-RTT | TLS 1.3æ”¯æŒ | åŸç”Ÿæ”¯æŒ |
| æ‹¥å¡æ§åˆ¶ | TCPå†…æ ¸å®ç° | ç”¨æˆ·ç©ºé—´å®ç° |

**HTTP/2.0ç‰¹æ€§å›é¡¾ï¼š**

**1. å¤šè·¯å¤ç”¨**
```javascript
// HTTP/2åœ¨å•ä¸ªTCPè¿æ¥ä¸Šå¤šè·¯å¤ç”¨
// ä½†TCPå±‚é¢ä»å¯èƒ½æœ‰é˜Ÿå¤´é˜»å¡
è¿æ¥: TCP Connection
â”œâ”€â”€ Stream 1: GET /api/users
â”œâ”€â”€ Stream 3: GET /api/orders  
â”œâ”€â”€ Stream 5: POST /api/products
â””â”€â”€ Stream 7: GET /api/stats
```

**2. å¤´éƒ¨å‹ç¼©ï¼ˆHPACKï¼‰**
```http
# HTTP/2 HPACKå‹ç¼©
:method: GET
:path: /api/users
:authority: api.example.com
# é‡å¤å¤´éƒ¨ä½¿ç”¨ç´¢å¼•å¼•ç”¨
```

**HTTP/3.0é©æ–°ç‰¹æ€§ï¼š**

**1. QUICåè®®åŸºç¡€**
```
HTTP/3 over QUIC over UDP

åº”ç”¨å±‚:    HTTP/3
ä¼ è¾“å±‚:    QUIC
ç½‘ç»œå±‚:    UDP
```

**2. è¿æ¥å»ºç«‹ä¼˜åŒ–**
```
# HTTP/2 (TCP + TLS)
å®¢æˆ·ç«¯ -> æœåŠ¡å™¨: SYN
æœåŠ¡å™¨ -> å®¢æˆ·ç«¯: SYN-ACK  
å®¢æˆ·ç«¯ -> æœåŠ¡å™¨: ACK
å®¢æˆ·ç«¯ -> æœåŠ¡å™¨: TLS Client Hello
æœåŠ¡å™¨ -> å®¢æˆ·ç«¯: TLS Server Hello + Certificate
... (æ›´å¤šTLSæ¡æ‰‹)
æ€»è®¡: 2-3 RTT

# HTTP/3 (QUIC)
å®¢æˆ·ç«¯ -> æœåŠ¡å™¨: QUIC Initial Packet (åŒ…å«åŠ å¯†æ¡æ‰‹)
æœåŠ¡å™¨ -> å®¢æˆ·ç«¯: QUIC Response
å®¢æˆ·ç«¯å¯ç«‹å³å‘é€åº”ç”¨æ•°æ®
æ€»è®¡: 1 RTT (0-RTT é‡è¿)
```

**3. çœŸæ­£è§£å†³é˜Ÿå¤´é˜»å¡**
```javascript
// HTTP/2: TCPå±‚é¢ä»æœ‰é˜Ÿå¤´é˜»å¡
TCPä¸¢åŒ…å½±å“æ‰€æœ‰Stream âŒ

// HTTP/3: ç‹¬ç«‹çš„Stream
Stream 1: æ­£å¸¸ä¼ è¾“ âœ…
Stream 2: ä¸¢åŒ…é‡ä¼  ğŸ”„  
Stream 3: æ­£å¸¸ä¼ è¾“ âœ…  
Stream 4: æ­£å¸¸ä¼ è¾“ âœ…
// Streamé—´ç›¸äº’ç‹¬ç«‹
```

**å®é™…éƒ¨ç½²å·®å¼‚ï¼š**

**HTTP/2é…ç½®ï¼ˆNginxï¼‰ï¼š**
```nginx
server {
    listen 443 ssl http2;
    server_name example.com;
    
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    
    # HTTP/2 push
    location / {
        http2_push /css/style.css;
        http2_push /js/app.js;
    }
}
```

**HTTP/3é…ç½®ï¼ˆNginxï¼‰ï¼š**
```nginx
server {
    listen 443 ssl http2;          # HTTP/2 å›é€€
    listen 443 http3 reuseport;    # HTTP/3
    server_name example.com;
    
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
    ssl_protocols TLSv1.3;         # HTTP/3éœ€è¦TLS 1.3
    
    # æ·»åŠ Alt-Svcå¤´å‘ŠçŸ¥å®¢æˆ·ç«¯æ”¯æŒHTTP/3
    add_header Alt-Svc 'h3=":443"; ma=86400';
}
```

**è¿æ¥è¿ç§»ç‰¹æ€§ï¼š**
```javascript
// HTTP/3æ”¯æŒè¿æ¥è¿ç§»
// ç”¨æˆ·ä»WiFiåˆ‡æ¢åˆ°ç§»åŠ¨ç½‘ç»œ
åŸè¿æ¥ID: Connection-ID-12345
æ–°IPåœ°å€: 192.168.1.100 -> 10.0.0.50
è¿æ¥çŠ¶æ€: ä¿æŒä¸å˜ âœ…

// HTTP/2éœ€è¦é‡æ–°å»ºç«‹è¿æ¥
åŸTCPè¿æ¥: WiFi IP + Port
æ–°è¿æ¥: ç§»åŠ¨ç½‘ç»œ IP + Port  
éœ€è¦: é‡æ–°æ¡æ‰‹ âŒ
```

**0-RTTè¿æ¥æ¢å¤ï¼š**
```javascript
// HTTP/3 0-RTTæ¢å¤
å®¢æˆ·ç«¯ç¼“å­˜: æœåŠ¡å™¨é…ç½® + ä¼šè¯ç¥¨æ®
é‡è¿æ—¶: ç«‹å³å‘é€åº”ç”¨æ•°æ®
æœåŠ¡å™¨: ç«‹å³å¤„ç†è¯·æ±‚

// ç¤ºä¾‹æ—¶åº
T0: å®¢æˆ·ç«¯å‘é€0-RTTæ•°æ® + æ¡æ‰‹
T1: æœåŠ¡å™¨å“åº”æ•°æ® + æ¡æ‰‹ç¡®è®¤
// æ— éœ€ç­‰å¾…æ¡æ‰‹å®Œæˆ
```

**æ€§èƒ½ä¼˜åŠ¿å¯¹æ¯”ï¼š**

**å»¶è¿Ÿæ¯”è¾ƒï¼š**
```
é¦–æ¬¡è¿æ¥å»ºç«‹:
HTTP/2: 2-3 RTT
HTTP/3: 1 RTT

é‡è¿:
HTTP/2: 2-3 RTT  
HTTP/3: 0 RTT

å¼±ç½‘ç»œç¯å¢ƒ:
HTTP/2: å—TCPé˜Ÿå¤´é˜»å¡å½±å“ä¸¥é‡
HTTP/3: ç‹¬ç«‹Streamï¼Œå½±å“è¾ƒå°
```

**Javaå®¢æˆ·ç«¯æ”¯æŒï¼š**

**HTTP/2å®¢æˆ·ç«¯ï¼š**
```java
// Java 11+ HttpClient
HttpClient client = HttpClient.newBuilder()
    .version(HttpClient.Version.HTTP_2)
    .build();

HttpRequest request = HttpRequest.newBuilder()
    .uri(URI.create("https://api.example.com/users"))
    .build();

HttpResponse<String> response = client.send(request, 
    HttpResponse.BodyHandlers.ofString());
```

**HTTP/3å®¢æˆ·ç«¯ï¼ˆå®éªŒæ€§ï¼‰ï¼š**
```java
// ä½¿ç”¨æ”¯æŒQUICçš„å®¢æˆ·ç«¯åº“
// ä¾‹å¦‚ï¼šquiche-java, netty-quicç­‰
QuicClient client = QuicClient.newBuilder()
    .serverName("example.com")
    .build();

QuicConnection connection = client.connect()
    .join();

QuicStream stream = connection.createStream()
    .join();

// å‘é€HTTP/3è¯·æ±‚
stream.writeData(httpRequestBytes);
```

**æµè§ˆå™¨æ”¯æŒæ£€æµ‹ï¼š**
```javascript
// æ£€æµ‹HTTP/3æ”¯æŒ
if ('serviceWorker' in navigator) {
    // ç°ä»£æµè§ˆå™¨å¯èƒ½æ”¯æŒHTTP/3
    fetch('/api/test', {
        // æµè§ˆå™¨è‡ªåŠ¨åå•†æœ€ä½³åè®®ç‰ˆæœ¬
    }).then(response => {
        console.log('Protocol:', response.headers.get('alt-svc'));
    });
}

// æ£€æŸ¥è¿æ¥ä¿¡æ¯ï¼ˆChrome DevToolsï¼‰
// Network -> è¿æ¥IDåˆ—å¯ä»¥çœ‹åˆ°h3/h2æ ‡è¯†
```

**éƒ¨ç½²æ³¨æ„äº‹é¡¹ï¼š**

**HTTP/3éƒ¨ç½²æŒ‘æˆ˜ï¼š**
```bash
# 1. é˜²ç«å¢™é…ç½®
# éœ€è¦å¼€æ”¾UDP 443ç«¯å£
iptables -A INPUT -p udp --dport 443 -j ACCEPT

# 2. è´Ÿè½½å‡è¡¡å™¨æ”¯æŒ
# éœ€è¦æ”¯æŒQUICçš„è´Ÿè½½å‡è¡¡å™¨
# å¦‚ï¼šCloudflare, AWS ALBç­‰

# 3. CDNæ”¯æŒ
# éœ€è¦CDNæä¾›å•†æ”¯æŒHTTP/3
# å¦‚ï¼šCloudflare, AWS CloudFrontç­‰
```

**æ¸è¿›å¼å‡çº§ç­–ç•¥ï¼š**
```javascript
// æœåŠ¡ç«¯æ”¯æŒå¤šåè®®
server {
    listen 443 ssl http2;           # HTTP/2
    listen 443 http3 reuseport;     # HTTP/3  
    
    # åè®®åå•†
    add_header Alt-Svc 'h3=":443"; ma=86400, h2=":443"; ma=86400';
}

// å®¢æˆ·ç«¯è‡ªåŠ¨é™çº§
HTTP/3å°è¯• -> HTTP/2å›é€€ -> HTTP/1.1å…œåº•
```

**ç›‘æ§å’Œè°ƒè¯•ï¼š**
```javascript
// ç›‘æ§HTTPç‰ˆæœ¬åˆ†å¸ƒ
const protocolMetrics = {
    'http/1.1': 0,
    'http/2': 0, 
    'http/3': 0
};

// Chrome DevTools
// Networké¢æ¿ -> Protocolåˆ—
// å¯çœ‹åˆ°æ¯ä¸ªè¯·æ±‚ä½¿ç”¨çš„åè®®ç‰ˆæœ¬

// æœåŠ¡å™¨æ—¥å¿—
log_format http3 '$remote_addr - $remote_user [$time_local] '
                '"$request" $status $body_bytes_sent '
                '"$http_referer" "$http_user_agent" '
                'protocol=$server_protocol';
```

**æœªæ¥å‘å±•ï¼š**
- HTTP/3ç”Ÿæ€é€æ­¥æˆç†Ÿ
- QUICåè®®ä¸æ–­ä¼˜åŒ–
- æ›´å¤šæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯æ”¯æŒ
- ç½‘ç»œåŸºç¡€è®¾æ–½é€æ­¥å‡çº§

</details>

### 146. å•ä¾‹æ¨¡å¼æœ‰å“ªå‡ ç§å®ç°ï¼Ÿå¦‚ä½•ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Ÿ
<details>
<summary>å±•å¼€ <span class="badge badge--info">ä¸­ç­‰</span> <span class="badge badge--primary">VIP</span> <span class="badge badge--secondary">è®¾è®¡æ¨¡å¼</span></summary>

**å•ä¾‹æ¨¡å¼å®ç°æ–¹å¼ï¼š**

**1. é¥¿æ±‰å¼ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰**
```java
public class EagerSingleton {
    // ç±»åŠ è½½æ—¶å°±åˆ›å»ºå®ä¾‹
    private static final EagerSingleton INSTANCE = new EagerSingleton();
    
    private EagerSingleton() {
        // ç§æœ‰æ„é€ å‡½æ•°
    }
    
    public static EagerSingleton getInstance() {
        return INSTANCE;
    }
}
```
- **ä¼˜ç‚¹**ï¼šçº¿ç¨‹å®‰å…¨ï¼Œå®ç°ç®€å•
- **ç¼ºç‚¹**ï¼šä¸èƒ½å»¶è¿ŸåŠ è½½ï¼Œå¯èƒ½æµªè´¹å†…å­˜

**2. æ‡’æ±‰å¼ï¼ˆçº¿ç¨‹ä¸å®‰å…¨ï¼‰**
```java
public class LazySingleton {
    private static LazySingleton instance;
    
    private LazySingleton() {}
    
    public static LazySingleton getInstance() {
        if (instance == null) {  // å¤šçº¿ç¨‹é—®é¢˜
            instance = new LazySingleton();
        }
        return instance;
    }
}
```
- **ä¼˜ç‚¹**ï¼šå»¶è¿ŸåŠ è½½
- **ç¼ºç‚¹**ï¼šçº¿ç¨‹ä¸å®‰å…¨

**3. æ‡’æ±‰å¼ï¼ˆåŒæ­¥æ–¹æ³•ï¼Œçº¿ç¨‹å®‰å…¨ï¼‰**
```java
public class SynchronizedLazySingleton {
    private static SynchronizedLazySingleton instance;
    
    private SynchronizedLazySingleton() {}
    
    public static synchronized SynchronizedLazySingleton getInstance() {
        if (instance == null) {
            instance = new SynchronizedLazySingleton();
        }
        return instance;
    }
}
```
- **ä¼˜ç‚¹**ï¼šçº¿ç¨‹å®‰å…¨ï¼Œå»¶è¿ŸåŠ è½½
- **ç¼ºç‚¹**ï¼šæ€§èƒ½å·®ï¼Œæ¯æ¬¡è°ƒç”¨éƒ½è¦åŒæ­¥

**4. åŒé‡æ£€æŸ¥é”å®šï¼ˆDCLï¼‰**
```java
public class DoubleCheckedLockingSingleton {
    // volatileä¿è¯å¯è§æ€§å’Œç¦æ­¢é‡æ’åº
    private static volatile DoubleCheckedLockingSingleton instance;
    
    private DoubleCheckedLockingSingleton() {}
    
    public static DoubleCheckedLockingSingleton getInstance() {
        if (instance == null) {                    // ç¬¬ä¸€æ¬¡æ£€æŸ¥
            synchronized (DoubleCheckedLockingSingleton.class) {
                if (instance == null) {            // ç¬¬äºŒæ¬¡æ£€æŸ¥
                    instance = new DoubleCheckedLockingSingleton();
                }
            }
        }
        return instance;
    }
}
```
- **ä¼˜ç‚¹**ï¼šå»¶è¿ŸåŠ è½½ï¼Œæ€§èƒ½å¥½ï¼Œçº¿ç¨‹å®‰å…¨
- **æ³¨æ„**ï¼šå¿…é¡»ä½¿ç”¨volatileå…³é”®å­—

**5. é™æ€å†…éƒ¨ç±»ï¼ˆæ¨èï¼‰**
```java
public class StaticInnerClassSingleton {
    
    private StaticInnerClassSingleton() {}
    
    // é™æ€å†…éƒ¨ç±»ï¼Œæ‡’åŠ è½½
    private static class SingletonHolder {
        private static final StaticInnerClassSingleton INSTANCE = 
                new StaticInnerClassSingleton();
    }
    
    public static StaticInnerClassSingleton getInstance() {
        return SingletonHolder.INSTANCE;
    }
}
```
- **ä¼˜ç‚¹**ï¼šå»¶è¿ŸåŠ è½½ï¼Œçº¿ç¨‹å®‰å…¨ï¼Œæ€§èƒ½å¥½
- **åŸç†**ï¼šåˆ©ç”¨JVMç±»åŠ è½½æœºåˆ¶ä¿è¯çº¿ç¨‹å®‰å…¨

**6. æšä¸¾å®ç°ï¼ˆæœ€å®‰å…¨ï¼‰**
```java
public enum EnumSingleton {
    INSTANCE;
    
    public void doSomething() {
        System.out.println("Doing something...");
    }
}

// ä½¿ç”¨
EnumSingleton.INSTANCE.doSomething();
```
- **ä¼˜ç‚¹**ï¼šçº¿ç¨‹å®‰å…¨ï¼Œé˜²æ­¢ååºåˆ—åŒ–å’Œåå°„æ”»å‡»
- **ç¼ºç‚¹**ï¼šä¸èƒ½å»¶è¿ŸåŠ è½½

**çº¿ç¨‹å®‰å…¨åˆ†æï¼š**

**DCLä¸­volatileçš„é‡è¦æ€§ï¼š**
```java
// æ²¡æœ‰volatileçš„é—®é¢˜
instance = new Singleton(); // å¯èƒ½é‡æ’åºä¸ºï¼š
// 1. åˆ†é…å†…å­˜ç©ºé—´
// 2. è®¾ç½®instanceæŒ‡å‘å†…å­˜ï¼ˆæ­¤æ—¶å¯¹è±¡è¿˜æœªåˆå§‹åŒ–ï¼‰
// 3. åˆå§‹åŒ–å¯¹è±¡

// å…¶ä»–çº¿ç¨‹å¯èƒ½çœ‹åˆ°æœªå®Œå…¨åˆå§‹åŒ–çš„å¯¹è±¡
```

**ç±»åŠ è½½æœºåˆ¶ä¿è¯çº¿ç¨‹å®‰å…¨ï¼š**
```java
// é™æ€å†…éƒ¨ç±»å®ç°åŸç†
public class Outer {
    static class Inner {
        static final Object INSTANCE = new Object(); // ç±»åŠ è½½æ—¶æ‰§è¡Œ
    }
}
// JVMä¿è¯ç±»åŠ è½½è¿‡ç¨‹çš„çº¿ç¨‹å®‰å…¨æ€§
```

**é˜²æ­¢åå°„æ”»å‡»ï¼š**
```java
public class ReflectionProofSingleton {
    private static volatile ReflectionProofSingleton instance;
    private static boolean created = false;
    
    private ReflectionProofSingleton() {
        synchronized (ReflectionProofSingleton.class) {
            if (created) {
                throw new RuntimeException("Use getInstance() method to create");
            }
            created = true;
        }
    }
    
    public static ReflectionProofSingleton getInstance() {
        if (instance == null) {
            synchronized (ReflectionProofSingleton.class) {
                if (instance == null) {
                    instance = new ReflectionProofSingleton();
                }
            }
        }
        return instance;
    }
}
```

**é˜²æ­¢åºåˆ—åŒ–æ”»å‡»ï¼š**
```java
public class SerializationProofSingleton implements Serializable {
    private static volatile SerializationProofSingleton instance;
    
    private SerializationProofSingleton() {}
    
    public static SerializationProofSingleton getInstance() {
        if (instance == null) {
            synchronized (SerializationProofSingleton.class) {
                if (instance == null) {
                    instance = new SerializationProofSingleton();
                }
            }
        }
        return instance;
    }
    
    // é˜²æ­¢åºåˆ—åŒ–ç ´åå•ä¾‹
    private Object readResolve() {
        return getInstance();
    }
}
```

**æ€§èƒ½æµ‹è¯•ï¼š**
```java
public class SingletonPerformanceTest {
    
    public static void main(String[] args) throws InterruptedException {
        int threadCount = 100;
        int iterations = 1000000;
        
        // æµ‹è¯•ä¸åŒå®ç°çš„æ€§èƒ½
        testPerformance("Eager", EagerSingleton::getInstance, threadCount, iterations);
        testPerformance("DCL", DoubleCheckedLockingSingleton::getInstance, threadCount, iterations);
        testPerformance("Static Inner", StaticInnerClassSingleton::getInstance, threadCount, iterations);
        testPerformance("Synchronized", SynchronizedLazySingleton::getInstance, threadCount, iterations);
    }
    
    private static void testPerformance(String name, Supplier<Object> supplier, 
                                       int threadCount, int iterations) throws InterruptedException {
        CountDownLatch latch = new CountDownLatch(threadCount);
        long startTime = System.nanoTime();
        
        for (int i = 0; i < threadCount; i++) {
            new Thread(() -> {
                for (int j = 0; j < iterations; j++) {
                    supplier.get();
                }
                latch.countDown();
            }).start();
        }
        
        latch.await();
        long endTime = System.nanoTime();
        
        System.out.printf("%s: %.2f ms%n", name, (endTime - startTime) / 1_000_000.0);
    }
}
```

**å®é™…åº”ç”¨ç¤ºä¾‹ï¼š**
```java
// æ•°æ®åº“è¿æ¥æ± å•ä¾‹
public class DatabaseConnectionPool {
    private static volatile DatabaseConnectionPool instance;
    private final DataSource dataSource;
    
    private DatabaseConnectionPool() {
        // åˆå§‹åŒ–è¿æ¥æ± 
        HikariConfig config = new HikariConfig();
        config.setJdbcUrl("jdbc:mysql://localhost:3306/db");
        config.setUsername("user");
        config.setPassword("password");
        config.setMaximumPoolSize(20);
        this.dataSource = new HikariDataSource(config);
    }
    
    public static DatabaseConnectionPool getInstance() {
        if (instance == null) {
            synchronized (DatabaseConnectionPool.class) {
                if (instance == null) {
                    instance = new DatabaseConnectionPool();
                }
            }
        }
        return instance;
    }
    
    public Connection getConnection() throws SQLException {
        return dataSource.getConnection();
    }
}

// é…ç½®ç®¡ç†å•ä¾‹
public class ConfigManager {
    private static class Holder {
        private static final ConfigManager INSTANCE = new ConfigManager();
    }
    
    private final Properties properties;
    
    private ConfigManager() {
        properties = new Properties();
        loadConfiguration();
    }
    
    public static ConfigManager getInstance() {
        return Holder.INSTANCE;
    }
    
    public String getProperty(String key) {
        return properties.getProperty(key);
    }
    
    private void loadConfiguration() {
        // åŠ è½½é…ç½®æ–‡ä»¶
        try (InputStream is = getClass().getResourceAsStream("/application.properties")) {
            properties.load(is);
        } catch (Exception e) {
            throw new RuntimeException("Failed to load configuration", e);
        }
    }
}
```

**é€‰æ‹©å»ºè®®ï¼š**
- **ä¸€èˆ¬æƒ…å†µ**ï¼šé™æ€å†…éƒ¨ç±»å®ç°
- **Springç­‰æ¡†æ¶**ï¼šäº¤ç»™å®¹å™¨ç®¡ç†
- **é˜²æ”»å‡»è¦æ±‚é«˜**ï¼šæšä¸¾å®ç°
- **ç®€å•åœºæ™¯**ï¼šé¥¿æ±‰å¼
- **æ€§èƒ½è¦æ±‚æé«˜**ï¼šDCL + volatile

</details>

### 147. Java çš„ synchronized æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ
<details>
<summary>å±•å¼€ <span class="badge badge--danger">å›°éš¾</span> <span class="badge badge--secondary">Javaå¹¶å‘</span> <span class="badge badge--secondary">Java</span></summary>

**synchronizedå®ç°åŸç†ï¼š**

**1. å­—èŠ‚ç å±‚é¢**
```java
// Javaä»£ç 
public void synchronizedMethod() {
    synchronized (this) {
        // ä¸´ç•ŒåŒºä»£ç 
    }
}

// å¯¹åº”å­—èŠ‚ç 
public void synchronizedMethod();
    Code:
       0: aload_0
       1: dup
       2: astore_1
       3: monitorenter    // è·å–ç›‘è§†å™¨é”
       4: aload_1
       5: monitorexit     // é‡Šæ”¾ç›‘è§†å™¨é”
       6: goto          14
       9: astore_2
      10: aload_1
      11: monitorexit     // å¼‚å¸¸æ—¶ä¹Ÿè¦é‡Šæ”¾é”
      12: aload_2
      13: athrow
      14: return
```

**2. å¯¹è±¡å¤´ç»“æ„**
```
|--------------------------------------------------------|
|                     Object Header                      |
|--------------------------------------------------------|
| Mark Word (64bit) | Class Metadata Address (64bit)    |
|--------------------------------------------------------|

Mark Wordç»“æ„ï¼ˆ64ä½JVMï¼‰ï¼š
|-------------------------------------------------------|--------------------|
|                  25bit          | 31bit | 1bit | 4bit | 1bit | 2bit       |
| unused:25 | identity_hashcode:31 | unused:1 | age:4 | biased_lock:1 | lock:2 |
|-------------------------------------------------------|--------------------|
```

**3. é”çŠ¶æ€æ ‡è¯†**
```java
// Mark Wordä¸­çš„é”çŠ¶æ€ä½
public class LockState {
    public static final int UNLOCKED = 0b01;        // æ— é”
    public static final int BIASED = 0b101;         // åå‘é”
    public static final int LIGHTWEIGHT = 0b00;     // è½»é‡çº§é”
    public static final int HEAVYWEIGHT = 0b10;     // é‡é‡çº§é”
    public static final int GC_MARK = 0b11;         // GCæ ‡è®°
}
```

**é”å‡çº§è¿‡ç¨‹ï¼š**

**1. åå‘é”ï¼ˆBiased Lockingï¼‰**
```java
// å¤§å¤šæ•°æƒ…å†µä¸‹é”ä¸å­˜åœ¨ç«äº‰ï¼Œæ€»æ˜¯ç”±åŒä¸€çº¿ç¨‹å¤šæ¬¡è·å¾—
public class BiasedLockExample {
    private final Object lock = new Object();
    
    public void method() {
        synchronized (lock) {  // ç¬¬ä¸€æ¬¡è·å–ï¼šè®¾ç½®åå‘é”
            // ä¸šåŠ¡é€»è¾‘
        }
        
        synchronized (lock) {  // åç»­è·å–ï¼šç›´æ¥æ‰§è¡Œï¼Œæ— éœ€CAS
            // ä¸šåŠ¡é€»è¾‘
        }
    }
}

// åå‘é”çŠ¶æ€ä¸‹çš„Mark Word
|--------------------------------------------------------------------------|
| thread:54 | epoch:2 | unused:1 | age:4 | biased_lock:1 | lock:2 (101)     |
|--------------------------------------------------------------------------|
```

**2. è½»é‡çº§é”ï¼ˆLightweight Lockingï¼‰**
```java
// å½“æœ‰å…¶ä»–çº¿ç¨‹ç«äº‰æ—¶ï¼Œåå‘é”å‡çº§ä¸ºè½»é‡çº§é”
public class LightweightLockExample {
    private final Object lock = new Object();
    
    public void method1() {
        synchronized (lock) {  // çº¿ç¨‹1è·å–é”
            // CASæ“ä½œå°†Mark Wordå¤åˆ¶åˆ°çº¿ç¨‹æ ˆçš„Lock Record
            // ç„¶åCASå°è¯•å°†Mark Wordæ›´æ–°ä¸ºæŒ‡å‘Lock Recordçš„æŒ‡é’ˆ
        }
    }
    
    public void method2() {
        synchronized (lock) {  // çº¿ç¨‹2ç«äº‰é”
            // è‡ªæ—‹ç­‰å¾…ï¼Œå¦‚æœè‡ªæ—‹å¤±è´¥åˆ™å‡çº§ä¸ºé‡é‡çº§é”
        }
    }
}

// è½»é‡çº§é”çŠ¶æ€ä¸‹çš„Mark Word
|--------------------------------------------------------------------------|
| ptr_to_lock_record:62                                 | lock:2 (00)       |
|--------------------------------------------------------------------------|
```

**3. é‡é‡çº§é”ï¼ˆHeavyweight Lockingï¼‰**
```java
// å½“è½»é‡çº§é”ç«äº‰æ¿€çƒˆæ—¶ï¼Œå‡çº§ä¸ºé‡é‡çº§é”
public class HeavyweightLockExample {
    private final Object lock = new Object();
    
    public void method() {
        synchronized (lock) {  
            // ä½¿ç”¨æ“ä½œç³»ç»Ÿäº’æ–¥é‡ï¼ˆmutexï¼‰
            // çº¿ç¨‹é˜»å¡å’Œå”¤é†’éœ€è¦ä»ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€
        }
    }
}

// é‡é‡çº§é”çŠ¶æ€ä¸‹çš„Mark Word
|--------------------------------------------------------------------------|
| ptr_to_heavyweight_monitor:62                        | lock:2 (10)       |
|--------------------------------------------------------------------------|
```

**Monitorå¯¹è±¡ç»“æ„ï¼š**
```cpp
// HotSpot VMä¸­çš„ObjectMonitorç»“æ„ï¼ˆç®€åŒ–ï¼‰
class ObjectMonitor {
    private:
        volatile markOop _header;        // å¯¹è±¡å¤´ä¿¡æ¯
        void* volatile _owner;           // æŒ‡å‘æŒæœ‰é”çš„çº¿ç¨‹
        volatile jlong _recursions;      // é”çš„é‡å…¥æ¬¡æ•°
        ObjectWaiter* volatile _cxq;     // ç«äº‰é˜Ÿåˆ—
        ObjectWaiter* volatile _EntryList; // ç­‰å¾…é˜Ÿåˆ—
        ObjectWaiter* volatile _WaitSet;   // waité›†åˆ
        volatile jint _waiters;          // ç­‰å¾…çº¿ç¨‹æ•°
        volatile jint _WaitSetLock;      // WaitSeté”
};
```

**é”å‡çº§ç¤ºä¾‹ä»£ç ï¼š**
```java
public class LockEscalationDemo {
    private final Object lock = new Object();
    
    public static void main(String[] args) throws InterruptedException {
        LockEscalationDemo demo = new LockEscalationDemo();
        
        // é˜¶æ®µ1ï¼šåå‘é”
        System.out.println("=== åå‘é”é˜¶æ®µ ===");
        demo.stage1_BiasedLock();
        
        // é˜¶æ®µ2ï¼šè½»é‡çº§é”  
        System.out.println("=== è½»é‡çº§é”é˜¶æ®µ ===");
        demo.stage2_LightweightLock();
        
        // é˜¶æ®µ3ï¼šé‡é‡çº§é”
        System.out.println("=== é‡é‡çº§é”é˜¶æ®µ ===");
        demo.stage3_HeavyweightLock();
    }
    
    // åå‘é”ï¼šå•çº¿ç¨‹é‡å¤è·å–
    private void stage1_BiasedLock() {
        for (int i = 0; i < 5; i++) {
            synchronized (lock) {
                System.out.println("åå‘é”æ‰§è¡Œ: " + i);
            }
        }
    }
    
    // è½»é‡çº§é”ï¼šå°‘é‡ç«äº‰
    private void stage2_LightweightLock() throws InterruptedException {
        CountDownLatch latch = new CountDownLatch(2);
        
        // åˆ›å»ºä¸¤ä¸ªçº¿ç¨‹äº¤æ›¿è·å–é”
        for (int i = 0; i < 2; i++) {
            new Thread(() -> {
                for (int j = 0; j < 3; j++) {
                    synchronized (lock) {
                        System.out.println("è½»é‡çº§é”: " + Thread.currentThread().getName());
                        try {
                            Thread.sleep(10);
                        } catch (InterruptedException e) {
                            Thread.currentThread().interrupt();
                        }
                    }
                }
                latch.countDown();
            }, "Thread-" + i).start();
        }
        
        latch.await();
    }
    
    // é‡é‡çº§é”ï¼šæ¿€çƒˆç«äº‰
    private void stage3_HeavyweightLock() throws InterruptedException {
        CountDownLatch latch = new CountDownLatch(10);
        
        // åˆ›å»º10ä¸ªçº¿ç¨‹æ¿€çƒˆç«äº‰
        for (int i = 0; i < 10; i++) {
            new Thread(() -> {
                for (int j = 0; j < 100; j++) {
                    synchronized (lock) {
                        // æ¨¡æ‹Ÿå·¥ä½œ
                        try {
                            Thread.sleep(1);
                        } catch (InterruptedException e) {
                            Thread.currentThread().interrupt();
                        }
                    }
                }
                latch.countDown();
            }, "HeavyThread-" + i).start();
        }
        
        latch.await();
    }
}
```

**JVMå‚æ•°è°ƒä¼˜ï¼š**
```bash
# ç¦ç”¨åå‘é”
-XX:-UseBiasedLocking

# è®¾ç½®åå‘é”å»¶è¿Ÿå¯åŠ¨æ—¶é—´ï¼ˆé»˜è®¤4000msï¼‰
-XX:BiasedLockingStartupDelay=0

# è®¾ç½®è‡ªæ—‹æ¬¡æ•°ï¼ˆJDK6ä»¥å‰ï¼‰
-XX:PreBlockSpin=10

# å¯ç”¨è‡ªé€‚åº”è‡ªæ—‹
-XX:+UseSpinning

# æ‰“å°é”ç›¸å…³ä¿¡æ¯
-XX:+PrintGCDetails -XX:+PrintConcurrentLocks
```

**é”ä¼˜åŒ–æŠ€æœ¯ï¼š**

**1. é”ç²—åŒ–ï¼ˆLock Coarseningï¼‰**
```java
// ä¼˜åŒ–å‰ï¼šé¢‘ç¹åŠ é”è§£é”
public void inefficient() {
    synchronized (this) { i++; }
    synchronized (this) { j++; }
    synchronized (this) { k++; }
}

// ä¼˜åŒ–åï¼šé”ç²—åŒ–
public void efficient() {
    synchronized (this) { 
        i++; 
        j++; 
        k++; 
    }
}
```

**2. é”æ¶ˆé™¤ï¼ˆLock Eliminationï¼‰**
```java
// JVMèƒ½æ£€æµ‹åˆ°ä¸å¯èƒ½æœ‰ç«äº‰çš„é”å¹¶æ¶ˆé™¤
public void lockElimination() {
    StringBuffer sb = new StringBuffer();  // å±€éƒ¨å˜é‡ï¼Œä¸ä¼šé€ƒé€¸
    sb.append("a");  // StringBuffer.appendæ˜¯åŒæ­¥çš„ï¼Œä½†JVMä¼šæ¶ˆé™¤é”
    sb.append("b");
    return sb.toString();
}
```

**3. é€ƒé€¸åˆ†æ**
```java
// å¯¹è±¡ä¸é€ƒé€¸å‡ºæ–¹æ³•ï¼ŒJVMå¯èƒ½è¿›è¡Œé”æ¶ˆé™¤
public String noEscape() {
    StringBuilder sb = new StringBuilder();
    sb.append("hello");
    sb.append("world");
    return sb.toString();  // sbå¯¹è±¡ä¸é€ƒé€¸
}
```

**æ€§èƒ½ç›‘æ§ï¼š**
```java
public class SynchronizedMonitor {
    
    // ä½¿ç”¨JMXç›‘æ§é”ä¿¡æ¯
    public void monitorLocks() {
        ThreadMXBean threadMX = ManagementFactory.getThreadMXBean();
        
        if (threadMX.isObjectMonitorUsageSupported()) {
            ThreadInfo[] threadInfos = threadMX.dumpAllThreads(true, true);
            
            for (ThreadInfo info : threadInfos) {
                MonitorInfo[] monitors = info.getLockedMonitors();
                LockInfo[] locks = info.getLockedSynchronizers();
                
                if (monitors.length > 0 || locks.length > 0) {
                    System.out.println("Thread: " + info.getThreadName());
                    for (MonitorInfo monitor : monitors) {
                        System.out.println("  Locked monitor: " + monitor);
                    }
                    for (LockInfo lock : locks) {
                        System.out.println("  Locked synchronizer: " + lock);
                    }
                }
            }
        }
    }
}
```

**æœ€ä½³å®è·µï¼š**
- å‡å°‘é”çš„æŒæœ‰æ—¶é—´
- é™ä½é”çš„ç²’åº¦
- ä½¿ç”¨è¯»å†™é”åˆ†ç¦»
- å°½é‡ä½¿ç”¨æ— é”æ•°æ®ç»“æ„
- é¿å…é”åµŒå¥—
- è€ƒè™‘ä½¿ç”¨å¹¶å‘å·¥å…·ç±»

</details>

### 148. å¦‚ä½•è®¾è®¡ä¸€ä¸ªç§’æ€åŠŸèƒ½ï¼Ÿ
<details>
<summary>å±•å¼€ <span class="badge badge--danger">å›°éš¾</span> <span class="badge badge--primary">VIP</span> <span class="badge badge--secondary">åç«¯</span> <span class="badge badge--secondary">ç³»ç»Ÿè®¾è®¡</span> <span class="badge badge--secondary">åœºæ™¯é¢˜</span></summary>

**ç³»ç»Ÿæ¶æ„è®¾è®¡ï¼š**

```
ç”¨æˆ·ç«¯ -> CDN -> è´Ÿè½½å‡è¡¡ -> ç½‘å…³å±‚ -> ä¸šåŠ¡å±‚ -> æ•°æ®å±‚
        â†“         â†“         â†“        â†“       â†“
      é™æ€èµ„æº   æµé‡åˆ†å‘    é™æµ     ç¼“å­˜    æ•°æ®åº“
```

**æ ¸å¿ƒæŒ‘æˆ˜ï¼š**
- **é«˜å¹¶å‘**ï¼šç¬é—´å¤§é‡è¯·æ±‚
- **åº“å­˜ä¸€è‡´æ€§**ï¼šé˜²æ­¢è¶…å–
- **ç³»ç»Ÿç¨³å®šæ€§**ï¼šé˜²æ­¢ç³»ç»Ÿå´©æºƒ
- **ç”¨æˆ·ä½“éªŒ**ï¼šå“åº”é€Ÿåº¦

**è¯¦ç»†è®¾è®¡æ–¹æ¡ˆï¼š**

**1. å‰ç«¯ä¼˜åŒ–**
```javascript
// å‰ç«¯é™æµå’Œé˜²é‡å¤æäº¤
class SeckillButton {
    constructor() {
        this.isSubmitting = false;
        this.countdown = 0;
    }
    
    // é˜²é‡å¤ç‚¹å‡»
    async handleSeckill() {
        if (this.isSubmitting) {
            return;
        }
        
        this.isSubmitting = true;
        this.startCountdown(3); // 3ç§’å€’è®¡æ—¶
        
        try {
            const result = await this.submitSeckill();
            this.handleResult(result);
        } catch (error) {
            this.handleError(error);
        } finally {
            this.isSubmitting = false;
        }
    }
    
    startCountdown(seconds) {
        this.countdown = seconds;
        const timer = setInterval(() => {
            this.countdown--;
            if (this.countdown <= 0) {
                clearInterval(timer);
            }
        }, 1000);
    }
    
    // é•¿è½®è¯¢è·å–ç§’æ€ç»“æœ
    async pollResult(orderId) {
        const maxAttempts = 10;
        let attempts = 0;
        
        while (attempts < maxAttempts) {
            try {
                const result = await fetch(`/api/seckill/result/${orderId}`);
                const data = await result.json();
                
                if (data.status !== 'PROCESSING') {
                    return data;
                }
                
                await new Promise(resolve => setTimeout(resolve, 1000));
                attempts++;
            } catch (error) {
                attempts++;
            }
        }
        
        return { status: 'TIMEOUT' };
    }
}
```

**2. ç½‘å…³å±‚é™æµ**
```java
@Component
public class SeckillRateLimiter {
    
    private final RedisTemplate<String, String> redisTemplate;
    
    // æ»‘åŠ¨çª—å£é™æµ
    private static final String RATE_LIMIT_SCRIPT = 
        "local key = KEYS[1] " +
        "local window = tonumber(ARGV[1]) " +
        "local limit = tonumber(ARGV[2]) " +
        "local now = tonumber(ARGV[3]) " +
        "local clearBefore = now - window * 1000 " +
        
        "redis.call('zremrangebyscore', key, 0, clearBefore) " +
        "local current = redis.call('zcard', key) " +
        
        "if current < limit then " +
        "    redis.call('zadd', key, now, now) " +
        "    redis.call('expire', key, window) " +
        "    return 1 " +
        "else " +
        "    return 0 " +
        "end";
    
    public boolean isAllowed(String userId, int windowSeconds, int limit) {
        String key = "rate_limit:seckill:" + userId;
        long now = System.currentTimeMillis();
        
        DefaultRedisScript<Long> script = new DefaultRedisScript<>();
        script.setScriptText(RATE_LIMIT_SCRIPT);
        script.setResultType(Long.class);
        
        Long result = redisTemplate.execute(script,
                Collections.singletonList(key),
                String.valueOf(windowSeconds),
                String.valueOf(limit),
                String.valueOf(now));
        
        return Long.valueOf(1L).equals(result);
    }
    
    // ä»¤ç‰Œæ¡¶é™æµ
    @Component
    public class TokenBucketLimiter {
        private final AtomicLong tokens = new AtomicLong(1000);
        private final long capacity = 1000;
        private final long refillRate = 100; // æ¯ç§’è¡¥å……100ä¸ªä»¤ç‰Œ
        private volatile long lastRefillTime = System.currentTimeMillis();
        
        public boolean tryAcquire() {
            refillTokens();
            return tokens.getAndDecrement() > 0;
        }
        
        private void refillTokens() {
            long now = System.currentTimeMillis();
            long timeSinceLastRefill = now - lastRefillTime;
            
            if (timeSinceLastRefill > 1000) { // æ¯ç§’è¡¥å……
                long tokensToAdd = (timeSinceLastRefill / 1000) * refillRate;
                long newTokens = Math.min(capacity, tokens.get() + tokensToAdd);
                tokens.set(newTokens);
                lastRefillTime = now;
            }
        }
    }
}
```

**3. åº“å­˜ç®¡ç†**
```java
@Service
public class SeckillStockService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    // Redisé¢„æ‰£åº“å­˜è„šæœ¬
    private static final String DEDUCT_STOCK_SCRIPT = 
        "local stockKey = KEYS[1] " +
        "local userId = ARGV[1] " +
        "local quantity = tonumber(ARGV[2]) " +
        "local userKey = 'seckill:user:' .. userId " +
        
        "-- æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç»å‚ä¸è¿‡ " +
        "if redis.call('exists', userKey) == 1 then " +
        "    return {-1, 'Already participated'} " +
        "end " +
        
        "-- æ£€æŸ¥åº“å­˜ " +
        "local stock = redis.call('get', stockKey) " +
        "if stock == false then " +
        "    return {-2, 'Stock not found'} " +
        "end " +
        
        "stock = tonumber(stock) " +
        "if stock >= quantity then " +
        "    redis.call('decrby', stockKey, quantity) " +
        "    redis.call('setex', userKey, 300, 1) -- 5åˆ†é’Ÿè¿‡æœŸ " +
        "    return {stock - quantity, 'Success'} " +
        "else " +
        "    return {stock, 'Insufficient stock'} " +
        "end";
    
    public StockResult deductStock(Long productId, String userId, int quantity) {
        String stockKey = "seckill:stock:" + productId;
        
        DefaultRedisScript<List> script = new DefaultRedisScript<>();
        script.setScriptText(DEDUCT_STOCK_SCRIPT);
        script.setResultType(List.class);
        
        List<Object> result = redisTemplate.execute(script,
                Collections.singletonList(stockKey),
                userId, String.valueOf(quantity));
        
        if (result != null && result.size() == 2) {
            int remainingStock = Integer.parseInt(result.get(0).toString());
            String message = result.get(1).toString();
            return new StockResult(remainingStock, message);
        }
        
        return new StockResult(-1, "Script execution failed");
    }
    
    // å¼‚æ­¥åŒæ­¥åº“å­˜åˆ°æ•°æ®åº“
    @Async
    public void syncStockToDatabase(Long productId) {
        String stockKey = "seckill:stock:" + productId;
        Object redisStock = redisTemplate.opsForValue().get(stockKey);
        
        if (redisStock != null) {
            int stock = Integer.parseInt(redisStock.toString());
            // æ‰¹é‡æ›´æ–°æ•°æ®åº“ï¼Œå‡å°‘æ•°æ®åº“å‹åŠ›
            productRepository.updateStock(productId, stock);
        }
    }
}
```

**4. è®¢å•å¤„ç†**
```java
@Service
public class SeckillOrderService {
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    // å¼‚æ­¥å¤„ç†è®¢å•
    public String createSeckillOrder(SeckillRequest request) {
        // ç”Ÿæˆè®¢å•ID
        String orderId = generateOrderId();
        
        // åˆ›å»ºè®¢å•æ¶ˆæ¯
        SeckillOrderMessage message = SeckillOrderMessage.builder()
                .orderId(orderId)
                .userId(request.getUserId())
                .productId(request.getProductId())
                .quantity(request.getQuantity())
                .createTime(LocalDateTime.now())
                .build();
        
        // å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥å¤„ç†
        rabbitTemplate.convertAndSend("seckill.order.exchange", 
                "seckill.order.create", message);
        
        // è®¾ç½®è®¢å•çŠ¶æ€ä¸ºå¤„ç†ä¸­
        redisTemplate.opsForValue().set(
                "seckill:order:status:" + orderId, 
                "PROCESSING", 
                Duration.ofMinutes(5));
        
        return orderId;
    }
    
    // æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹è€…
    @RabbitListener(queues = "seckill.order.queue")
    public void processSeckillOrder(SeckillOrderMessage message) {
        try {
            // 1. éªŒè¯ç”¨æˆ·å’Œå•†å“
            if (!validateUser(message.getUserId()) || 
                !validateProduct(message.getProductId())) {
                updateOrderStatus(message.getOrderId(), "FAILED", "Validation failed");
                return;
            }
            
            // 2. åˆ›å»ºè®¢å•
            Order order = Order.builder()
                    .orderId(message.getOrderId())
                    .userId(message.getUserId())
                    .productId(message.getProductId())
                    .quantity(message.getQuantity())
                    .status(OrderStatus.UNPAID)
                    .createTime(message.getCreateTime())
                    .build();
            
            orderRepository.save(order);
            
            // 3. æ›´æ–°è®¢å•çŠ¶æ€
            updateOrderStatus(message.getOrderId(), "SUCCESS", "Order created");
            
            // 4. å‘é€æ”¯ä»˜è¶…æ—¶æ¶ˆæ¯ï¼ˆå»¶è¿Ÿæ¶ˆæ¯ï¼‰
            sendPaymentTimeoutMessage(message.getOrderId(), 15 * 60 * 1000); // 15åˆ†é’Ÿ
            
        } catch (Exception e) {
            log.error("Process seckill order failed", e);
            updateOrderStatus(message.getOrderId(), "FAILED", e.getMessage());
            
            // å›æ»šåº“å­˜
            rollbackStock(message.getProductId(), message.getQuantity());
        }
    }
    
    private void updateOrderStatus(String orderId, String status, String message) {
        String key = "seckill:order:status:" + orderId;
        Map<String, Object> statusInfo = Map.of(
                "status", status,
                "message", message,
                "updateTime", LocalDateTime.now()
        );
        redisTemplate.opsForValue().set(key, statusInfo, Duration.ofHours(1));
    }
}
```

**5. ç¼“å­˜ç­–ç•¥**
```java
@Service
public class SeckillCacheService {
    
    // å¤šçº§ç¼“å­˜
    @Cacheable(value = "seckill:product", key = "#productId")
    public SeckillProduct getProduct(Long productId) {
        return productRepository.findById(productId);
    }
    
    // é¢„çƒ­ç¼“å­˜
    @PostConstruct
    public void warmUpCache() {
        List<SeckillActivity> activities = seckillActivityRepository.findUpcoming();
        
        for (SeckillActivity activity : activities) {
            // é¢„çƒ­å•†å“ä¿¡æ¯
            String productKey = "seckill:product:" + activity.getProductId();
            redisTemplate.opsForValue().set(productKey, activity.getProduct(), Duration.ofHours(1));
            
            // é¢„çƒ­åº“å­˜ä¿¡æ¯
            String stockKey = "seckill:stock:" + activity.getProductId();
            redisTemplate.opsForValue().set(stockKey, activity.getStock(), Duration.ofHours(2));
        }
    }
    
    // åˆ†å¸ƒå¼é”é˜²æ­¢ç¼“å­˜å‡»ç©¿
    public SeckillProduct getProductWithLock(Long productId) {
        String lockKey = "lock:seckill:product:" + productId;
        String lockValue = UUID.randomUUID().toString();
        
        try {
            // å°è¯•è·å–åˆ†å¸ƒå¼é”
            Boolean lockAcquired = redisTemplate.opsForValue()
                    .setIfAbsent(lockKey, lockValue, Duration.ofSeconds(10));
            
            if (Boolean.TRUE.equals(lockAcquired)) {
                // è·å–é”æˆåŠŸï¼ŒæŸ¥è¯¢æ•°æ®åº“
                SeckillProduct product = productRepository.findById(productId);
                if (product != null) {
                    // æ›´æ–°ç¼“å­˜
                    redisTemplate.opsForValue().set(
                            "seckill:product:" + productId, 
                            product, 
                            Duration.ofMinutes(30));
                }
                return product;
            } else {
                // è·å–é”å¤±è´¥ï¼Œç¨ç­‰åé‡è¯•
                Thread.sleep(50);
                return getProduct(productId);
            }
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
            return null;
        } finally {
            // é‡Šæ”¾é”
            releaseLock(lockKey, lockValue);
        }
    }
}
```

**6. ç›‘æ§å‘Šè­¦**
```java
@Component
public class SeckillMonitor {
    
    @Autowired
    private MeterRegistry meterRegistry;
    
    // ç›‘æ§æŒ‡æ ‡
    private final Counter seckillRequestCounter = Counter.builder("seckill.requests")
            .description("Seckill request count")
            .register(meterRegistry);
    
    private final Timer seckillResponseTimer = Timer.builder("seckill.response.time")
            .description("Seckill response time")
            .register(meterRegistry);
    
    private final Gauge stockGauge = Gauge.builder("seckill.stock")
            .description("Remaining stock")
            .register(meterRegistry, this, SeckillMonitor::getCurrentStock);
    
    public void recordRequest() {
        seckillRequestCounter.increment();
    }
    
    public void recordResponseTime(long timeMs) {
        seckillResponseTimer.record(timeMs, TimeUnit.MILLISECONDS);
    }
    
    private double getCurrentStock() {
        // è·å–å½“å‰åº“å­˜æ€»æ•°
        return stockService.getTotalStock();
    }
    
    // å®æ—¶ç›‘æ§å’Œå‘Šè­¦
    @Scheduled(fixedRate = 5000) // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡
    public void checkSystemHealth() {
        // æ£€æŸ¥ç³»ç»ŸæŒ‡æ ‡
        double cpuUsage = systemMetrics.getCpuUsage();
        double memoryUsage = systemMetrics.getMemoryUsage();
        long activeConnections = networkMetrics.getActiveConnections();
        
        if (cpuUsage > 80) {
            alertService.sendAlert(AlertLevel.HIGH, "High CPU usage: " + cpuUsage + "%");
        }
        
        if (memoryUsage > 85) {
            alertService.sendAlert(AlertLevel.HIGH, "High memory usage: " + memoryUsage + "%");
        }
        
        if (activeConnections > 10000) {
            alertService.sendAlert(AlertLevel.MEDIUM, "High connection count: " + activeConnections);
        }
        
        // æ£€æŸ¥Redisè¿æ¥
        try {
            redisTemplate.opsForValue().get("health:check");
        } catch (Exception e) {
            alertService.sendAlert(AlertLevel.CRITICAL, "Redis connection failed: " + e.getMessage());
        }
    }
}
```

**æ€§èƒ½ä¼˜åŒ–è¦ç‚¹ï¼š**
- **è¯»å†™åˆ†ç¦»**ï¼šè¯»å¤šå†™å°‘åœºæ™¯ä¼˜åŒ–
- **æ•°æ®åº“åˆ†ç‰‡**ï¼šåˆ†æ•£æ•°æ®åº“å‹åŠ›
- **CDNåŠ é€Ÿ**ï¼šé™æ€èµ„æºç¼“å­˜
- **å¼‚æ­¥å¤„ç†**ï¼šå‰Šå³°å¡«è°·
- **ç†”æ–­é™çº§**ï¼šä¿æŠ¤ç³»ç»Ÿç¨³å®šæ€§

**å®¹é‡è¯„ä¼°ï¼š**
```java
// å®¹é‡è§„åˆ’ç¤ºä¾‹
public class CapacityPlanning {
    // å‡è®¾ç›®æ ‡ï¼šæ”¯æŒ10ä¸‡äººåŒæ—¶æŠ¢è´­1000ä»¶å•†å“
    public static final int CONCURRENT_USERS = 100_000;
    public static final int TOTAL_STOCK = 1000;
    public static final int PEAK_QPS = 50_000; // å³°å€¼QPS
    
    // æœåŠ¡å™¨é…ç½®
    public static final int SERVER_COUNT = 20;           // åº”ç”¨æœåŠ¡å™¨æ•°é‡
    public static final int REDIS_CLUSTER_SIZE = 6;      // Redisé›†ç¾¤å¤§å°
    public static final int DB_CONNECTION_POOL = 50;     // æ•°æ®åº“è¿æ¥æ± 
    
    // ç¼“å­˜å®¹é‡
    public static final long REDIS_MEMORY = 16L * 1024 * 1024 * 1024; // 16GB
    public static final int CACHE_EXPIRE_TIME = 3600; // 1å°æ—¶
}
```

</details>

### 149. ä¸ºä»€ä¹ˆä¸é€‰æ‹©ä½¿ç”¨åŸç”Ÿçš„ NIO è€Œé€‰æ‹©ä½¿ç”¨ Netty å‘¢ï¼Ÿ
<details>
<summary>å±•å¼€ <span class="badge badge--info">ä¸­ç­‰</span> <span class="badge badge--primary">VIP</span> <span class="badge badge--secondary">Netty</span> <span class="badge badge--secondary">åç«¯</span></summary>

**åŸç”ŸNIOçš„é—®é¢˜ï¼š**

**1. å¼€å‘å¤æ‚åº¦é«˜**
```java
// åŸç”ŸNIOæœåŠ¡å™¨ç¤ºä¾‹
public class NIOServer {
    public void startServer() throws IOException {
        Selector selector = Selector.open();
        ServerSocketChannel serverChannel = ServerSocketChannel.open();
        serverChannel.configureBlocking(false);
        serverChannel.bind(new InetSocketAddress(8080));
        serverChannel.register(selector, SelectionKey.OP_ACCEPT);
        
        while (true) {
            selector.select();
            Set<SelectionKey> selectedKeys = selector.selectedKeys();
            Iterator<SelectionKey> iterator = selectedKeys.iterator();
            
            while (iterator.hasNext()) {
                SelectionKey key = iterator.next();
                iterator.remove();
                
                if (key.isAcceptable()) {
                    handleAccept(key);
                } else if (key.isReadable()) {
                    handleRead(key);
                } else if (key.isWritable()) {
                    handleWrite(key);
                }
            }
        }
    }
    
    private void handleAccept(SelectionKey key) throws IOException {
        ServerSocketChannel serverChannel = (ServerSocketChannel) key.channel();
        SocketChannel clientChannel = serverChannel.accept();
        clientChannel.configureBlocking(false);
        clientChannel.register(key.selector(), SelectionKey.OP_READ);
    }
    
    private void handleRead(SelectionKey key) throws IOException {
        SocketChannel channel = (SocketChannel) key.channel();
        ByteBuffer buffer = ByteBuffer.allocate(1024);
        
        int bytesRead = channel.read(buffer);
        if (bytesRead > 0) {
            buffer.flip();
            // å¤„ç†æ•°æ® - éœ€è¦è‡ªå·±å¤„ç†åŠåŒ…ã€ç²˜åŒ…é—®é¢˜
            processData(buffer);
            buffer.clear();
        } else if (bytesRead < 0) {
            // è¿æ¥å…³é—­
            key.cancel();
            channel.close();
        }
    }
    
    // éœ€è¦è‡ªå·±å¤„ç†å„ç§è¾¹ç•Œæƒ…å†µ...
}
```

**2. åŠåŒ…/ç²˜åŒ…é—®é¢˜å¤æ‚**
```java
// åŸç”ŸNIOéœ€è¦è‡ªå·±å¤„ç†åŠåŒ…ç²˜åŒ…
public class PacketHandler {
    private ByteBuffer incompleteBuffer = ByteBuffer.allocate(4096);
    
    public List<Packet> handlePackets(ByteBuffer data) {
        List<Packet> packets = new ArrayList<>();
        
        // åˆå¹¶ä¹‹å‰æœªå®Œæˆçš„æ•°æ®
        if (incompleteBuffer.position() > 0) {
            incompleteBuffer.put(data.array(), 0, data.remaining());
            incompleteBuffer.flip();
            data = incompleteBuffer;
        }
        
        while (data.remaining() >= 4) { // å‡è®¾åŒ…å¤´4å­—èŠ‚
            int packetLength = data.getInt();
            
            if (data.remaining() >= packetLength) {
                // å®Œæ•´åŒ…
                byte[] packetData = new byte[packetLength];
                data.get(packetData);
                packets.add(new Packet(packetData));
            } else {
                // åŠåŒ…ï¼Œä¿å­˜åˆ°ç¼“å†²åŒº
                data.position(data.position() - 4);
                incompleteBuffer.clear();
                incompleteBuffer.put(data);
                break;
            }
        }
        
        return packets;
    }
}
```

**3. å†…å­˜ç®¡ç†å›°éš¾**
```java
// åŸç”ŸNIOå†…å­˜ç®¡ç†
public class BufferManager {
    // éœ€è¦æ‰‹åŠ¨ç®¡ç†ByteBufferçš„åˆ†é…å’Œå›æ”¶
    private final Queue<ByteBuffer> bufferPool = new ConcurrentLinkedQueue<>();
    
    public ByteBuffer allocateBuffer() {
        ByteBuffer buffer = bufferPool.poll();
        if (buffer == null) {
            buffer = ByteBuffer.allocateDirect(8192); // ç›´æ¥å†…å­˜
        }
        buffer.clear();
        return buffer;
    }
    
    public void releaseBuffer(ByteBuffer buffer) {
        if (buffer.isDirect() && buffer.capacity() <= 8192) {
            bufferPool.offer(buffer);
        }
        // ç›´æ¥å†…å­˜éœ€è¦æ‰‹åŠ¨ç®¡ç†ï¼Œå®¹æ˜“é€ æˆå†…å­˜æ³„æ¼
    }
}
```

**Nettyçš„ä¼˜åŠ¿ï¼š**

**1. ç®€åŒ–çš„API**
```java
// NettyæœåŠ¡å™¨ç¤ºä¾‹
public class NettyServer {
    public void start() throws InterruptedException {
        EventLoopGroup bossGroup = new NioEventLoopGroup(1);
        EventLoopGroup workerGroup = new NioEventLoopGroup();
        
        try {
            ServerBootstrap bootstrap = new ServerBootstrap();
            bootstrap.group(bossGroup, workerGroup)
                    .channel(NioServerSocketChannel.class)
                    .childHandler(new ChannelInitializer<SocketChannel>() {
                        @Override
                        protected void initChannel(SocketChannel ch) {
                            ChannelPipeline pipeline = ch.pipeline();
                            
                            // è‡ªåŠ¨å¤„ç†åŠåŒ…ç²˜åŒ…
                            pipeline.addLast(new LengthFieldBasedFrameDecoder(
                                    1024 * 1024, 0, 4, 0, 4));
                            pipeline.addLast(new LengthFieldPrepender(4));
                            
                            // è‡ªå®šä¹‰ä¸šåŠ¡å¤„ç†å™¨
                            pipeline.addLast(new ServerHandler());
                        }
                    });
            
            ChannelFuture future = bootstrap.bind(8080).sync();
            future.channel().closeFuture().sync();
        } finally {
            bossGroup.shutdownGracefully();
            workerGroup.shutdownGracefully();
        }
    }
}

// ç®€å•çš„ä¸šåŠ¡å¤„ç†å™¨
public class ServerHandler extends ChannelInboundHandlerAdapter {
    @Override
    public void channelRead(ChannelHandlerContext ctx, Object msg) {
        ByteBuf buffer = (ByteBuf) msg;
        
        try {
            // è‡ªåŠ¨å¤„ç†äº†åŠåŒ…ç²˜åŒ…ï¼Œç›´æ¥å¤„ç†å®Œæ•´æ•°æ®
            byte[] data = new byte[buffer.readableBytes()];
            buffer.readBytes(data);
            
            // å¤„ç†ä¸šåŠ¡é€»è¾‘
            String response = processRequest(new String(data));
            
            // å‘é€å“åº”
            ctx.writeAndFlush(Unpooled.copiedBuffer(response.getBytes()));
        } finally {
            buffer.release(); // è‡ªåŠ¨å†…å­˜ç®¡ç†
        }
    }
}
```

**2. è‡ªåŠ¨å¤„ç†åŠåŒ…ç²˜åŒ…**
```java
// Nettyæä¾›å¤šç§è§£ç å™¨
public class DecoderExamples {
    
    public void addDecoders(ChannelPipeline pipeline) {
        // 1. å›ºå®šé•¿åº¦è§£ç å™¨
        pipeline.addLast(new FixedLengthFrameDecoder(20));
        
        // 2. åˆ†éš”ç¬¦è§£ç å™¨
        pipeline.addLast(new DelimiterBasedFrameDecoder(1024, 
                Delimiters.lineDelimiter()));
        
        // 3. é•¿åº¦å­—æ®µè§£ç å™¨
        pipeline.addLast(new LengthFieldBasedFrameDecoder(
                65536,  // maxFrameLength
                0,      // lengthFieldOffset
                4,      // lengthFieldLength
                0,      // lengthAdjustment
                4       // initialBytesToStrip
        ));
        
        // 4. è‡ªå®šä¹‰åè®®è§£ç å™¨
        pipeline.addLast(new CustomProtocolDecoder());
    }
}

// è‡ªå®šä¹‰è§£ç å™¨ç¤ºä¾‹
public class CustomProtocolDecoder extends ByteToMessageDecoder {
    @Override
    protected void decode(ChannelHandlerContext ctx, ByteBuf in, List<Object> out) {
        if (in.readableBytes() < 8) { // åè®®å¤´8å­—èŠ‚
            return; // ç­‰å¾…æ›´å¤šæ•°æ®
        }
        
        in.markReaderIndex(); // æ ‡è®°å½“å‰ä½ç½®
        
        int magic = in.readInt();
        if (magic != 0x12345678) {
            in.resetReaderIndex();
            throw new RuntimeException("Invalid magic number");
        }
        
        int length = in.readInt();
        if (in.readableBytes() < length) {
            in.resetReaderIndex(); // é‡ç½®åˆ°æ ‡è®°ä½ç½®
            return; // ç­‰å¾…æ›´å¤šæ•°æ®
        }
        
        // è¯»å–å®Œæ•´æ•°æ®åŒ…
        ByteBuf frame = in.readBytes(length);
        out.add(frame);
    }
}
```

**3. é«˜æ•ˆçš„å†…å­˜ç®¡ç†**
```java
// Nettyçš„ByteBufä¼˜åŠ¿
public class ByteBufExamples {
    
    public void demonstrateByteBuffer() {
        // åŸç”ŸByteBufferé—®é¢˜
        ByteBuffer buffer = ByteBuffer.allocate(1024);
        buffer.put("Hello".getBytes());
        buffer.flip(); // éœ€è¦æ‰‹åŠ¨flip
        
        byte[] data = new byte[buffer.remaining()];
        buffer.get(data);
        // è¯»å†™æ¨¡å¼åˆ‡æ¢å¤æ‚
    }
    
    public void demonstrateByteBuf() {
        // Netty ByteBufä¼˜åŠ¿
        ByteBuf buffer = Unpooled.buffer(1024);
        
        // 1. è¯»å†™æŒ‡é’ˆåˆ†ç¦»ï¼Œæ— éœ€flip
        buffer.writeBytes("Hello".getBytes());
        buffer.writeInt(42);
        
        byte[] data = new byte[5];
        buffer.readBytes(data);
        int value = buffer.readInt();
        
        // 2. å¼•ç”¨è®¡æ•°ï¼Œè‡ªåŠ¨å†…å­˜ç®¡ç†
        buffer.release();
        
        // 3. é›¶æ‹·è´æ”¯æŒ
        ByteBuf composite = Unpooled.compositeBuffer();
        composite.addComponent(true, buffer1);
        composite.addComponent(true, buffer2);
        // ä¸éœ€è¦æ•°æ®æ‹·è´
    }
    
    public void pooledBuffers() {
        // 4. å†…å­˜æ± åŒ–
        ByteBuf pooled = PooledByteBufAllocator.DEFAULT.buffer(1024);
        try {
            // ä½¿ç”¨pooled buffer
        } finally {
            pooled.release(); // å½’è¿˜åˆ°æ± ä¸­
        }
    }
}
```

**4. äº‹ä»¶é©±åŠ¨æ¶æ„**
```java
// Nettyçš„Pipelineè®¾è®¡
public class PipelineExample {
    
    public void setupPipeline(ChannelPipeline pipeline) {
        // å…¥ç«™å¤„ç†å™¨é“¾
        pipeline.addLast("decoder", new MessageDecoder());
        pipeline.addLast("validator", new MessageValidator());
        pipeline.addLast("handler", new BusinessHandler());
        
        // å‡ºç«™å¤„ç†å™¨é“¾
        pipeline.addLast("encoder", new MessageEncoder());
        pipeline.addLast("compressor", new CompressionHandler());
    }
}

// å¤„ç†å™¨å¯ä»¥çµæ´»ç»„åˆ
public class MessageValidator extends ChannelInboundHandlerAdapter {
    @Override
    public void channelRead(ChannelHandlerContext ctx, Object msg) {
        if (validate(msg)) {
            ctx.fireChannelRead(msg); // ä¼ é€’ç»™ä¸‹ä¸€ä¸ªå¤„ç†å™¨
        } else {
            ctx.close(); // éªŒè¯å¤±è´¥ï¼Œå…³é—­è¿æ¥
        }
    }
}
```

**5. çº¿ç¨‹æ¨¡å‹ä¼˜åŒ–**
```java
// Nettyçš„Reactoræ¨¡å‹
public class ReactorModel {
    
    public void singleReactor() {
        // å•Reactorå•çº¿ç¨‹
        EventLoopGroup group = new NioEventLoopGroup(1);
        // æ‰€æœ‰I/Oæ“ä½œåœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­å¤„ç†
    }
    
    public void multiReactor() {
        // ä¸»ä»Reactoræ¨¡å‹
        EventLoopGroup bossGroup = new NioEventLoopGroup(1);    // æ¥å—è¿æ¥
        EventLoopGroup workerGroup = new NioEventLoopGroup();   // å¤„ç†I/O
        
        ServerBootstrap bootstrap = new ServerBootstrap();
        bootstrap.group(bossGroup, workerGroup); // åˆ†ç¦»æ¥å—å’Œå¤„ç†
    }
    
    public void customThreadModel() {
        // è‡ªå®šä¹‰çº¿ç¨‹æ¨¡å‹
        EventLoopGroup group = new DefaultEventLoopGroup(10); // ä¸šåŠ¡çº¿ç¨‹æ± 
        
        pipeline.addLast(group, "business", new BusinessHandler());
        // ä¸šåŠ¡å¤„ç†åœ¨å•ç‹¬çº¿ç¨‹æ± ä¸­ï¼Œä¸é˜»å¡I/Oçº¿ç¨‹
    }
}
```

**6. ä¸°å¯Œçš„ç¼–è§£ç å™¨**
```java
// Nettyå†…ç½®ç¼–è§£ç å™¨
public class CodecExamples {
    
    public void httpCodec(ChannelPipeline pipeline) {
        // HTTPç¼–è§£ç å™¨
        pipeline.addLast(new HttpServerCodec());
        pipeline.addLast(new HttpObjectAggregator(65536));
        pipeline.addLast(new HttpServerHandler());
    }
    
    public void websocketCodec(ChannelPipeline pipeline) {
        // WebSocketç¼–è§£ç å™¨
        pipeline.addLast(new HttpServerCodec());
        pipeline.addLast(new HttpObjectAggregator(65536));
        pipeline.addLast(new WebSocketServerProtocolHandler("/ws"));
        pipeline.addLast(new WebSocketHandler());
    }
    
    public void protobufCodec(ChannelPipeline pipeline) {
        // Protobufç¼–è§£ç å™¨
        pipeline.addLast(new ProtobufVarint32FrameDecoder());
        pipeline.addLast(new ProtobufDecoder(MyProto.Message.getDefaultInstance()));
        pipeline.addLast(new ProtobufVarint32LengthFieldPrepender());
        pipeline.addLast(new ProtobufEncoder());
    }
}
```

**7. è·¨å¹³å°å’Œæ€§èƒ½ä¼˜åŒ–**
```java
// Nettyçš„ä¼ è¾“å±‚æŠ½è±¡
public class TransportOptions {
    
    public void nioTransport() {
        // æ ‡å‡†NIOä¼ è¾“ï¼Œè·¨å¹³å°
        ServerBootstrap bootstrap = new ServerBootstrap();
        bootstrap.group(bossGroup, workerGroup)
                .channel(NioServerSocketChannel.class);
    }
    
    public void epollTransport() {
        // Linuxä¼˜åŒ–ä¼ è¾“
        if (Epoll.isAvailable()) {
            bootstrap.group(bossGroup, workerGroup)
                    .channel(EpollServerSocketChannel.class);
        }
    }
    
    public void kqueueTransport() {
        // macOS/BSDä¼˜åŒ–ä¼ è¾“
        if (KQueue.isAvailable()) {
            bootstrap.group(bossGroup, workerGroup)
                    .channel(KQueueServerSocketChannel.class);
        }
    }
}
```

**æ€§èƒ½å¯¹æ¯”ï¼š**
```java
// ç®€åŒ–çš„æ€§èƒ½æµ‹è¯•
public class PerformanceComparison {
    
    // åŸç”ŸNIOå®ç°å¤æ‚ï¼Œå®¹æ˜“å‡ºé”™
    // - éœ€è¦å¤„ç†å„ç§è¾¹ç•Œæƒ…å†µ
    // - å†…å­˜ç®¡ç†å¤æ‚
    // - ä»£ç é‡å¤§ï¼Œç»´æŠ¤å›°éš¾
    
    // Nettyå®ç°ç®€æ´ï¼ŒåŠŸèƒ½å¼ºå¤§
    // - è‡ªåŠ¨å¤„ç†åè®®ç»†èŠ‚
    // - ä¼˜åŒ–çš„å†…å­˜ç®¡ç†
    // - ä¸°å¯Œçš„ç»„ä»¶ç”Ÿæ€
    
    // å®é™…é¡¹ç›®ä¸­çš„é€‰æ‹©
    public void realWorldChoice() {
        // å¦‚æœä½ æ˜¯ï¼š
        // 1. æ¡†æ¶å¼€å‘è€… -> å¯èƒ½é€‰æ‹©åŸç”ŸNIOè·å¾—æœ€å¤§æ§åˆ¶æƒ
        // 2. åº”ç”¨å¼€å‘è€… -> æ¨èä½¿ç”¨Nettyæé«˜å¼€å‘æ•ˆç‡
        // 3. å­¦ä¹ è€… -> å…ˆå­¦åŸç”ŸNIOç†è§£åŸç†ï¼Œå†ç”¨Nettyå®æˆ˜
    }
}
```

**æ€»ç»“ï¼šé€‰æ‹©Nettyçš„åŸå› **
- **å¼€å‘æ•ˆç‡**ï¼šå¤§å¹…å‡å°‘ä»£ç é‡å’Œå¼€å‘æ—¶é—´
- **ç¨³å®šæ€§**ï¼šç»è¿‡å¤§é‡ç”Ÿäº§ç¯å¢ƒéªŒè¯
- **æ€§èƒ½**ï¼šé«˜åº¦ä¼˜åŒ–çš„å®ç°
- **åŠŸèƒ½ä¸°å¯Œ**ï¼šæä¾›å„ç§åè®®æ”¯æŒ
- **ç¤¾åŒºæ´»è·ƒ**ï¼šæŒç»­æ›´æ–°å’Œç»´æŠ¤
- **å­¦ä¹ æˆæœ¬ä½**ï¼šAPIè®¾è®¡å‹å¥½

</details>

### 150. çœ‹è¿‡æºç å—ï¼Ÿè¯´ä¸‹ Spring ç”±å“ªäº›é‡è¦çš„æ¨¡å—ç»„æˆï¼Ÿ
<details>
<summary>å±•å¼€ <span class="badge badge--info">ä¸­ç­‰</span> <span class="badge badge--primary">VIP</span> <span class="badge badge--secondary">åç«¯</span> <span class="badge badge--secondary">Spring</span></summary>

**Springæ¡†æ¶æ¨¡å—æ¶æ„ï¼š**

```
Spring Framework
â”œâ”€â”€ spring-core (æ ¸å¿ƒå®¹å™¨)
â”œâ”€â”€ spring-beans (Beanç®¡ç†)
â”œâ”€â”€ spring-context (åº”ç”¨ä¸Šä¸‹æ–‡)
â”œâ”€â”€ spring-context-support (ä¸Šä¸‹æ–‡æ”¯æŒ)
â”œâ”€â”€ spring-aop (é¢å‘åˆ‡é¢ç¼–ç¨‹)
â”œâ”€â”€ spring-aspects (AspectJé›†æˆ)
â”œâ”€â”€ spring-web (WebåŸºç¡€)
â”œâ”€â”€ spring-webmvc (Web MVC)
â”œâ”€â”€ spring-webflux (å“åº”å¼Web)
â”œâ”€â”€ spring-jdbc (æ•°æ®è®¿é—®)
â”œâ”€â”€ spring-tx (äº‹åŠ¡ç®¡ç†)
â”œâ”€â”€ spring-orm (å¯¹è±¡å…³ç³»æ˜ å°„)
â”œâ”€â”€ spring-jms (æ¶ˆæ¯)
â”œâ”€â”€ spring-test (æµ‹è¯•æ”¯æŒ)
â””â”€â”€ spring-expression (è¡¨è¾¾å¼è¯­è¨€)
```

**æ ¸å¿ƒæ¨¡å—è¯¦è§£ï¼š**

**1. spring-coreï¼ˆæ ¸å¿ƒæ¨¡å—ï¼‰**
```java
// æ ¸å¿ƒå·¥å…·ç±»å’ŒåŸºç¡€è®¾æ–½
public class CoreModuleExample {
    
    public void demonstrateCoreFeatures() {
        // 1. èµ„æºè®¿é—®æŠ½è±¡
        Resource resource = new ClassPathResource("application.properties");
        Resource urlResource = new UrlResource("https://example.com/config");
        Resource fileResource = new FileSystemResource("/path/to/file");
        
        // 2. ç±»å‹è½¬æ¢ç³»ç»Ÿ
        ConversionService conversionService = new DefaultConversionService();
        String dateStr = "2023-12-25";
        Date date = conversionService.convert(dateStr, Date.class);
        
        // 3. ç¯å¢ƒæŠ½è±¡
        Environment environment = new StandardEnvironment();
        String property = environment.getProperty("java.version");
        
        // 4. äº‹ä»¶å‘å¸ƒæœºåˆ¶
        ApplicationEventPublisher publisher = // è·å–å‘å¸ƒå™¨
        publisher.publishEvent(new CustomEvent("test"));
    }
}

// æ ¸å¿ƒæ¥å£ï¼šBeanFactory
public interface BeanFactory {
    Object getBean(String name) throws BeansException;
    <T> T getBean(String name, Class<T> requiredType) throws BeansException;
    Object getBean(String name, Object... args) throws BeansException;
    <T> T getBean(Class<T> requiredType) throws BeansException;
    boolean containsBean(String name);
    boolean isSingleton(String name) throws NoSuchBeanDefinitionException;
    boolean isPrototype(String name) throws NoSuchBeanDefinitionException;
}
```

**2. spring-beansï¼ˆBeanç®¡ç†ï¼‰**
```java
// Beanå®šä¹‰å’Œç”Ÿå‘½å‘¨æœŸç®¡ç†
public class BeansModuleExample {
    
    public void beanLifecycle() {
        // Beanå®šä¹‰
        BeanDefinition beanDefinition = BeanDefinitionBuilder
                .genericBeanDefinition(UserService.class)
                .addPropertyValue("userDao", new RuntimeBeanReference("userDao"))
                .setScope(BeanDefinition.SCOPE_SINGLETON)
                .getBeanDefinition();
        
        // Beanå·¥å‚åå¤„ç†å™¨
        BeanFactoryPostProcessor processor = new PropertyPlaceholderConfigurer();
        
        // Beanåå¤„ç†å™¨
        BeanPostProcessor postProcessor = new BeanPostProcessor() {
            @Override
            public Object postProcessBeforeInitialization(Object bean, String beanName) {
                System.out.println("Before initialization: " + beanName);
                return bean;
            }
            
            @Override
            public Object postProcessAfterInitialization(Object bean, String beanName) {
                System.out.println("After initialization: " + beanName);
                return bean;
            }
        };
    }
}

// Beanç”Ÿå‘½å‘¨æœŸå›è°ƒ
@Component
public class LifecycleBean implements InitializingBean, DisposableBean, 
                                     BeanNameAware, ApplicationContextAware {
    
    private String beanName;
    private ApplicationContext applicationContext;
    
    @Override
    public void setBeanName(String name) {
        this.beanName = name;
        System.out.println("BeanNameAware: " + name);
    }
    
    @Override
    public void setApplicationContext(ApplicationContext applicationContext) {
        this.applicationContext = applicationContext;
        System.out.println("ApplicationContextAware set");
    }
    
    @PostConstruct
    public void postConstruct() {
        System.out.println("@PostConstruct method called");
    }
    
    @Override
    public void afterPropertiesSet() {
        System.out.println("InitializingBean.afterPropertiesSet called");
    }
    
    @PreDestroy
    public void preDestroy() {
        System.out.println("@PreDestroy method called");
    }
    
    @Override
    public void destroy() {
        System.out.println("DisposableBean.destroy called");
    }
}
```

**3. spring-contextï¼ˆåº”ç”¨ä¸Šä¸‹æ–‡ï¼‰**
```java
// åº”ç”¨ä¸Šä¸‹æ–‡å®ç°
public class ContextModuleExample {
    
    public void demonstrateApplicationContext() {
        // 1. æ³¨è§£é…ç½®åº”ç”¨ä¸Šä¸‹æ–‡
        ApplicationContext context = new AnnotationConfigApplicationContext(AppConfig.class);
        
        // 2. XMLé…ç½®åº”ç”¨ä¸Šä¸‹æ–‡
        ApplicationContext xmlContext = new ClassPathXmlApplicationContext("applicationContext.xml");
        
        // 3. Webåº”ç”¨ä¸Šä¸‹æ–‡
        // WebApplicationContext webContext = new XmlWebApplicationContext();
        
        // 4. è·å–Bean
        UserService userService = context.getBean(UserService.class);
        
        // 5. äº‹ä»¶å‘å¸ƒ
        context.publishEvent(new CustomApplicationEvent("test data"));
        
        // 6. ç¯å¢ƒä¿¡æ¯
        Environment env = context.getEnvironment();
        String[] profiles = env.getActiveProfiles();
    }
}

// é…ç½®ç±»
@Configuration
@ComponentScan(basePackages = "com.example")
@PropertySource("classpath:application.properties")
public class AppConfig {
    
    @Bean
    @Primary
    public DataSource dataSource() {
        HikariDataSource dataSource = new HikariDataSource();
        dataSource.setJdbcUrl("jdbc:mysql://localhost:3306/test");
        return dataSource;
    }
    
    @Bean
    @ConditionalOnProperty(name = "cache.enabled", havingValue = "true")
    public CacheManager cacheManager() {
        return new ConcurrentMapCacheManager();
    }
}

// è‡ªå®šä¹‰åº”ç”¨äº‹ä»¶
public class CustomApplicationEvent extends ApplicationEvent {
    private final String data;
    
    public CustomApplicationEvent(Object source, String data) {
        super(source);
        this.data = data;
    }
    
    public String getData() {
        return data;
    }
}

// äº‹ä»¶ç›‘å¬å™¨
@EventListener
@Component
public class ApplicationEventListener {
    
    @EventListener
    public void handleCustomEvent(CustomApplicationEvent event) {
        System.out.println("Received custom event: " + event.getData());
    }
    
    @EventListener
    @Async
    public void handleContextRefreshedEvent(ContextRefreshedEvent event) {
        System.out.println("Application context refreshed");
    }
}
```

**4. spring-aopï¼ˆé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼‰**
```java
// AOPå®ç°åŸç†
@Aspect
@Component
public class LoggingAspect {
    
    // åˆ‡ç‚¹è¡¨è¾¾å¼
    @Pointcut("execution(* com.example.service.*.*(..))")
    public void serviceLayer() {}
    
    @Pointcut("@annotation(com.example.annotation.Cacheable)")
    public void cacheableMethod() {}
    
    // å‰ç½®é€šçŸ¥
    @Before("serviceLayer()")
    public void logBefore(JoinPoint joinPoint) {
        String methodName = joinPoint.getSignature().getName();
        Object[] args = joinPoint.getArgs();
        System.out.println("Before method: " + methodName + " with args: " + Arrays.toString(args));
    }
    
    // ç¯ç»•é€šçŸ¥
    @Around("serviceLayer()")
    public Object logAround(ProceedingJoinPoint joinPoint) throws Throwable {
        long startTime = System.currentTimeMillis();
        
        try {
            Object result = joinPoint.proceed();
            long endTime = System.currentTimeMillis();
            System.out.println("Method executed in: " + (endTime - startTime) + "ms");
            return result;
        } catch (Exception e) {
            System.out.println("Method execution failed: " + e.getMessage());
            throw e;
        }
    }
    
    // å¼‚å¸¸é€šçŸ¥
    @AfterThrowing(pointcut = "serviceLayer()", throwing = "ex")
    public void logException(JoinPoint joinPoint, Exception ex) {
        System.out.println("Exception in method: " + joinPoint.getSignature().getName() + 
                          " Exception: " + ex.getMessage());
    }
}

// AOPä»£ç†åˆ›å»ºè¿‡ç¨‹ï¼ˆæºç ç†è§£ï¼‰
@Configuration
@EnableAspectJAutoProxy(proxyTargetClass = true)
public class AopConfig {
    // AnnotationAwareAspectJAutoProxyCreatorä¼šè‡ªåŠ¨åˆ›å»ºä»£ç†
}
```

**5. spring-web å’Œ spring-webmvc**
```java
// Web MVCæ¨¡å—
@RestController
@RequestMapping("/api/users")
public class UserController {
    
    @Autowired
    private UserService userService;
    
    @GetMapping("/{id}")
    public ResponseEntity<User> getUser(@PathVariable Long id) {
        User user = userService.findById(id);
        return ResponseEntity.ok(user);
    }
    
    @PostMapping
    public ResponseEntity<User> createUser(@RequestBody @Valid User user) {
        User savedUser = userService.save(user);
        return ResponseEntity.status(HttpStatus.CREATED).body(savedUser);
    }
}

// Web MVCé…ç½®
@Configuration
@EnableWebMvc
public class WebMvcConfig implements WebMvcConfigurer {
    
    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(new LoggingInterceptor())
                .addPathPatterns("/api/**")
                .excludePathPatterns("/api/public/**");
    }
    
    @Override
    public void configureMessageConverters(List<HttpMessageConverter<?>> converters) {
        converters.add(new MappingJackson2HttpMessageConverter());
    }
    
    @Bean
    public ViewResolver viewResolver() {
        InternalResourceViewResolver resolver = new InternalResourceViewResolver();
        resolver.setPrefix("/WEB-INF/views/");
        resolver.setSuffix(".jsp");
        return resolver;
    }
}

// DispatcherServletå·¥ä½œæµç¨‹ï¼ˆæ ¸å¿ƒï¼‰
public class DispatcherServletFlow {
    /*
    1. Requestè¿›å…¥DispatcherServlet
    2. HandlerMappingæŸ¥æ‰¾Handler
    3. HandlerAdapteræ‰§è¡ŒHandler
    4. ViewResolverè§£æè§†å›¾
    5. Viewæ¸²æŸ“å“åº”
    */
}
```

**6. spring-jdbc å’Œ spring-tx**
```java
// JDBCæ¨¡å—
@Repository
public class UserDaoImpl implements UserDao {
    
    @Autowired
    private JdbcTemplate jdbcTemplate;
    
    @Override
    public User findById(Long id) {
        String sql = "SELECT * FROM users WHERE id = ?";
        return jdbcTemplate.queryForObject(sql, new UserRowMapper(), id);
    }
    
    @Override
    public List<User> findAll() {
        String sql = "SELECT * FROM users";
        return jdbcTemplate.query(sql, new UserRowMapper());
    }
    
    @Override
    public int save(User user) {
        String sql = "INSERT INTO users (name, email) VALUES (?, ?)";
        return jdbcTemplate.update(sql, user.getName(), user.getEmail());
    }
    
    private static class UserRowMapper implements RowMapper<User> {
        @Override
        public User mapRow(ResultSet rs, int rowNum) throws SQLException {
            User user = new User();
            user.setId(rs.getLong("id"));
            user.setName(rs.getString("name"));
            user.setEmail(rs.getString("email"));
            return user;
        }
    }
}

// äº‹åŠ¡ç®¡ç†
@Service
@Transactional
public class UserService {
    
    @Autowired
    private UserDao userDao;
    
    @Transactional(propagation = Propagation.REQUIRED)
    public User createUser(User user) {
        // äº‹åŠ¡ä¼šè‡ªåŠ¨å¼€å§‹
        userDao.save(user);
        
        // å¦‚æœæŠ›å‡ºå¼‚å¸¸ï¼Œäº‹åŠ¡ä¼šå›æ»š
        if (user.getName().equals("error")) {
            throw new RuntimeException("Simulated error");
        }
        
        return user;
        // æ–¹æ³•æ­£å¸¸ç»“æŸï¼Œäº‹åŠ¡æäº¤
    }
    
    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void auditLog(String operation) {
        // ç‹¬ç«‹äº‹åŠ¡ï¼Œä¸å—å¤–éƒ¨äº‹åŠ¡å½±å“
        auditDao.log(operation);
    }
}

// äº‹åŠ¡é…ç½®
@Configuration
@EnableTransactionManagement
public class TransactionConfig {
    
    @Bean
    public PlatformTransactionManager transactionManager(DataSource dataSource) {
        return new DataSourceTransactionManager(dataSource);
    }
}
```

**æºç æ ¸å¿ƒæµç¨‹ï¼š**

**1. ApplicationContextå¯åŠ¨æµç¨‹**
```java
// AbstractApplicationContext.refresh()æ–¹æ³•
public void refresh() throws BeansException, IllegalStateException {
    synchronized (this.startupShutdownMonitor) {
        // 1. å‡†å¤‡åˆ·æ–°ä¸Šä¸‹æ–‡
        prepareRefresh();
        
        // 2. è·å–BeanFactory
        ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();
        
        // 3. å‡†å¤‡BeanFactory
        prepareBeanFactory(beanFactory);
        
        try {
            // 4. åå¤„ç†BeanFactory
            postProcessBeanFactory(beanFactory);
            
            // 5. è°ƒç”¨BeanFactoryPostProcessor
            invokeBeanFactoryPostProcessors(beanFactory);
            
            // 6. æ³¨å†ŒBeanPostProcessor
            registerBeanPostProcessors(beanFactory);
            
            // 7. åˆå§‹åŒ–MessageSource
            initMessageSource();
            
            // 8. åˆå§‹åŒ–äº‹ä»¶å¹¿æ’­å™¨
            initApplicationEventMulticaster();
            
            // 9. åˆ·æ–°ç‰¹å®šä¸Šä¸‹æ–‡
            onRefresh();
            
            // 10. æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨
            registerListeners();
            
            // 11. å®ä¾‹åŒ–æ‰€æœ‰å•ä¾‹Bean
            finishBeanFactoryInitialization(beanFactory);
            
            // 12. å®Œæˆåˆ·æ–°
            finishRefresh();
        }
        catch (BeansException ex) {
            destroyBeans();
            cancelRefresh(ex);
            throw ex;
        }
        finally {
            resetCommonCaches();
        }
    }
}
```

**2. Beanåˆ›å»ºæµç¨‹**
```java
// AbstractAutowireCapableBeanFactory.createBean()
protected Object createBean(String beanName, RootBeanDefinition mbd, Object[] args) {
    // 1. è§£æBeanç±»å‹
    Class<?> resolvedClass = resolveBeanClass(mbd, beanName);
    
    // 2. å®ä¾‹åŒ–å‰å¤„ç†
    Object bean = resolveBeforeInstantiation(beanName, mbdToUse);
    if (bean != null) {
        return bean;
    }
    
    // 3. åˆ›å»ºBeanå®ä¾‹
    Object beanInstance = doCreateBean(beanName, mbdToUse, args);
    return beanInstance;
}

protected Object doCreateBean(String beanName, RootBeanDefinition mbd, Object[] args) {
    // 1. å®ä¾‹åŒ–Bean
    BeanWrapper instanceWrapper = createBeanInstance(beanName, mbd, args);
    
    // 2. åº”ç”¨MergedBeanDefinitionPostProcessor
    applyMergedBeanDefinitionPostProcessors(mbd, beanType, beanName);
    
    // 3. å±æ€§æ³¨å…¥
    populateBean(beanName, mbd, instanceWrapper);
    
    // 4. åˆå§‹åŒ–Bean
    Object exposedObject = initializeBean(beanName, exposedObject, mbd);
    
    return exposedObject;
}
```

**æ¨¡å—ä¾èµ–å…³ç³»ï¼š**
```
spring-context
    â”œâ”€â”€ spring-aop
    â”œâ”€â”€ spring-beans
    â”œâ”€â”€ spring-core
    â””â”€â”€ spring-expression

spring-webmvc
    â”œâ”€â”€ spring-web
    â”œâ”€â”€ spring-context
    â””â”€â”€ spring-beans

spring-tx
    â”œâ”€â”€ spring-beans
    â””â”€â”€ spring-core
```

**å­¦ä¹ å»ºè®®ï¼š**
1. ä»spring-coreå¼€å§‹ï¼Œç†è§£åŸºç¡€è®¾æ–½
2. å­¦ä¹ spring-beansï¼ŒæŒæ¡IOCå®¹å™¨
3. ç ”ç©¶spring-contextï¼Œç†è§£åº”ç”¨ä¸Šä¸‹æ–‡
4. æ·±å…¥spring-aopï¼Œç†è§£ä»£ç†æœºåˆ¶
5. ç»“åˆå®é™…é¡¹ç›®ï¼Œç†è§£å„æ¨¡å—åä½œ

</details>

### 151. å¦‚ä½•ä¼˜åŒ– Java ä¸­çš„é”çš„ä½¿ç”¨ï¼Ÿ
<details>
<summary>å±•å¼€ <span class="badge badge--info">ä¸­ç­‰</span> <span class="badge badge--secondary">Javaå¹¶å‘</span> <span class="badge badge--secondary">Java</span></summary>

**é”ä¼˜åŒ–ç­–ç•¥ï¼š**

**1. å‡å°‘é”çš„ç²’åº¦**
```java
// ä¼˜åŒ–å‰ï¼šç²—ç²’åº¦é”
public class CoarseGrainedLock {
    private final Object lock = new Object();
    private Map<String, User> users = new HashMap<>();
    private Map<String, Order> orders = new HashMap<>();
    
    public void addUser(String id, User user) {
        synchronized (lock) {  // é”ä½äº†æ‰€æœ‰æ•°æ®
            users.put(id, user);
        }
    }
    
    public void addOrder(String id, Order order) {
        synchronized (lock) {  // ä¸ç›¸å…³çš„æ“ä½œä¹Ÿè¢«é”ä½
            orders.put(id, order);
        }
    }
}

// ä¼˜åŒ–åï¼šç»†ç²’åº¦é”
public class FineGrainedLock {
    private final Object userLock = new Object();
    private final Object orderLock = new Object();
    private Map<String, User> users = new HashMap<>();
    private Map<String, Order> orders = new HashMap<>();
    
    public void addUser(String id, User user) {
        synchronized (userLock) {  // åªé”ç”¨æˆ·æ•°æ®
            users.put(id, user);
        }
    }
    
    public void addOrder(String id, Order order) {
        synchronized (orderLock) {  // åªé”è®¢å•æ•°æ®
            orders.put(id, order);
        }
    }
}
```

**2. é”åˆ†æ®µæŠ€æœ¯**
```java
// å‚è€ƒConcurrentHashMapçš„åˆ†æ®µé”æ€æƒ³
public class SegmentedLock<T> {
    private final int segmentCount;
    private final Object[] locks;
    private final Map<String, T>[] segments;
    
    @SuppressWarnings("unchecked")
    public SegmentedLock(int segmentCount) {
        this.segmentCount = segmentCount;
        this.locks = new Object[segmentCount];
        this.segments = new Map[segmentCount];
        
        for (int i = 0; i < segmentCount; i++) {
            locks[i] = new Object();
            segments[i] = new HashMap<>();
        }
    }
    
    private int getSegmentIndex(String key) {
        return Math.abs(key.hashCode()) % segmentCount;
    }
    
    public void put(String key, T value) {
        int index = getSegmentIndex(key);
        synchronized (locks[index]) {  // åªé”å¯¹åº”çš„æ®µ
            segments[index].put(key, value);
        }
    }
    
    public T get(String key) {
        int index = getSegmentIndex(key);
        synchronized (locks[index]) {
            return segments[index].get(key);
        }
    }
}
```

**3. è¯»å†™é”åˆ†ç¦»**
```java
public class ReadWriteLockExample {
    private final ReadWriteLock lock = new ReentrantReadWriteLock();
    private final Lock readLock = lock.readLock();
    private final Lock writeLock = lock.writeLock();
    private Map<String, String> cache = new HashMap<>();
    
    public String getValue(String key) {
        readLock.lock();
        try {
            return cache.get(key);  // å¤šä¸ªè¯»æ“ä½œå¯ä»¥å¹¶å‘
        } finally {
            readLock.unlock();
        }
    }
    
    public void setValue(String key, String value) {
        writeLock.lock();
        try {
            cache.put(key, value);  // å†™æ“ä½œç‹¬å 
        } finally {
            writeLock.unlock();
        }
    }
    
    // è¯»å†™é”å‡çº§ç¤ºä¾‹
    public void updateValue(String key, Function<String, String> updater) {
        readLock.lock();
        String oldValue;
        try {
            oldValue = cache.get(key);
        } finally {
            readLock.unlock();
        }
        
        if (oldValue != null) {
            writeLock.lock();
            try {
                // åŒé‡æ£€æŸ¥ï¼Œé˜²æ­¢å…¶ä»–çº¿ç¨‹å·²ç»ä¿®æ”¹
                String currentValue = cache.get(key);
                if (Objects.equals(currentValue, oldValue)) {
                    cache.put(key, updater.apply(oldValue));
                }
            } finally {
                writeLock.unlock();
            }
        }
    }
}
```

**4. ä½¿ç”¨æ— é”æ•°æ®ç»“æ„**
```java
public class LockFreeExamples {
    
    // åŸå­ç±»æ›¿ä»£é”
    private final AtomicInteger counter = new AtomicInteger(0);
    private final AtomicReference<String> atomicString = new AtomicReference<>();
    
    public int incrementAndGet() {
        return counter.incrementAndGet();  // æ— é”æ“ä½œ
    }
    
    public boolean compareAndSetString(String expected, String update) {
        return atomicString.compareAndSet(expected, update);
    }
    
    // æ— é”é˜Ÿåˆ—
    private final ConcurrentLinkedQueue<String> queue = new ConcurrentLinkedQueue<>();
    
    public void offer(String item) {
        queue.offer(item);  // æ— é”æ“ä½œ
    }
    
    public String poll() {
        return queue.poll();  // æ— é”æ“ä½œ
    }
    
    // æ— é”Map
    private final ConcurrentHashMap<String, String> map = new ConcurrentHashMap<>();
    
    public String putIfAbsent(String key, String value) {
        return map.putIfAbsent(key, value);  // åŸå­æ“ä½œ
    }
    
    // ä½¿ç”¨LongAdderæ›¿ä»£AtomicLong
    private final LongAdder adder = new LongAdder();
    
    public void increment() {
        adder.increment();  // åˆ†æ®µç´¯åŠ ï¼Œå‡å°‘ç«äº‰
    }
    
    public long sum() {
        return adder.sum();
    }
}
```

**5. é”è¶…æ—¶å’Œå¯ä¸­æ–­é”**
```java
public class TimeoutLockExample {
    private final ReentrantLock lock = new ReentrantLock();
    
    public boolean tryWithTimeout(long timeout, TimeUnit unit) {
        try {
            if (lock.tryLock(timeout, unit)) {
                try {
                    // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
                    return processWithTimeout();
                } finally {
                    lock.unlock();
                }
            } else {
                // è·å–é”è¶…æ—¶ï¼Œè¿”å›å¤±è´¥
                return false;
            }
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
            return false;
        }
    }
    
    public void interruptibleLock() throws InterruptedException {
        lock.lockInterruptibly();  // å¯è¢«ä¸­æ–­çš„é”
        try {
            // ä¸šåŠ¡é€»è¾‘
        } finally {
            lock.unlock();
        }
    }
    
    // éé˜»å¡å°è¯•è·å–é”
    public boolean tryNonBlocking() {
        if (lock.tryLock()) {  // ç«‹å³è¿”å›ï¼Œä¸é˜»å¡
            try {
                // æ‰§è¡Œå¿«é€Ÿæ“ä½œ
                return true;
            } finally {
                lock.unlock();
            }
        }
        return false;
    }
}
```

**6. å‡å°‘é”çš„æŒæœ‰æ—¶é—´**
```java
public class ReduceLockHoldTime {
    private final Object lock = new Object();
    private List<String> list = new ArrayList<>();
    
    // ä¼˜åŒ–å‰ï¼šé”æŒæœ‰æ—¶é—´é•¿
    public void inefficient(String item) {
        synchronized (lock) {
            // è€—æ—¶çš„è®¡ç®—åœ¨é”å†…è¿›è¡Œ
            String processedItem = expensiveComputation(item);
            list.add(processedItem);
            
            // è€—æ—¶çš„I/Oæ“ä½œä¹Ÿåœ¨é”å†…
            saveToDatabase(processedItem);
        }
    }
    
    // ä¼˜åŒ–åï¼šç¼©çŸ­é”æŒæœ‰æ—¶é—´
    public void efficient(String item) {
        // è€—æ—¶æ“ä½œç§»å‡ºé”å¤–
        String processedItem = expensiveComputation(item);
        
        synchronized (lock) {
            // åªåœ¨å¿…è¦æ—¶ä½¿ç”¨é”
            list.add(processedItem);
        }
        
        // I/Oæ“ä½œç§»å‡ºé”å¤–
        saveToDatabase(processedItem);
    }
    
    // æ‰¹é‡æ“ä½œä¼˜åŒ–
    public void batchOperation(List<String> items) {
        List<String> processedItems = new ArrayList<>();
        
        // æ‰¹é‡å¤„ç†ç§»å‡ºé”å¤–
        for (String item : items) {
            processedItems.add(expensiveComputation(item));
        }
        
        synchronized (lock) {
            // æ‰¹é‡æ·»åŠ ï¼Œå‡å°‘é”è·å–æ¬¡æ•°
            list.addAll(processedItems);
        }
    }
}
```

**7. é”æ¶ˆé™¤å’Œé”ç²—åŒ–**
```java
public class LockOptimization {
    
    // JVMä¼šè¿›è¡Œé”æ¶ˆé™¤
    public String lockElimination() {
        StringBuffer sb = new StringBuffer();  // å±€éƒ¨å˜é‡
        sb.append("Hello");  // è™½ç„¶StringBufferæ˜¯åŒæ­¥çš„
        sb.append(" World"); // ä½†JVMä¼šæ¶ˆé™¤è¿™äº›é”
        return sb.toString();
    }
    
    // æ‰‹åŠ¨é”ç²—åŒ–
    public void manualLockCoarsening() {
        synchronized (this) {
            // å°†å¤šä¸ªåŒæ­¥å—åˆå¹¶
            operation1();
            operation2();
            operation3();
        }
    }
    
    // é¿å…é”ç²—åŒ–è¿‡åº¦
    public void avoidOverCoarsening() {
        synchronized (this) {
            quickOperation1();
            quickOperation2();
        }
        
        // è€—æ—¶æ“ä½œç§»å‡ºé”å¤–
        expensiveOperation();
        
        synchronized (this) {
            quickOperation3();
        }
    }
}
```

**8. ä½¿ç”¨å¹¶å‘å·¥å…·ç±»**
```java
public class ConcurrentUtilities {
    
    // ä½¿ç”¨CountDownLatchæ›¿ä»£wait/notify
    public void useCountDownLatch() throws InterruptedException {
        CountDownLatch latch = new CountDownLatch(3);
        
        for (int i = 0; i < 3; i++) {
            new Thread(() -> {
                try {
                    doWork();
                } finally {
                    latch.countDown();
                }
            }).start();
        }
        
        latch.await();  // æ¯”wait/notifyæ›´ç®€æ´
    }
    
    // ä½¿ç”¨Semaphoreæ§åˆ¶å¹¶å‘æ•°
    private final Semaphore semaphore = new Semaphore(5);
    
    public void limitedConcurrency() throws InterruptedException {
        semaphore.acquire();
        try {
            // æœ€å¤š5ä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œ
            performTask();
        } finally {
            semaphore.release();
        }
    }
    
    // ä½¿ç”¨CyclicBarrieråŒæ­¥å¤šçº¿ç¨‹
    private final CyclicBarrier barrier = new CyclicBarrier(3, () -> {
        System.out.println("All threads reached barrier");
    });
    
    public void synchronizeThreads() throws Exception {
        // æ‰§è¡Œç¬¬ä¸€é˜¶æ®µ
        doPhase1();
        
        // ç­‰å¾…å…¶ä»–çº¿ç¨‹å®Œæˆç¬¬ä¸€é˜¶æ®µ
        barrier.await();
        
        // æ‰§è¡Œç¬¬äºŒé˜¶æ®µ
        doPhase2();
    }
}
```

**9. é¿å…æ­»é”**
```java
public class DeadlockPrevention {
    private final Object lock1 = new Object();
    private final Object lock2 = new Object();
    
    // å›ºå®šé”é¡ºåºé¿å…æ­»é”
    private void transferMoney(Account from, Account to, int amount) {
        Account firstLock = from.getId() < to.getId() ? from : to;
        Account secondLock = from.getId() < to.getId() ? to : from;
        
        synchronized (firstLock) {
            synchronized (secondLock) {
                from.withdraw(amount);
                to.deposit(amount);
            }
        }
    }
    
    // ä½¿ç”¨tryLocké¿å…æ­»é”
    private final ReentrantLock lockA = new ReentrantLock();
    private final ReentrantLock lockB = new ReentrantLock();
    
    public boolean tryTransfer() {
        try {
            if (lockA.tryLock(1, TimeUnit.SECONDS)) {
                try {
                    if (lockB.tryLock(1, TimeUnit.SECONDS)) {
                        try {
                            // æ‰§è¡Œè½¬è´¦æ“ä½œ
                            return true;
                        } finally {
                            lockB.unlock();
                        }
                    }
                } finally {
                    lockA.unlock();
                }
            }
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
        return false;
    }
}
```

**10. æ€§èƒ½ç›‘æ§å’Œè°ƒä¼˜**
```java
public class LockPerformanceMonitor {
    private final ReentrantLock lock = new ReentrantLock();
    private final AtomicLong totalWaitTime = new AtomicLong();
    private final AtomicLong lockAcquisitions = new AtomicLong();
    
    public void monitoredOperation() {
        long startTime = System.nanoTime();
        
        lock.lock();
        try {
            long lockAcquiredTime = System.nanoTime();
            totalWaitTime.addAndGet(lockAcquiredTime - startTime);
            lockAcquisitions.incrementAndGet();
            
            // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
            performOperation();
        } finally {
            lock.unlock();
        }
    }
    
    public void printStatistics() {
        long acquisitions = lockAcquisitions.get();
        if (acquisitions > 0) {
            long avgWaitTime = totalWaitTime.get() / acquisitions;
            System.out.println("Average lock wait time: " + avgWaitTime + " ns");
            System.out.println("Lock queue length: " + lock.getQueueLength());
        }
    }
    
    // ä½¿ç”¨JMXç›‘æ§é”ä¿¡æ¯
    public void jmxMonitoring() {
        ThreadMXBean threadMX = ManagementFactory.getThreadMXBean();
        
        if (threadMX.isObjectMonitorUsageSupported()) {
            ThreadInfo[] infos = threadMX.dumpAllThreads(true, true);
            for (ThreadInfo info : infos) {
                MonitorInfo[] monitors = info.getLockedMonitors();
                if (monitors.length > 0) {
                    System.out.println("Thread " + info.getThreadName() + 
                                     " holds " + monitors.length + " monitors");
                }
            }
        }
    }
}
```

**æœ€ä½³å®è·µæ€»ç»“ï¼š**
- ä¼˜å…ˆä½¿ç”¨æ— é”æ•°æ®ç»“æ„
- åˆç†é€‰æ‹©é”çš„ç²’åº¦
- ç¼©çŸ­é”çš„æŒæœ‰æ—¶é—´
- ä½¿ç”¨è¯»å†™é”æé«˜å¹¶å‘åº¦
- é¿å…é”åµŒå¥—å’Œæ­»é”
- ä½¿ç”¨å¹¶å‘å·¥å…·ç±»ç®€åŒ–å¼€å‘
- ç›‘æ§é”çš„æ€§èƒ½æŒ‡æ ‡

</details>

### 152. Redis çš„ Pipeline åŠŸèƒ½æ˜¯ä»€ä¹ˆï¼Ÿ
<details>
<summary>å±•å¼€ <span class="badge badge--info">ä¸­ç­‰</span> <span class="badge badge--primary">VIP</span> <span class="badge badge--secondary">åç«¯</span> <span class="badge badge--secondary">Redis</span></summary>

**Pipelineç®€ä»‹ï¼š**
Redis Pipelineæ˜¯ä¸€ç§é€šè¿‡å‡å°‘ç½‘ç»œå¾€è¿”æ¬¡æ•°æ¥æé«˜æ€§èƒ½çš„æŠ€æœ¯ã€‚å®ƒå…è®¸å®¢æˆ·ç«¯ä¸€æ¬¡æ€§å‘é€å¤šä¸ªå‘½ä»¤ï¼Œç„¶åä¸€æ¬¡æ€§æ¥æ”¶æ‰€æœ‰å“åº”ã€‚

**å·¥ä½œåŸç†ï¼š**
```
ä¸ä½¿ç”¨Pipeline:
å®¢æˆ·ç«¯ -> å‘½ä»¤1 -> Redis -> å“åº”1 -> å®¢æˆ·ç«¯
å®¢æˆ·ç«¯ -> å‘½ä»¤2 -> Redis -> å“åº”2 -> å®¢æˆ·ç«¯
å®¢æˆ·ç«¯ -> å‘½ä»¤3 -> Redis -> å“åº”3 -> å®¢æˆ·ç«¯
æ€»æ—¶é—´: 3 * (ç½‘ç»œå»¶è¿Ÿ + å‘½ä»¤æ‰§è¡Œæ—¶é—´)

ä½¿ç”¨Pipeline:
å®¢æˆ·ç«¯ -> [å‘½ä»¤1, å‘½ä»¤2, å‘½ä»¤3] -> Redis -> [å“åº”1, å“åº”2, å“åº”3] -> å®¢æˆ·ç«¯
æ€»æ—¶é—´: 1 * ç½‘ç»œå»¶è¿Ÿ + 3 * å‘½ä»¤æ‰§è¡Œæ—¶é—´
```

**Javaå®ç°ç¤ºä¾‹ï¼š**

**1. Jedis Pipeline**
```java
@Component
public class JedisPipelineExample {
    
    @Autowired
    private JedisPool jedisPool;
    
    // ä¸ä½¿ç”¨Pipelineçš„æ–¹å¼
    public void withoutPipeline() {
        try (Jedis jedis = jedisPool.getResource()) {
            long startTime = System.currentTimeMillis();
            
            for (int i = 0; i < 1000; i++) {
                jedis.set("key" + i, "value" + i);
                jedis.get("key" + i);
            }
            
            long endTime = System.currentTimeMillis();
            System.out.println("Without pipeline: " + (endTime - startTime) + "ms");
        }
    }
    
    // ä½¿ç”¨Pipelineçš„æ–¹å¼
    public void withPipeline() {
        try (Jedis jedis = jedisPool.getResource()) {
            long startTime = System.currentTimeMillis();
            
            Pipeline pipeline = jedis.pipelined();
            
            // æ‰¹é‡å‘é€å‘½ä»¤
            for (int i = 0; i < 1000; i++) {
                pipeline.set("key" + i, "value" + i);
                pipeline.get("key" + i);
            }
            
            // æ‰§è¡Œå¹¶è·å–æ‰€æœ‰å“åº”
            List<Object> results = pipeline.syncAndReturnAll();
            
            long endTime = System.currentTimeMillis();
            System.out.println("With pipeline: " + (endTime - startTime) + "ms");
            System.out.println("Results count: " + results.size());
        }
    }
    
    // åˆ†æ‰¹Pipelineå¤„ç†
    public void batchPipeline(List<String> keys, int batchSize) {
        try (Jedis jedis = jedisPool.getResource()) {
            for (int i = 0; i < keys.size(); i += batchSize) {
                Pipeline pipeline = jedis.pipelined();
                
                int endIndex = Math.min(i + batchSize, keys.size());
                for (int j = i; j < endIndex; j++) {
                    pipeline.get(keys.get(j));
                }
                
                List<Object> results = pipeline.syncAndReturnAll();
                processBatchResults(results);
            }
        }
    }
    
    private void processBatchResults(List<Object> results) {
        for (Object result : results) {
            if (result != null) {
                System.out.println("Value: " + result);
            }
        }
    }
}
```

**2. RedisTemplate Pipeline**
```java
@Component
public class RedisTemplatePipelineExample {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    public void pipelineWithRedisTemplate() {
        long startTime = System.currentTimeMillis();
        
        List<Object> results = redisTemplate.executePipelined(
            new RedisCallback<Object>() {
                @Override
                public Object doInRedis(RedisConnection connection) throws DataAccessException {
                    for (int i = 0; i < 1000; i++) {
                        connection.set(
                            ("key" + i).getBytes(), 
                            ("value" + i).getBytes()
                        );
                        connection.get(("key" + i).getBytes());
                    }
                    return null; // å¿…é¡»è¿”å›null
                }
            }
        );
        
        long endTime = System.currentTimeMillis();
        System.out.println("Pipeline execution time: " + (endTime - startTime) + "ms");
        System.out.println("Results size: " + results.size());
    }
    
    // ä½¿ç”¨StringRedisTemplate
    public void stringTemplatePipeline() {
        RedisTemplate<String, String> stringTemplate = 
            (RedisTemplate<String, String>) redisTemplate;
        
        List<Object> results = stringTemplate.executePipelined(
            (RedisCallback<Object>) connection -> {
                StringRedisConnection stringConn = (StringRedisConnection) connection;
                
                for (int i = 0; i < 100; i++) {
                    stringConn.set("user:" + i, "User" + i);
                    stringConn.expire("user:" + i, 3600);
                    stringConn.get("user:" + i);
                }
                
                return null;
            }
        );
        
        System.out.println("Pipeline results: " + results.size());
    }
}
```

**3. Lettuce Pipeline**
```java
@Component
public class LettucePipelineExample {
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    public void lettuceAsyncPipeline() {
        StatefulRedisConnection<String, String> connection = 
            (StatefulRedisConnection<String, String>) redisTemplate
                .getConnectionFactory().getConnection().getNativeConnection();
        
        RedisAsyncCommands<String, String> async = connection.async();
        
        // ç¦ç”¨è‡ªåŠ¨åˆ·æ–°ï¼Œå®ç°pipelineæ•ˆæœ
        async.setAutoFlushCommands(false);
        
        List<RedisFuture<String>> futures = new ArrayList<>();
        
        for (int i = 0; i < 1000; i++) {
            futures.add(async.set("async:key" + i, "value" + i));
            futures.add(async.get("async:key" + i));
        }
        
        // æ‰‹åŠ¨åˆ·æ–°ï¼Œå‘é€æ‰€æœ‰å‘½ä»¤
        async.flushCommands();
        
        // ç­‰å¾…æ‰€æœ‰å‘½ä»¤å®Œæˆ
        try {
            LettuceFutures.awaitAll(Duration.ofSeconds(10), 
                                   futures.toArray(new RedisFuture[0]));
        } catch (Exception e) {
            e.printStackTrace();
        }
        
        // é‡æ–°å¯ç”¨è‡ªåŠ¨åˆ·æ–°
        async.setAutoFlushCommands(true);
    }
}
```

**å®é™…åº”ç”¨åœºæ™¯ï¼š**

**1. æ‰¹é‡æ•°æ®æ“ä½œ**
```java
@Service
public class BatchDataService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    // æ‰¹é‡ç¼“å­˜ç”¨æˆ·æ•°æ®
    public void batchCacheUsers(List<User> users) {
        redisTemplate.executePipelined((RedisCallback<Object>) connection -> {
            for (User user : users) {
                String key = "user:" + user.getId();
                byte[] keyBytes = key.getBytes();
                byte[] valueBytes = serialize(user);
                
                connection.setEx(keyBytes, 3600, valueBytes);
                
                // åŒæ—¶è®¾ç½®ç”¨æˆ·åæ˜ å°„
                String nameKey = "user:name:" + user.getName();
                connection.setEx(nameKey.getBytes(), 3600, 
                               String.valueOf(user.getId()).getBytes());
            }
            return null;
        });
    }
    
    // æ‰¹é‡è·å–ç”¨æˆ·æ•°æ®
    public List<User> batchGetUsers(List<Long> userIds) {
        List<Object> results = redisTemplate.executePipelined(
            (RedisCallback<Object>) connection -> {
                for (Long userId : userIds) {
                    String key = "user:" + userId;
                    connection.get(key.getBytes());
                }
                return null;
            }
        );
        
        List<User> users = new ArrayList<>();
        for (Object result : results) {
            if (result != null) {
                users.add(deserialize((byte[]) result, User.class));
            }
        }
        
        return users;
    }
    
    private byte[] serialize(Object obj) {
        // åºåˆ—åŒ–å®ç°
        return null;
    }
    
    private <T> T deserialize(byte[] data, Class<T> clazz) {
        // ååºåˆ—åŒ–å®ç°
        return null;
    }
}
```

**2. åˆ†å¸ƒå¼è®¡æ•°å™¨**
```java
@Component
public class DistributedCounter {
    
    @Autowired
    private JedisPool jedisPool;
    
    public Map<String, Long> batchIncrement(List<String> counters) {
        Map<String, Long> results = new HashMap<>();
        
        try (Jedis jedis = jedisPool.getResource()) {
            Pipeline pipeline = jedis.pipelined();
            
            // æ‰¹é‡å¢åŠ è®¡æ•°å™¨
            List<Response<Long>> responses = new ArrayList<>();
            for (String counter : counters) {
                responses.add(pipeline.incr(counter));
            }
            
            pipeline.sync();
            
            // æ”¶é›†ç»“æœ
            for (int i = 0; i < counters.size(); i++) {
                results.put(counters.get(i), responses.get(i).get());
            }
        }
        
        return results;
    }
    
    // æ‰¹é‡è®¾ç½®è¿‡æœŸæ—¶é—´
    public void batchSetExpire(Map<String, Integer> keyExpires) {
        try (Jedis jedis = jedisPool.getResource()) {
            Pipeline pipeline = jedis.pipelined();
            
            for (Map.Entry<String, Integer> entry : keyExpires.entrySet()) {
                pipeline.expire(entry.getKey(), entry.getValue());
            }
            
            pipeline.sync();
        }
    }
}
```

**3. ç¼“å­˜é¢„çƒ­**
```java
@Component
public class CacheWarmupService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @Autowired
    private UserService userService;
    
    // æ‰¹é‡é¢„çƒ­ç”¨æˆ·ç¼“å­˜
    public void warmupUserCache(List<Long> userIds) {
        // åˆ†æ‰¹å¤„ç†ï¼Œé¿å…Pipelineè¿‡å¤§
        int batchSize = 100;
        
        for (int i = 0; i < userIds.size(); i += batchSize) {
            List<Long> batch = userIds.subList(i, 
                Math.min(i + batchSize, userIds.size()));
            
            warmupBatch(batch);
        }
    }
    
    private void warmupBatch(List<Long> userIds) {
        // æ‰¹é‡ä»æ•°æ®åº“è·å–ç”¨æˆ·ä¿¡æ¯
        List<User> users = userService.batchGetUsers(userIds);
        Map<Long, User> userMap = users.stream()
            .collect(Collectors.toMap(User::getId, Function.identity()));
        
        // ä½¿ç”¨Pipelineæ‰¹é‡å†™å…¥ç¼“å­˜
        redisTemplate.executePipelined((RedisCallback<Object>) connection -> {
            for (Long userId : userIds) {
                User user = userMap.get(userId);
                if (user != null) {
                    String key = "user:" + userId;
                    byte[] keyBytes = key.getBytes();
                    byte[] valueBytes = serialize(user);
                    
                    connection.setEx(keyBytes, 3600, valueBytes);
                    
                    // åŒæ—¶ç¼“å­˜ç”¨æˆ·çš„å…¶ä»–ä¿¡æ¯
                    String profileKey = "user:profile:" + userId;
                    connection.setEx(profileKey.getBytes(), 3600, 
                                   serialize(user.getProfile()));
                }
            }
            return null;
        });
    }
}
```

**æ€§èƒ½å¯¹æ¯”æµ‹è¯•ï¼š**
```java
@Component
public class PipelinePerformanceTest {
    
    @Autowired
    private JedisPool jedisPool;
    
    public void performanceComparison() {
        int operationCount = 10000;
        
        // æµ‹è¯•ä¸ä½¿ç”¨Pipeline
        long normalTime = testNormalOperations(operationCount);
        
        // æµ‹è¯•ä½¿ç”¨Pipeline
        long pipelineTime = testPipelineOperations(operationCount);
        
        System.out.println("Normal operations: " + normalTime + "ms");
        System.out.println("Pipeline operations: " + pipelineTime + "ms");
        System.out.println("Performance improvement: " + 
                          (normalTime / (double) pipelineTime) + "x");
    }
    
    private long testNormalOperations(int count) {
        long startTime = System.currentTimeMillis();
        
        try (Jedis jedis = jedisPool.getResource()) {
            for (int i = 0; i < count; i++) {
                jedis.set("normal:key" + i, "value" + i);
            }
        }
        
        return System.currentTimeMillis() - startTime;
    }
    
    private long testPipelineOperations(int count) {
        long startTime = System.currentTimeMillis();
        
        try (Jedis jedis = jedisPool.getResource()) {
            Pipeline pipeline = jedis.pipelined();
            
            for (int i = 0; i < count; i++) {
                pipeline.set("pipeline:key" + i, "value" + i);
            }
            
            pipeline.sync();
        }
        
        return System.currentTimeMillis() - startTime;
    }
}
```

**æ³¨æ„äº‹é¡¹ï¼š**

**1. å†…å­˜ä½¿ç”¨**
```java
// Pipelineä¼šåœ¨å®¢æˆ·ç«¯ç¼“å­˜å“åº”ï¼Œæ³¨æ„å†…å­˜ä½¿ç”¨
public void largePipelineHandling() {
    try (Jedis jedis = jedisPool.getResource()) {
        int maxBatchSize = 1000; // é™åˆ¶æ‰¹æ¬¡å¤§å°
        
        Pipeline pipeline = jedis.pipelined();
        int currentBatch = 0;
        
        for (int i = 0; i < 100000; i++) {
            pipeline.set("key" + i, "value" + i);
            currentBatch++;
            
            if (currentBatch >= maxBatchSize) {
                pipeline.sync();
                pipeline = jedis.pipelined(); // é‡æ–°åˆ›å»ºPipeline
                currentBatch = 0;
            }
        }
        
        if (currentBatch > 0) {
            pipeline.sync();
        }
    }
}
```

**2. é”™è¯¯å¤„ç†**
```java
public void pipelineErrorHandling() {
    try (Jedis jedis = jedisPool.getResource()) {
        Pipeline pipeline = jedis.pipelined();
        
        List<Response<String>> responses = new ArrayList<>();
        
        for (int i = 0; i < 100; i++) {
            responses.add(pipeline.set("key" + i, "value" + i));
        }
        
        pipeline.sync();
        
        // æ£€æŸ¥æ¯ä¸ªæ“ä½œçš„ç»“æœ
        for (int i = 0; i < responses.size(); i++) {
            try {
                String result = responses.get(i).get();
                // å¤„ç†æˆåŠŸç»“æœ
            } catch (Exception e) {
                System.err.println("Operation " + i + " failed: " + e.getMessage());
            }
        }
    }
}
```

**æœ€ä½³å®è·µï¼š**
- åˆç†æ§åˆ¶Pipelineå¤§å°ï¼ˆé€šå¸¸1000-10000ä¸ªå‘½ä»¤ï¼‰
- å¯¹äºå¤§é‡æ•°æ®æ“ä½œï¼Œåˆ†æ‰¹ä½¿ç”¨Pipeline
- æ³¨æ„å†…å­˜ä½¿ç”¨ï¼Œé¿å…Pipelineè¿‡å¤§
- åœ¨é«˜å»¶è¿Ÿç½‘ç»œç¯å¢ƒä¸‹æ•ˆæœæ›´æ˜æ˜¾
- ç»“åˆä¸šåŠ¡éœ€æ±‚é€‰æ‹©åˆé€‚çš„æ‰¹æ¬¡å¤§å°

</details>

### 153. è®©ä½ è®¾è®¡ä¸€ä¸ªåˆ†å¸ƒå¼ ID å‘å·å™¨ï¼Œæ€ä¹ˆè®¾è®¡ï¼Ÿ
<details>
<summary>å±•å¼€ <span class="badge badge--danger">å›°éš¾</span> <span class="badge badge--primary">VIP</span> <span class="badge badge--secondary">åç«¯</span> <span class="badge badge--secondary">ç³»ç»Ÿè®¾è®¡</span> <span class="badge badge--secondary">åœºæ™¯é¢˜</span></summary>

**åˆ†å¸ƒå¼IDè®¾è®¡è¦æ±‚ï¼š**
- **å”¯ä¸€æ€§**ï¼šå…¨å±€å”¯ä¸€ï¼Œä¸èƒ½é‡å¤
- **æœ‰åºæ€§**ï¼šè¶‹åŠ¿é€’å¢ï¼Œä¾¿äºæ•°æ®åº“ç´¢å¼•
- **é«˜æ€§èƒ½**ï¼šé«˜å¹¶å‘ä¸‹å¿«é€Ÿç”Ÿæˆ
- **é«˜å¯ç”¨**ï¼šç³»ç»Ÿæ•…éšœä¸å½±å“æœåŠ¡
- **å¯æ‰©å±•**ï¼šæ”¯æŒæ°´å¹³æ‰©å±•

**æ–¹æ¡ˆä¸€ï¼šé›ªèŠ±ç®—æ³•ï¼ˆSnowflakeï¼‰**

**ç®—æ³•ç»“æ„ï¼š**
```
64ä½IDç»“æ„:
| 1ä½ç¬¦å·ä½ | 41ä½æ—¶é—´æˆ³ | 10ä½æœºå™¨ID | 12ä½åºåˆ—å· |
|    0     |  æ—¶é—´å·®å€¼  | æœºå™¨æ ‡è¯†   |  é€’å¢åºåˆ—  |

- ç¬¦å·ä½ï¼šå›ºå®šä¸º0
- æ—¶é—´æˆ³ï¼šå½“å‰æ—¶é—´ä¸èµ·å§‹æ—¶é—´çš„å·®å€¼ï¼ˆæ¯«ç§’ï¼‰
- æœºå™¨IDï¼šæ•°æ®ä¸­å¿ƒID(5ä½) + å·¥ä½œæœºå™¨ID(5ä½)
- åºåˆ—å·ï¼šåŒä¸€æ¯«ç§’å†…çš„é€’å¢åºåˆ—
```

**Javaå®ç°ï¼š**
```java
@Component
public class SnowflakeIdGenerator {
    
    // èµ·å§‹æ—¶é—´æˆ³ (2020-01-01)
    private final long EPOCH = 1577836800000L;
    
    // æœºå™¨IDä½æ•°
    private final long WORKER_ID_BITS = 5L;
    private final long DATACENTER_ID_BITS = 5L;
    
    // åºåˆ—å·ä½æ•°
    private final long SEQUENCE_BITS = 12L;
    
    // æœ€å¤§å€¼è®¡ç®—
    private final long MAX_WORKER_ID = ~(-1L << WORKER_ID_BITS);
    private final long MAX_DATACENTER_ID = ~(-1L << DATACENTER_ID_BITS);
    private final long MAX_SEQUENCE = ~(-1L << SEQUENCE_BITS);
    
    // ä½ç§»åç§»
    private final long WORKER_ID_SHIFT = SEQUENCE_BITS;
    private final long DATACENTER_ID_SHIFT = SEQUENCE_BITS + WORKER_ID_BITS;
    private final long TIMESTAMP_SHIFT = SEQUENCE_BITS + WORKER_ID_BITS + DATACENTER_ID_BITS;
    
    private final long workerId;
    private final long datacenterId;
    private long sequence = 0L;
    private long lastTimestamp = -1L;
    
    public SnowflakeIdGenerator(long workerId, long datacenterId) {
        if (workerId > MAX_WORKER_ID || workerId < 0) {
            throw new IllegalArgumentException("Worker ID must be between 0 and " + MAX_WORKER_ID);
        }
        if (datacenterId > MAX_DATACENTER_ID || datacenterId < 0) {
            throw new IllegalArgumentException("Datacenter ID must be between 0 and " + MAX_DATACENTER_ID);
        }
        
        this.workerId = workerId;
        this.datacenterId = datacenterId;
    }
    
    public synchronized long nextId() {
        long timestamp = System.currentTimeMillis();
        
        // æ—¶é’Ÿå›æ‹¨æ£€æŸ¥
        if (timestamp < lastTimestamp) {
            throw new RuntimeException("Clock moved backwards. Refusing to generate id");
        }
        
        // åŒä¸€æ¯«ç§’å†…
        if (timestamp == lastTimestamp) {
            sequence = (sequence + 1) & MAX_SEQUENCE;
            
            // åºåˆ—å·æº¢å‡ºï¼Œç­‰å¾…ä¸‹ä¸€æ¯«ç§’
            if (sequence == 0) {
                timestamp = waitNextMillis(timestamp);
            }
        } else {
            // æ–°çš„æ¯«ç§’ï¼Œåºåˆ—å·é‡ç½®
            sequence = 0L;
        }
        
        lastTimestamp = timestamp;
        
        // ç»„è£…ID
        return ((timestamp - EPOCH) << TIMESTAMP_SHIFT) |
               (datacenterId << DATACENTER_ID_SHIFT) |
               (workerId << WORKER_ID_SHIFT) |
               sequence;
    }
    
    private long waitNextMillis(long lastTimestamp) {
        long timestamp = System.currentTimeMillis();
        while (timestamp <= lastTimestamp) {
            timestamp = System.currentTimeMillis();
        }
        return timestamp;
    }
    
    // IDè§£æ
    public IdInfo parseId(long id) {
        long timestamp = ((id >> TIMESTAMP_SHIFT) + EPOCH);
        long datacenterId = (id >> DATACENTER_ID_SHIFT) & MAX_DATACENTER_ID;
        long workerId = (id >> WORKER_ID_SHIFT) & MAX_WORKER_ID;
        long sequence = id & MAX_SEQUENCE;
        
        return new IdInfo(timestamp, datacenterId, workerId, sequence);
    }
    
    @Data
    public static class IdInfo {
        private final long timestamp;
        private final long datacenterId;
        private final long workerId;
        private final long sequence;
        
        public IdInfo(long timestamp, long datacenterId, long workerId, long sequence) {
            this.timestamp = timestamp;
            this.datacenterId = datacenterId;
            this.workerId = workerId;
            this.sequence = sequence;
        }
    }
}
```

**æ–¹æ¡ˆäºŒï¼šåŸºäºæ•°æ®åº“çš„å‘å·å™¨**

**æ•°æ®åº“è¡¨è®¾è®¡ï¼š**
```sql
CREATE TABLE id_generator (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    business_type VARCHAR(50) NOT NULL,
    max_id BIGINT NOT NULL DEFAULT 0,
    step INT NOT NULL DEFAULT 1000,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_business_type (business_type)
);

-- åˆå§‹åŒ–æ•°æ®
INSERT INTO id_generator (business_type, max_id, step) VALUES 
('user_id', 0, 1000),
('order_id', 0, 1000);
```

**Javaå®ç°ï¼š**
```java
@Component
public class DatabaseIdGenerator {
    
    @Autowired
    private JdbcTemplate jdbcTemplate;
    
    private final Map<String, IdSegment> segmentCache = new ConcurrentHashMap<>();
    private final ReentrantLock lock = new ReentrantLock();
    
    public long nextId(String businessType) {
        IdSegment segment = segmentCache.get(businessType);
        
        if (segment == null || segment.isExhausted()) {
            lock.lock();
            try {
                // åŒé‡æ£€æŸ¥
                segment = segmentCache.get(businessType);
                if (segment == null || segment.isExhausted()) {
                    segment = getNewSegment(businessType);
                    segmentCache.put(businessType, segment);
                }
            } finally {
                lock.unlock();
            }
        }
        
        return segment.nextId();
    }
    
    private IdSegment getNewSegment(String businessType) {
        String sql = "UPDATE id_generator SET max_id = max_id + step WHERE business_type = ?";
        
        int updated = jdbcTemplate.update(sql, businessType);
        if (updated == 0) {
            throw new RuntimeException("Business type not found: " + businessType);
        }
        
        String querySql = "SELECT max_id, step FROM id_generator WHERE business_type = ?";
        return jdbcTemplate.queryForObject(querySql, (rs, rowNum) -> {
            long maxId = rs.getLong("max_id");
            int step = rs.getInt("step");
            return new IdSegment(maxId - step + 1, maxId);
        }, businessType);
    }
    
    @Data
    private static class IdSegment {
        private final long start;
        private final long end;
        private final AtomicLong current;
        
        public IdSegment(long start, long end) {
            this.start = start;
            this.end = end;
            this.current = new AtomicLong(start - 1);
        }
        
        public long nextId() {
            long id = current.incrementAndGet();
            if (id > end) {
                throw new RuntimeException("Segment exhausted");
            }
            return id;
        }
        
        public boolean isExhausted() {
            return current.get() >= end;
        }
    }
}
```

**æ–¹æ¡ˆä¸‰ï¼šåŸºäºRedisçš„å‘å·å™¨**

```java
@Component
public class RedisIdGenerator {
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    // ç®€å•é€’å¢
    public long nextId(String businessType) {
        String key = "id_generator:" + businessType;
        return redisTemplate.opsForValue().increment(key);
    }
    
    // æ‰¹é‡è·å–IDæ®µ
    private static final String BATCH_ID_SCRIPT = 
        "local key = KEYS[1] " +
        "local step = tonumber(ARGV[1]) " +
        "local current = redis.call('GET', key) " +
        "if current == false then " +
        "    current = 0 " +
        "else " +
        "    current = tonumber(current) " +
        "end " +
        "local max = current + step " +
        "redis.call('SET', key, max) " +
        "return {current + 1, max}";
    
    public IdSegment getBatchIds(String businessType, int step) {
        String key = "id_generator:" + businessType;
        
        DefaultRedisScript<List> script = new DefaultRedisScript<>();
        script.setScriptText(BATCH_ID_SCRIPT);
        script.setResultType(List.class);
        
        List<Object> result = redisTemplate.execute(script,
                Collections.singletonList(key),
                String.valueOf(step));
        
        if (result != null && result.size() == 2) {
            long start = Long.parseLong(result.get(0).toString());
            long end = Long.parseLong(result.get(1).toString());
            return new IdSegment(start, end);
        }
        
        throw new RuntimeException("Failed to get batch IDs");
    }
    
    // å¸¦è¿‡æœŸæ—¶é—´çš„IDç”Ÿæˆ
    public String nextIdWithExpire(String businessType, long expireSeconds) {
        String key = "id_generator:" + businessType;
        String timeKey = key + ":time";
        
        // æ£€æŸ¥æ˜¯å¦éœ€è¦é‡ç½®
        String lastResetTime = redisTemplate.opsForValue().get(timeKey);
        long currentTime = System.currentTimeMillis() / 1000;
        
        if (lastResetTime == null || 
            currentTime - Long.parseLong(lastResetTime) > expireSeconds) {
            
            // é‡ç½®è®¡æ•°å™¨
            redisTemplate.opsForValue().set(key, "0");
            redisTemplate.opsForValue().set(timeKey, String.valueOf(currentTime));
        }
        
        long id = redisTemplate.opsForValue().increment(key);
        return String.format("%d_%06d", currentTime, id);
    }
}
```

**æ–¹æ¡ˆå››ï¼šåˆ†æ®µç¼“å­˜ä¼˜åŒ–**

```java
@Component
public class SegmentIdGenerator {
    
    private final Map<String, DoubleBuffer> bufferMap = new ConcurrentHashMap<>();
    private final ScheduledExecutorService scheduler = Executors.newScheduledThreadPool(5);
    
    @Autowired
    private DatabaseIdGenerator databaseGenerator;
    
    public long nextId(String businessType) {
        DoubleBuffer buffer = bufferMap.computeIfAbsent(businessType, 
            k -> new DoubleBuffer(businessType));
        
        return buffer.nextId();
    }
    
    private class DoubleBuffer {
        private final String businessType;
        private volatile IdSegment currentSegment;
        private volatile IdSegment nextSegment;
        private volatile boolean isLoadingNext = false;
        
        public DoubleBuffer(String businessType) {
            this.businessType = businessType;
            this.currentSegment = loadNewSegment();
        }
        
        public long nextId() {
            // å½“å‰æ®µä½¿ç”¨ç‡è¶…è¿‡75%æ—¶ï¼Œå¼‚æ­¥åŠ è½½ä¸‹ä¸€æ®µ
            if (currentSegment.getUsagePercent() > 0.75 && 
                nextSegment == null && !isLoadingNext) {
                
                synchronized (this) {
                    if (nextSegment == null && !isLoadingNext) {
                        isLoadingNext = true;
                        scheduler.submit(this::loadNextSegment);
                    }
                }
            }
            
            long id = currentSegment.nextId();
            
            // å½“å‰æ®µç”¨å®Œï¼Œåˆ‡æ¢åˆ°ä¸‹ä¸€æ®µ
            if (currentSegment.isExhausted()) {
                synchronized (this) {
                    if (currentSegment.isExhausted()) {
                        if (nextSegment != null) {
                            currentSegment = nextSegment;
                            nextSegment = null;
                            isLoadingNext = false;
                        } else {
                            // ç´§æ€¥åŠ è½½æ–°æ®µ
                            currentSegment = loadNewSegment();
                        }
                    }
                }
            }
            
            return id;
        }
        
        private void loadNextSegment() {
            try {
                nextSegment = loadNewSegment();
            } catch (Exception e) {
                log.error("Failed to load next segment for " + businessType, e);
            } finally {
                isLoadingNext = false;
            }
        }
        
        private IdSegment loadNewSegment() {
            return databaseGenerator.getNewSegment(businessType);
        }
    }
}
```

**æ–¹æ¡ˆäº”ï¼šç¾å›¢Leafæ–¹æ¡ˆ**

```java
@Component
public class LeafIdGenerator {
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    private final Map<String, LeafSegment> segmentMap = new ConcurrentHashMap<>();
    
    // Leaf-segmentæ–¹æ¡ˆ
    public long nextId(String businessType) {
        LeafSegment segment = segmentMap.computeIfAbsent(businessType, 
            this::createLeafSegment);
        
        return segment.nextId();
    }
    
    private LeafSegment createLeafSegment(String businessType) {
        return new LeafSegment(businessType, redisTemplate);
    }
    
    private static class LeafSegment {
        private final String businessType;
        private final RedisTemplate<String, String> redisTemplate;
        private volatile Segment currentSegment;
        private volatile Segment nextSegment;
        private final ReentrantLock lock = new ReentrantLock();
        
        public LeafSegment(String businessType, RedisTemplate<String, String> redisTemplate) {
            this.businessType = businessType;
            this.redisTemplate = redisTemplate;
            this.currentSegment = getNewSegment();
        }
        
        public long nextId() {
            if (currentSegment.getUsagePercent() > 0.9 && nextSegment == null) {
                lock.lock();
                try {
                    if (nextSegment == null) {
                        nextSegment = getNewSegment();
                    }
                } finally {
                    lock.unlock();
                }
            }
            
            long id = currentSegment.nextId();
            
            if (currentSegment.isExhausted()) {
                lock.lock();
                try {
                    if (currentSegment.isExhausted()) {
                        currentSegment = nextSegment != null ? nextSegment : getNewSegment();
                        nextSegment = null;
                    }
                } finally {
                    lock.unlock();
                }
            }
            
            return id;
        }
        
        private Segment getNewSegment() {
            // åŸºäºRedisçš„åˆ†æ®µè·å–é€»è¾‘
            String key = "leaf:segment:" + businessType;
            Long start = redisTemplate.opsForValue().increment(key, 1000);
            return new Segment(start - 999, start);
        }
    }
}
```

**æ€§èƒ½æµ‹è¯•å’Œç›‘æ§ï¼š**

```java
@Component
public class IdGeneratorBenchmark {
    
    @Autowired
    private SnowflakeIdGenerator snowflakeGenerator;
    
    @Autowired
    private DatabaseIdGenerator databaseGenerator;
    
    @Autowired
    private RedisIdGenerator redisGenerator;
    
    public void performanceBenchmark() {
        int threadCount = 10;
        int operationsPerThread = 100000;
        
        // æµ‹è¯•Snowflake
        long snowflakeTime = testGenerator("Snowflake", 
            () -> snowflakeGenerator.nextId(), threadCount, operationsPerThread);
        
        // æµ‹è¯•Database
        long databaseTime = testGenerator("Database", 
            () -> databaseGenerator.nextId("test"), threadCount, operationsPerThread);
        
        // æµ‹è¯•Redis
        long redisTime = testGenerator("Redis", 
            () -> redisGenerator.nextId("test"), threadCount, operationsPerThread);
        
        System.out.println("Snowflake QPS: " + calculateQPS(snowflakeTime, threadCount, operationsPerThread));
        System.out.println("Database QPS: " + calculateQPS(databaseTime, threadCount, operationsPerThread));
        System.out.println("Redis QPS: " + calculateQPS(redisTime, threadCount, operationsPerThread));
    }
    
    private long testGenerator(String name, Supplier<Long> generator, 
                              int threadCount, int operationsPerThread) {
        CountDownLatch latch = new CountDownLatch(threadCount);
        long startTime = System.currentTimeMillis();
        
        for (int i = 0; i < threadCount; i++) {
            new Thread(() -> {
                try {
                    for (int j = 0; j < operationsPerThread; j++) {
                        generator.get();
                    }
                } finally {
                    latch.countDown();
                }
            }).start();
        }
        
        try {
            latch.await();
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
        
        long endTime = System.currentTimeMillis();
        System.out.println(name + " execution time: " + (endTime - startTime) + "ms");
        
        return endTime - startTime;
    }
    
    private long calculateQPS(long timeMs, int threadCount, int operationsPerThread) {
        long totalOperations = (long) threadCount * operationsPerThread;
        return totalOperations * 1000 / timeMs;
    }
}
```

**æ–¹æ¡ˆé€‰æ‹©å»ºè®®ï¼š**

| æ–¹æ¡ˆ | QPS | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|-----|------|------|----------|
| Snowflake | >100ä¸‡ | æ€§èƒ½é«˜ï¼Œæ— ä¾èµ– | æ—¶é’Ÿå›æ‹¨é—®é¢˜ | é«˜å¹¶å‘ç³»ç»Ÿ |
| æ•°æ®åº“ | <1ä¸‡ | ç®€å•å¯é  | æ€§èƒ½ä½ï¼Œå•ç‚¹ | å°è§„æ¨¡ç³»ç»Ÿ |
| Redis | 10-50ä¸‡ | é«˜æ€§èƒ½ï¼Œæ”¯æŒé›†ç¾¤ | ä¾èµ–Redis | ä¸­å¤§å‹ç³»ç»Ÿ |
| åˆ†æ®µç¼“å­˜ | 50-100ä¸‡ | é«˜æ€§èƒ½ï¼Œé™çº§èƒ½åŠ› | å¤æ‚åº¦é«˜ | å¤§å‹ç³»ç»Ÿ |

</details>

### 154. ä»€ä¹ˆæ˜¯æœåŠ¡é›ªå´©ï¼Ÿ
<details>
<summary>å±•å¼€ <span class="badge badge--success">ç®€å•</span> <span class="badge badge--primary">VIP</span> <span class="badge badge--secondary">æœåŠ¡å®¹ç¾</span> <span class="badge badge--secondary">Spring Cloud</span> <span class="badge badge--secondary">å¾®æœåŠ¡</span> <span class="badge badge--secondary">åç«¯</span></summary>

**æœåŠ¡é›ªå´©å®šä¹‰ï¼š**
æœåŠ¡é›ªå´©æ˜¯æŒ‡åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œå½“ä¸€ä¸ªæœåŠ¡å‘ç”Ÿæ•…éšœæ—¶ï¼Œä¼šå¯¼è‡´ä¾èµ–å®ƒçš„å…¶ä»–æœåŠ¡ä¹Ÿå‘ç”Ÿæ•…éšœï¼Œè¿›è€Œå¼•å‘è¿é”ååº”ï¼Œæœ€ç»ˆå¯¼è‡´æ•´ä¸ªç³»ç»Ÿå´©æºƒçš„ç°è±¡ã€‚

**é›ªå´©äº§ç”Ÿçš„åŸå› ï¼š**

**1. æœåŠ¡ä¾èµ–é“¾è¿‡é•¿**
```
ç”¨æˆ·è¯·æ±‚ -> æœåŠ¡A -> æœåŠ¡B -> æœåŠ¡C -> æ•°æ®åº“
                â†“
            æœåŠ¡Cæ•…éšœ
                â†“
        æœåŠ¡Bç­‰å¾…è¶…æ—¶
                â†“
        æœåŠ¡Aç­‰å¾…è¶…æ—¶
                â†“
         æ•´ä¸ªé“¾è·¯é˜»å¡
```

**2. èµ„æºè€—å°½**
```java
// çº¿ç¨‹æ± è€—å°½ç¤ºä¾‹
@Service
public class UserService {
    
    // å›ºå®šå¤§å°çº¿ç¨‹æ± 
    private final ExecutorService executor = Executors.newFixedThreadPool(10);
    
    public User getUserInfo(Long userId) {
        // è°ƒç”¨ä¸‹æ¸¸æœåŠ¡è·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
        CompletableFuture<UserBasic> basicFuture = CompletableFuture.supplyAsync(() -> {
            return userBasicService.getBasic(userId); // å‡è®¾è¿™ä¸ªæœåŠ¡å“åº”ç¼“æ…¢
        }, executor);
        
        // è°ƒç”¨ä¸‹æ¸¸æœåŠ¡è·å–ç”¨æˆ·æ‰©å±•ä¿¡æ¯
        CompletableFuture<UserExtra> extraFuture = CompletableFuture.supplyAsync(() -> {
            return userExtraService.getExtra(userId); // è¿™ä¸ªæœåŠ¡ä¹Ÿå“åº”ç¼“æ…¢
        }, executor);
        
        try {
            UserBasic basic = basicFuture.get(5, TimeUnit.SECONDS);
            UserExtra extra = extraFuture.get(5, TimeUnit.SECONDS);
            return buildUser(basic, extra);
        } catch (Exception e) {
            // å¦‚æœä¸‹æ¸¸æœåŠ¡ä¸€ç›´ä¸å“åº”ï¼Œçº¿ç¨‹æ± ä¼šè¢«è€—å°½
            throw new ServiceException("Get user info failed", e);
        }
    }
}
```

**3. ç¼“å­˜å‡»ç©¿**
```java
@Service
public class ProductService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @Autowired
    private ProductRepository productRepository;
    
    public Product getProduct(Long productId) {
        String key = "product:" + productId;
        
        // ä»ç¼“å­˜è·å–
        Product product = (Product) redisTemplate.opsForValue().get(key);
        if (product != null) {
            return product;
        }
        
        // ç¼“å­˜å¤±æ•ˆï¼Œå¤§é‡è¯·æ±‚æ‰“åˆ°æ•°æ®åº“
        product = productRepository.findById(productId);
        
        if (product != null) {
            // è®¾ç½®ç¼“å­˜
            redisTemplate.opsForValue().set(key, product, 30, TimeUnit.MINUTES);
        }
        
        return product;
    }
}
```

**é›ªå´©çš„å½±å“ï¼š**

**1. ç³»ç»Ÿå“åº”æ—¶é—´æ€¥å‰§å¢åŠ **
```java
// æ¨¡æ‹Ÿé›ªå´©æ•ˆåº”
@RestController
public class OrderController {
    
    @Autowired
    private UserService userService;
    
    @Autowired
    private ProductService productService;
    
    @Autowired
    private InventoryService inventoryService;
    
    @PostMapping("/orders")
    public ResponseEntity<Order> createOrder(@RequestBody OrderRequest request) {
        long startTime = System.currentTimeMillis();
        
        try {
            // æ­¥éª¤1ï¼šéªŒè¯ç”¨æˆ· (å‡è®¾ç”¨æˆ·æœåŠ¡æ­£å¸¸)
            User user = userService.getUser(request.getUserId());
            
            // æ­¥éª¤2ï¼šè·å–å•†å“ä¿¡æ¯ (å‡è®¾å•†å“æœåŠ¡æ•…éšœ)
            Product product = productService.getProduct(request.getProductId());
            
            // æ­¥éª¤3ï¼šæ£€æŸ¥åº“å­˜ (ç”±äºæ­¥éª¤2é˜»å¡ï¼Œè¿™æ­¥æ— æ³•æ‰§è¡Œ)
            boolean hasStock = inventoryService.checkStock(request.getProductId(), request.getQuantity());
            
            // åˆ›å»ºè®¢å•
            Order order = createOrderInternal(user, product, request);
            
            return ResponseEntity.ok(order);
            
        } catch (Exception e) {
            long endTime = System.currentTimeMillis();
            log.error("Create order failed, cost: {}ms", endTime - startTime, e);
            
            // å“åº”æ—¶é—´ä»æ­£å¸¸çš„100mså¢åŠ åˆ°5000msç”šè‡³æ›´å¤š
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).build();
        }
    }
}
```

**2. ç³»ç»Ÿèµ„æºæ¶ˆè€—æ¿€å¢**
```java
// ç›‘æ§ç³»ç»Ÿèµ„æº
@Component
public class SystemMonitor {
    
    private final MeterRegistry meterRegistry;
    
    public SystemMonitor(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
    }
    
    @EventListener
    public void handleServiceCall(ServiceCallEvent event) {
        // è®°å½•æœåŠ¡è°ƒç”¨æŒ‡æ ‡
        Timer.Sample sample = Timer.start(meterRegistry);
        
        try {
            // ä¸šåŠ¡é€»è¾‘
        } finally {
            sample.stop(Timer.builder("service.call")
                    .tag("service", event.getServiceName())
                    .tag("status", event.getStatus())
                    .register(meterRegistry));
        }
        
        // ç›‘æ§çº¿ç¨‹æ± çŠ¶æ€
        ThreadPoolTaskExecutor executor = getExecutor();
        Gauge.builder("thread.pool.active")
                .register(meterRegistry, executor, ThreadPoolTaskExecutor::getActiveCount);
        
        Gauge.builder("thread.pool.queue.size")
                .register(meterRegistry, executor, e -> e.getThreadPoolExecutor().getQueue().size());
    }
}
```

**é¢„é˜²æœåŠ¡é›ªå´©çš„ç­–ç•¥ï¼š**

**1. æœåŠ¡ç†”æ–­ï¼ˆCircuit Breakerï¼‰**
```java
@Component
public class CircuitBreakerService {
    
    private final CircuitBreaker circuitBreaker;
    
    public CircuitBreakerService() {
        this.circuitBreaker = CircuitBreaker.ofDefaults("userService");
        
        // é…ç½®ç†”æ–­å™¨
        circuitBreaker.getEventPublisher()
                .onStateTransition(event -> 
                    log.info("Circuit breaker state transition: {}", event));
    }
    
    public User getUser(Long userId) {
        Supplier<User> decoratedSupplier = CircuitBreaker
                .decorateSupplier(circuitBreaker, () -> {
                    return userServiceClient.getUser(userId);
                });
        
        try {
            return decoratedSupplier.get();
        } catch (CallNotPermittedException e) {
            // ç†”æ–­å™¨å¼€å¯ï¼Œè¿”å›é»˜è®¤å€¼æˆ–ç¼“å­˜æ•°æ®
            return getDefaultUser(userId);
        }
    }
    
    private User getDefaultUser(Long userId) {
        // è¿”å›é»˜è®¤ç”¨æˆ·ä¿¡æ¯æˆ–ä»ç¼“å­˜è·å–
        return User.builder()
                .id(userId)
                .name("é»˜è®¤ç”¨æˆ·")
                .status("UNKNOWN")
                .build();
    }
}
```

**2. æœåŠ¡é™æµï¼ˆRate Limitingï¼‰**
```java
@Component
public class RateLimiterService {
    
    private final RateLimiter rateLimiter;
    
    public RateLimiterService() {
        // åˆ›å»ºé™æµå™¨ï¼šæ¯ç§’æœ€å¤š100ä¸ªè¯·æ±‚
        this.rateLimiter = RateLimiter.create(100.0);
    }
    
    @PostMapping("/api/orders")
    public ResponseEntity<?> createOrder(@RequestBody OrderRequest request) {
        // å°è¯•è·å–è®¸å¯
        if (!rateLimiter.tryAcquire(1, TimeUnit.SECONDS)) {
            return ResponseEntity.status(HttpStatus.TOO_MANY_REQUESTS)
                    .body("è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•");
        }
        
        try {
            Order order = orderService.createOrder(request);
            return ResponseEntity.ok(order);
        } catch (Exception e) {
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                    .body("è®¢å•åˆ›å»ºå¤±è´¥");
        }
    }
}
```

**3. æœåŠ¡é™çº§ï¼ˆFallbackï¼‰**
```java
@Service
public class RecommendationService {
    
    @Autowired
    private RecommendationClient recommendationClient;
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    public List<Product> getRecommendations(Long userId) {
        try {
            // å°è¯•è°ƒç”¨æ¨èæœåŠ¡
            return recommendationClient.getRecommendations(userId);
        } catch (Exception e) {
            log.warn("æ¨èæœåŠ¡è°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨é™çº§ç­–ç•¥", e);
            return getFallbackRecommendations(userId);
        }
    }
    
    private List<Product> getFallbackRecommendations(Long userId) {
        // é™çº§ç­–ç•¥1ï¼šä»ç¼“å­˜è·å–
        String cacheKey = "recommendations:fallback:" + userId;
        List<Product> cached = (List<Product>) redisTemplate.opsForValue().get(cacheKey);
        if (cached != null) {
            return cached;
        }
        
        // é™çº§ç­–ç•¥2ï¼šè¿”å›çƒ­é—¨å•†å“
        List<Product> hotProducts = getHotProducts();
        
        // ç¼“å­˜é™çº§ç»“æœ
        redisTemplate.opsForValue().set(cacheKey, hotProducts, 10, TimeUnit.MINUTES);
        
        return hotProducts;
    }
    
    private List<Product> getHotProducts() {
        // è¿”å›é¢„è®¾çš„çƒ­é—¨å•†å“åˆ—è¡¨
        return Arrays.asList(
            Product.builder().id(1L).name("çƒ­é—¨å•†å“1").build(),
            Product.builder().id(2L).name("çƒ­é—¨å•†å“2").build(),
            Product.builder().id(3L).name("çƒ­é—¨å•†å“3").build()
        );
    }
}
```

**4. çº¿ç¨‹æ± éš”ç¦»**
```java
@Configuration
public class ThreadPoolConfig {
    
    // ç”¨æˆ·æœåŠ¡çº¿ç¨‹æ± 
    @Bean("userServiceExecutor")
    public ThreadPoolTaskExecutor userServiceExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(10);
        executor.setMaxPoolSize(20);
        executor.setQueueCapacity(100);
        executor.setThreadNamePrefix("user-service-");
        executor.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy());
        executor.initialize();
        return executor;
    }
    
    // è®¢å•æœåŠ¡çº¿ç¨‹æ± 
    @Bean("orderServiceExecutor")
    public ThreadPoolTaskExecutor orderServiceExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(15);
        executor.setMaxPoolSize(30);
        executor.setQueueCapacity(200);
        executor.setThreadNamePrefix("order-service-");
        executor.setRejectedExecutionHandler(new ThreadPoolExecutor.AbortPolicy());
        executor.initialize();
        return executor;
    }
}

@Service
public class IsolatedService {
    
    @Autowired
    @Qualifier("userServiceExecutor")
    private ThreadPoolTaskExecutor userServiceExecutor;
    
    @Autowired
    @Qualifier("orderServiceExecutor")
    private ThreadPoolTaskExecutor orderServiceExecutor;
    
    public CompletableFuture<User> getUserAsync(Long userId) {
        return CompletableFuture.supplyAsync(() -> {
            return userService.getUser(userId);
        }, userServiceExecutor);
    }
    
    public CompletableFuture<Order> createOrderAsync(OrderRequest request) {
        return CompletableFuture.supplyAsync(() -> {
            return orderService.createOrder(request);
        }, orderServiceExecutor);
    }
}
```

**5. è¶…æ—¶æ§åˆ¶**
```java
@Component
public class TimeoutService {
    
    @Async
    @Retryable(value = {Exception.class}, maxAttempts = 3, backoff = @Backoff(delay = 1000))
    public CompletableFuture<String> callExternalService(String request) {
        return CompletableFuture.supplyAsync(() -> {
            try {
                // è®¾ç½®è¶…æ—¶æ—¶é—´
                return restTemplate.exchange(
                    "http://external-service/api",
                    HttpMethod.POST,
                    new HttpEntity<>(request),
                    String.class
                ).getBody();
            } catch (Exception e) {
                throw new ServiceException("External service call failed", e);
            }
        }).orTimeout(3, TimeUnit.SECONDS) // 3ç§’è¶…æ—¶
          .exceptionally(throwable -> {
              log.error("Service call timeout or failed", throwable);
              return "DEFAULT_RESPONSE";
          });
    }
}
```

**6. ç¼“å­˜ç­–ç•¥**
```java
@Service
public class CacheService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    // å¤šçº§ç¼“å­˜
    public Product getProduct(Long productId) {
        String key = "product:" + productId;
        
        // L1ç¼“å­˜ï¼šæœ¬åœ°ç¼“å­˜
        Product product = localCache.get(key);
        if (product != null) {
            return product;
        }
        
        // L2ç¼“å­˜ï¼šRedisç¼“å­˜
        product = (Product) redisTemplate.opsForValue().get(key);
        if (product != null) {
            localCache.put(key, product, 5, TimeUnit.MINUTES);
            return product;
        }
        
        // ç¼“å­˜ç©¿é€ä¿æŠ¤
        try {
            product = productRepository.findById(productId);
            if (product != null) {
                // å†™å…¥å¤šçº§ç¼“å­˜
                redisTemplate.opsForValue().set(key, product, 30, TimeUnit.MINUTES);
                localCache.put(key, product, 5, TimeUnit.MINUTES);
            } else {
                // ç©ºå€¼ç¼“å­˜ï¼Œé˜²æ­¢ç¼“å­˜ç©¿é€
                redisTemplate.opsForValue().set(key, "NULL", 5, TimeUnit.MINUTES);
            }
        } catch (Exception e) {
            // æ•°æ®åº“å¼‚å¸¸æ—¶ï¼Œè¿”å›é»˜è®¤å€¼
            return getDefaultProduct(productId);
        }
        
        return product;
    }
}
```

**ç›‘æ§å’Œå‘Šè­¦ï¼š**
```java
@Component
public class AvalancheMonitor {
    
    private final MeterRegistry meterRegistry;
    private final AlertService alertService;
    
    // ç›‘æ§æœåŠ¡è°ƒç”¨å¤±è´¥ç‡
    @EventListener
    public void onServiceCallFailed(ServiceCallFailedEvent event) {
        Counter.builder("service.call.failed")
                .tag("service", event.getServiceName())
                .tag("error", event.getErrorType())
                .register(meterRegistry)
                .increment();
        
        // æ£€æŸ¥å¤±è´¥ç‡æ˜¯å¦è¶…è¿‡é˜ˆå€¼
        double failureRate = calculateFailureRate(event.getServiceName());
        if (failureRate > 0.5) { // å¤±è´¥ç‡è¶…è¿‡50%
            alertService.sendAlert("æœåŠ¡é›ªå´©é¢„è­¦", 
                String.format("æœåŠ¡ %s å¤±è´¥ç‡è¾¾åˆ° %.2f%%", event.getServiceName(), failureRate * 100));
        }
    }
    
    // ç›‘æ§å“åº”æ—¶é—´
    @EventListener
    public void onServiceCallCompleted(ServiceCallCompletedEvent event) {
        Timer.Sample sample = Timer.start(meterRegistry);
        sample.stop(Timer.builder("service.call.duration")
                .tag("service", event.getServiceName())
                .register(meterRegistry));
        
        // æ£€æŸ¥å“åº”æ—¶é—´æ˜¯å¦å¼‚å¸¸
        if (event.getDuration().toMillis() > 5000) { // è¶…è¿‡5ç§’
            alertService.sendAlert("æœåŠ¡å“åº”ç¼“æ…¢", 
                String.format("æœåŠ¡ %s å“åº”æ—¶é—´ %d ms", event.getServiceName(), event.getDuration().toMillis()));
        }
    }
}
```

**æœ€ä½³å®è·µï¼š**
1. **è®¾è®¡æ—¶è€ƒè™‘æ•…éšœ**ï¼šå‡è®¾ä¾èµ–æœåŠ¡ä¼šå¤±è´¥
2. **å®æ–½å¤šå±‚é˜²æŠ¤**ï¼šç†”æ–­ + é™æµ + é™çº§ + è¶…æ—¶
3. **ç›‘æ§å…³é”®æŒ‡æ ‡**ï¼šå“åº”æ—¶é—´ã€é”™è¯¯ç‡ã€èµ„æºä½¿ç”¨ç‡
4. **å®šæœŸæ¼”ç»ƒ**ï¼šæ··æ²Œå·¥ç¨‹ï¼Œä¸»åŠ¨åˆ¶é€ æ•…éšœ
5. **å¿«é€Ÿæ¢å¤**ï¼šè‡ªåŠ¨åŒ–éƒ¨ç½²å’Œå›æ»šæœºåˆ¶

</details>

### 155. JVM ç”±å“ªäº›éƒ¨åˆ†ç»„æˆï¼Ÿ
<details>
<summary>å±•å¼€ <span class="badge badge--info">ä¸­ç­‰</span> <span class="badge badge--primary">VIP</span> <span class="badge badge--secondary">åç«¯</span> <span class="badge badge--secondary">Java</span> <span class="badge badge--secondary">JVM</span></summary>

**JVMæ•´ä½“æ¶æ„ï¼š**

JVMï¼ˆJava Virtual Machineï¼‰ä¸»è¦ç”±ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ç»„æˆï¼š

**1. ç±»åŠ è½½å­ç³»ç»Ÿï¼ˆClass Loading Subsystemï¼‰**

**ç»„æˆéƒ¨åˆ†ï¼š**
- **ç±»åŠ è½½å™¨ï¼ˆClassLoaderï¼‰**
- **åŠ è½½ï¼ˆLoadingï¼‰**
- **é“¾æ¥ï¼ˆLinkingï¼‰**
- **åˆå§‹åŒ–ï¼ˆInitializationï¼‰**

```java
// ç±»åŠ è½½å™¨å±‚æ¬¡ç»“æ„ç¤ºä¾‹
public class ClassLoaderExample {
    
    public static void main(String[] args) {
        // è·å–ä¸åŒçš„ç±»åŠ è½½å™¨
        ClassLoader systemClassLoader = ClassLoader.getSystemClassLoader();
        ClassLoader extClassLoader = systemClassLoader.getParent();
        ClassLoader bootstrapClassLoader = extClassLoader.getParent();
        
        System.out.println("Bootstrap ClassLoader: " + bootstrapClassLoader); // null
        System.out.println("Extension ClassLoader: " + extClassLoader);
        System.out.println("System ClassLoader: " + systemClassLoader);
        
        // æŸ¥çœ‹ç±»çš„åŠ è½½å™¨
        System.out.println("String class loader: " + String.class.getClassLoader()); // null (Bootstrap)
        System.out.println("ArrayList class loader: " + java.util.ArrayList.class.getClassLoader()); // null (Bootstrap)
        System.out.println("Current class loader: " + ClassLoaderExample.class.getClassLoader()); // System
    }
}

// è‡ªå®šä¹‰ç±»åŠ è½½å™¨
public class CustomClassLoader extends ClassLoader {
    
    private String classpath;
    
    public CustomClassLoader(String classpath) {
        this.classpath = classpath;
    }
    
    @Override
    protected Class<?> findClass(String name) throws ClassNotFoundException {
        try {
            byte[] classData = loadClassData(name);
            if (classData == null) {
                throw new ClassNotFoundException();
            }
            return defineClass(name, classData, 0, classData.length);
        } catch (Exception e) {
            throw new ClassNotFoundException();
        }
    }
    
    private byte[] loadClassData(String className) {
        // ä»æŒ‡å®šè·¯å¾„åŠ è½½ç±»æ–‡ä»¶
        String path = classpath + File.separatorChar + 
                     className.replace('.', File.separatorChar) + ".class";
        try {
            return Files.readAllBytes(Paths.get(path));
        } catch (IOException e) {
            return null;
        }
    }
}
```

**2. è¿è¡Œæ—¶æ•°æ®åŒºï¼ˆRuntime Data Areaï¼‰**

**2.1 æ–¹æ³•åŒºï¼ˆMethod Areaï¼‰/ å…ƒç©ºé—´ï¼ˆMetaspaceï¼‰**
```java
// æ–¹æ³•åŒºå­˜å‚¨çš„å†…å®¹ç¤ºä¾‹
public class MethodAreaExample {
    
    // å¸¸é‡æ± ä¸­çš„å­—ç¬¦ä¸²å­—é¢é‡
    private static final String CONSTANT = "Hello World";
    
    // ç±»å˜é‡å­˜å‚¨åœ¨æ–¹æ³•åŒº
    private static int classVariable = 100;
    
    // å®ä¾‹å˜é‡å­˜å‚¨åœ¨å †ä¸­ï¼Œä½†å˜é‡å®šä¹‰ä¿¡æ¯åœ¨æ–¹æ³•åŒº
    private int instanceVariable;
    
    // æ–¹æ³•å­—èŠ‚ç å­˜å‚¨åœ¨æ–¹æ³•åŒº
    public void method() {
        System.out.println("Method bytecode stored in Method Area");
    }
    
    // ä½¿ç”¨jcmdæŸ¥çœ‹å…ƒç©ºé—´ä¿¡æ¯
    public static void printMetaspaceInfo() {
        MemoryMXBean memoryMX = ManagementFactory.getMemoryMXBean();
        MemoryUsage metaspaceUsage = memoryMX.getNonHeapMemoryUsage();
        
        System.out.println("Metaspace Used: " + metaspaceUsage.getUsed() / 1024 / 1024 + " MB");
        System.out.println("Metaspace Committed: " + metaspaceUsage.getCommitted() / 1024 / 1024 + " MB");
        System.out.println("Metaspace Max: " + metaspaceUsage.getMax() / 1024 / 1024 + " MB");
    }
}
```

**2.2 å †å†…å­˜ï¼ˆHeap Memoryï¼‰**
```java
// å †å†…å­˜ç»“æ„ç¤ºä¾‹
public class HeapMemoryExample {
    
    public static void main(String[] args) {
        printHeapInfo();
        
        // åˆ›å»ºå¯¹è±¡ï¼Œåˆ†é…åœ¨å †ä¸­
        List<String> list = new ArrayList<>();
        
        // å¹´è½»ä»£åˆ†é…
        for (int i = 0; i < 1000; i++) {
            list.add("String " + i); // è¿™äº›å¯¹è±¡é¦–å…ˆåœ¨EdenåŒºåˆ†é…
        }
        
        // è§¦å‘Minor GC
        System.gc();
        
        printHeapInfo();
        
        // åˆ›å»ºå¤§å¯¹è±¡ï¼Œå¯èƒ½ç›´æ¥è¿›å…¥è€å¹´ä»£
        int[] largeArray = new int[1024 * 1024]; // 4MBæ•°ç»„
        
        printHeapInfo();
    }
    
    private static void printHeapInfo() {
        MemoryMXBean memoryMX = ManagementFactory.getMemoryMXBean();
        MemoryUsage heapUsage = memoryMX.getHeapMemoryUsage();
        
        System.out.println("=== Heap Memory Info ===");
        System.out.println("Heap Used: " + heapUsage.getUsed() / 1024 / 1024 + " MB");
        System.out.println("Heap Committed: " + heapUsage.getCommitted() / 1024 / 1024 + " MB");
        System.out.println("Heap Max: " + heapUsage.getMax() / 1024 / 1024 + " MB");
        
        // è·å–å„ä¸ªå†…å­˜æ± çš„ä¿¡æ¯
        List<MemoryPoolMXBean> memoryPools = ManagementFactory.getMemoryPoolMXBeans();
        for (MemoryPoolMXBean pool : memoryPools) {
            if (pool.getType() == MemoryType.HEAP) {
                MemoryUsage usage = pool.getUsage();
                System.out.println(pool.getName() + ": " + 
                                 usage.getUsed() / 1024 / 1024 + " MB");
            }
        }
        System.out.println();
    }
}

// GCç›‘æ§ç¤ºä¾‹
public class GCMonitor {
    
    public static void setupGCMonitoring() {
        List<GarbageCollectorMXBean> gcBeans = ManagementFactory.getGarbageCollectorMXBeans();
        
        for (GarbageCollectorMXBean gcBean : gcBeans) {
            NotificationEmitter emitter = (NotificationEmitter) gcBean;
            emitter.addNotificationListener(new NotificationListener() {
                @Override
                public void handleNotification(Notification notification, Object handback) {
                    if (notification.getType().equals(GarbageCollectionNotificationInfo.GARBAGE_COLLECTION_NOTIFICATION)) {
                        GarbageCollectionNotificationInfo info = 
                            GarbageCollectionNotificationInfo.from((CompositeData) notification.getUserData());
                        
                        System.out.println("GC Event: " + info.getGcName());
                        System.out.println("Duration: " + info.getGcInfo().getDuration() + " ms");
                        System.out.println("Cause: " + info.getGcCause());
                        
                        Map<String, MemoryUsage> before = info.getGcInfo().getMemoryUsageBeforeGc();
                        Map<String, MemoryUsage> after = info.getGcInfo().getMemoryUsageAfterGc();
                        
                        for (String poolName : before.keySet()) {
                            MemoryUsage beforeUsage = before.get(poolName);
                            MemoryUsage afterUsage = after.get(poolName);
                            
                            System.out.println(poolName + ": " + 
                                             beforeUsage.getUsed() / 1024 / 1024 + " MB -> " +
                                             afterUsage.getUsed() / 1024 / 1024 + " MB");
                        }
                    }
                }
            }, null, null);
        }
    }
}
```

**2.3 è™šæ‹Ÿæœºæ ˆï¼ˆVM Stackï¼‰**
```java
// è™šæ‹Ÿæœºæ ˆç¤ºä¾‹
public class VMStackExample {
    
    // å±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ•°æ ˆã€åŠ¨æ€é“¾æ¥ã€æ–¹æ³•è¿”å›åœ°å€
    public int calculate(int a, int b) {
        // å±€éƒ¨å˜é‡å­˜å‚¨åœ¨å±€éƒ¨å˜é‡è¡¨ä¸­
        int result = 0;
        int temp = a + b;
        
        // æ“ä½œæ•°æ ˆç”¨äºè®¡ç®—
        result = temp * 2;
        
        // æ–¹æ³•è°ƒç”¨ï¼Œæ ˆå¸§å‹æ ˆ
        int doubled = doubleValue(result);
        
        // è¿”å›åœ°å€æŒ‡å‘è°ƒç”¨è€…
        return doubled;
    }
    
    private int doubleValue(int value) {
        return value * 2;
    }
    
    // æ ˆæº¢å‡ºç¤ºä¾‹
    public void stackOverflowExample() {
        try {
            recursiveMethod(1);
        } catch (StackOverflowError e) {
            System.out.println("Stack overflow occurred!");
        }
    }
    
    private void recursiveMethod(int depth) {
        System.out.println("Recursion depth: " + depth);
        // æ— é™é€’å½’å¯¼è‡´æ ˆæº¢å‡º
        recursiveMethod(depth + 1);
    }
    
    // æŸ¥çœ‹æ ˆä¿¡æ¯
    public static void printStackInfo() {
        ThreadMXBean threadMX = ManagementFactory.getThreadMXBean();
        ThreadInfo[] threadInfos = threadMX.dumpAllThreads(false, false);
        
        for (ThreadInfo threadInfo : threadInfos) {
            System.out.println("Thread: " + threadInfo.getThreadName());
            System.out.println("State: " + threadInfo.getThreadState());
            
            StackTraceElement[] stackTrace = threadInfo.getStackTrace();
            for (StackTraceElement element : stackTrace) {
                System.out.println("  " + element.toString());
            }
            System.out.println();
        }
    }
}
```

**2.4 æœ¬åœ°æ–¹æ³•æ ˆï¼ˆNative Method Stackï¼‰**
```java
// æœ¬åœ°æ–¹æ³•æ ˆç¤ºä¾‹
public class NativeMethodExample {
    
    // å£°æ˜æœ¬åœ°æ–¹æ³•
    public native void nativeMethod();
    
    // åŠ è½½æœ¬åœ°åº“
    static {
        System.loadLibrary("nativelib");
    }
    
    // ä½¿ç”¨JNIçš„ä¾‹å­
    public void useNativeMethod() {
        // è°ƒç”¨æœ¬åœ°æ–¹æ³•ï¼Œä¼šä½¿ç”¨æœ¬åœ°æ–¹æ³•æ ˆ
        nativeMethod();
        
        // ç³»ç»Ÿæ–¹æ³•ä¹Ÿæ˜¯æœ¬åœ°æ–¹æ³•
        long currentTime = System.currentTimeMillis();
        System.out.println("Current time: " + currentTime);
        
        // æ•°ç»„å¤åˆ¶ä¹Ÿæ˜¯æœ¬åœ°æ–¹æ³•
        int[] source = {1, 2, 3, 4, 5};
        int[] dest = new int[5];
        System.arraycopy(source, 0, dest, 0, 5);
    }
}
```

**2.5 ç¨‹åºè®¡æ•°å™¨ï¼ˆProgram Counter Registerï¼‰**
```java
// ç¨‹åºè®¡æ•°å™¨ç¤ºä¾‹
public class PCRegisterExample {
    
    public void demonstratePC() {
        int a = 1;        // PCæŒ‡å‘è¿™æ¡æŒ‡ä»¤çš„åœ°å€
        int b = 2;        // PCé€’å¢ï¼ŒæŒ‡å‘ä¸‹ä¸€æ¡æŒ‡ä»¤
        int c = a + b;    // PCç»§ç»­é€’å¢
        
        if (c > 2) {      // æ¡ä»¶è·³è½¬ï¼ŒPCå¯èƒ½è·³è½¬
            System.out.println("c > 2");
        } else {
            System.out.println("c <= 2");
        }
        
        // å¾ªç¯ä¸­çš„PCå˜åŒ–
        for (int i = 0; i < 3; i++) {  // PCåœ¨å¾ªç¯ä¸­è·³è½¬
            System.out.println("i = " + i);
        }
    }
    
    // å¤šçº¿ç¨‹ä¸­æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„PCå¯„å­˜å™¨
    public void multiThreadPC() {
        Thread thread1 = new Thread(() -> {
            for (int i = 0; i < 5; i++) {
                System.out.println("Thread1: " + i);
                Thread.yield(); // çº¿ç¨‹åˆ‡æ¢ï¼ŒPCå¯„å­˜å™¨ä¿å­˜å½“å‰æ‰§è¡Œä½ç½®
            }
        });
        
        Thread thread2 = new Thread(() -> {
            for (int i = 0; i < 5; i++) {
                System.out.println("Thread2: " + i);
                Thread.yield();
            }
        });
        
        thread1.start();
        thread2.start();
    }
}
```

**3. æ‰§è¡Œå¼•æ“ï¼ˆExecution Engineï¼‰**

**3.1 è§£é‡Šå™¨ï¼ˆInterpreterï¼‰**
```java
// è§£é‡Šå™¨æ‰§è¡Œç¤ºä¾‹
public class InterpreterExample {
    
    // è§£é‡Šå™¨é€è¡Œæ‰§è¡Œå­—èŠ‚ç 
    public void interpretedMethod() {
        System.out.println("This method is interpreted");
        
        int sum = 0;
        for (int i = 0; i < 100; i++) {
            sum += i;  // æ¯æ¬¡å¾ªç¯éƒ½è§£é‡Šæ‰§è¡Œ
        }
        
        System.out.println("Sum: " + sum);
    }
    
    // æŸ¥çœ‹æ–¹æ³•æ˜¯å¦è¢«JITç¼–è¯‘
    public static void checkCompilation() {
        CompilerMXBean compilerMX = ManagementFactory.getCompilerMXBean();
        System.out.println("JIT Compiler: " + compilerMX.getName());
        System.out.println("Total compilation time: " + compilerMX.getTotalCompilationTime() + " ms");
    }
}
```

**3.2 å³æ—¶ç¼–è¯‘å™¨ï¼ˆJIT Compilerï¼‰**
```java
// JITç¼–è¯‘ç¤ºä¾‹
public class JITCompilerExample {
    
    private static final int LOOP_COUNT = 100000;
    
    // çƒ­ç‚¹æ–¹æ³•ï¼Œä¼šè¢«JITç¼–è¯‘
    public static int hotMethod(int x) {
        return x * x + 2 * x + 1;
    }
    
    public static void main(String[] args) {
        // é¢„çƒ­ï¼Œè®©æ–¹æ³•æˆä¸ºçƒ­ç‚¹
        for (int i = 0; i < LOOP_COUNT; i++) {
            hotMethod(i);
        }
        
        // æµ‹è¯•JITç¼–è¯‘åçš„æ€§èƒ½
        long startTime = System.nanoTime();
        
        int result = 0;
        for (int i = 0; i < LOOP_COUNT; i++) {
            result += hotMethod(i);
        }
        
        long endTime = System.nanoTime();
        System.out.println("JIT compiled execution time: " + 
                          (endTime - startTime) / 1000000.0 + " ms");
        System.out.println("Result: " + result);
        
        // æ˜¾ç¤ºç¼–è¯‘ä¿¡æ¯ï¼ˆéœ€è¦JVMå‚æ•°ï¼š-XX:+PrintCompilationï¼‰
        printCompilationInfo();
    }
    
    private static void printCompilationInfo() {
        try {
            MBeanServer server = ManagementFactory.getPlatformMBeanServer();
            ObjectName objectName = new ObjectName("java.lang:type=Compilation");
            
            if (server.isRegistered(objectName)) {
                Long compilationTime = (Long) server.getAttribute(objectName, "TotalCompilationTime");
                System.out.println("Total JIT compilation time: " + compilationTime + " ms");
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}

// C1å’ŒC2ç¼–è¯‘å™¨é…ç½®ç¤ºä¾‹
public class TieredCompilationExample {
    
    public static void demonstrateTieredCompilation() {
        // JVMå‚æ•°ç¤ºä¾‹ï¼š
        // -XX:+TieredCompilation          // å¼€å¯åˆ†å±‚ç¼–è¯‘
        // -XX:TieredStopAtLevel=1         // åªä½¿ç”¨C1ç¼–è¯‘å™¨
        // -XX:TieredStopAtLevel=4         // ä½¿ç”¨C1å’ŒC2ç¼–è¯‘å™¨ï¼ˆé»˜è®¤ï¼‰
        // -XX:CompileThreshold=10000      // è®¾ç½®ç¼–è¯‘é˜ˆå€¼
        
        System.out.println("Demonstrating tiered compilation...");
        
        // æ–¹æ³•è°ƒç”¨æ¬¡æ•°ç»Ÿè®¡
        int threshold = 0;
        RuntimeMXBean runtimeMX = ManagementFactory.getRuntimeMXBean();
        List<String> jvmArgs = runtimeMX.getInputArguments();
        
        for (String arg : jvmArgs) {
            if (arg.startsWith("-XX:CompileThreshold=")) {
                threshold = Integer.parseInt(arg.substring(21));
                break;
            }
        }
        
        System.out.println("Compile threshold: " + threshold);
    }
}
```

**4. æœ¬åœ°æ–¹æ³•æ¥å£ï¼ˆNative Method Interfaceï¼‰**
```java
// JNIç¤ºä¾‹
public class NativeInterfaceExample {
    
    // æœ¬åœ°æ–¹æ³•å£°æ˜
    public native String stringFromJNI();
    public native int addNumbers(int a, int b);
    
    static {
        // åŠ è½½æœ¬åœ°åº“
        try {
            System.loadLibrary("nativeinterface");
        } catch (UnsatisfiedLinkError e) {
            System.err.println("Native library failed to load: " + e);
        }
    }
    
    public void demonstrateJNI() {
        try {
            String message = stringFromJNI();
            System.out.println("Message from native: " + message);
            
            int result = addNumbers(10, 20);
            System.out.println("Native addition result: " + result);
        } catch (UnsatisfiedLinkError e) {
            System.err.println("Native method call failed: " + e);
        }
    }
}
```

**JVMå‚æ•°é…ç½®ç¤ºä¾‹ï¼š**
```bash
# å †å†…å­˜é…ç½®
-Xms2g                    # åˆå§‹å †å¤§å°
-Xmx4g                    # æœ€å¤§å †å¤§å°
-Xmn1g                    # å¹´è½»ä»£å¤§å°
-XX:SurvivorRatio=8       # Eden:Survivoræ¯”ä¾‹

# å…ƒç©ºé—´é…ç½®
-XX:MetaspaceSize=256m    # åˆå§‹å…ƒç©ºé—´å¤§å°
-XX:MaxMetaspaceSize=512m # æœ€å¤§å…ƒç©ºé—´å¤§å°

# åƒåœ¾æ”¶é›†å™¨é…ç½®
-XX:+UseG1GC              # ä½¿ç”¨G1åƒåœ¾æ”¶é›†å™¨
-XX:MaxGCPauseMillis=200  # æœ€å¤§GCæš‚åœæ—¶é—´

# JITç¼–è¯‘å™¨é…ç½®
-XX:+TieredCompilation    # å¼€å¯åˆ†å±‚ç¼–è¯‘
-XX:CompileThreshold=10000 # ç¼–è¯‘é˜ˆå€¼

# ç›‘æ§å’Œè°ƒè¯•
-XX:+PrintGC              # æ‰“å°GCä¿¡æ¯
-XX:+PrintGCDetails       # æ‰“å°è¯¦ç»†GCä¿¡æ¯
-XX:+HeapDumpOnOutOfMemoryError # OOMæ—¶ç”Ÿæˆå †è½¬å‚¨
```

**å†…å­˜åˆ†æå·¥å…·ä½¿ç”¨ï¼š**
```java
// å†…å­˜åˆ†æç¤ºä¾‹
public class MemoryAnalysisExample {
    
    public static void analyzeMemory() {
        Runtime runtime = Runtime.getRuntime();
        
        System.out.println("=== Memory Analysis ===");
        System.out.println("Max memory: " + runtime.maxMemory() / 1024 / 1024 + " MB");
        System.out.println("Total memory: " + runtime.totalMemory() / 1024 / 1024 + " MB");
        System.out.println("Free memory: " + runtime.freeMemory() / 1024 / 1024 + " MB");
        System.out.println("Used memory: " + 
                          (runtime.totalMemory() - runtime.freeMemory()) / 1024 / 1024 + " MB");
        
        // è·å–è¯¦ç»†çš„å†…å­˜æ± ä¿¡æ¯
        List<MemoryPoolMXBean> memoryPools = ManagementFactory.getMemoryPoolMXBeans();
        for (MemoryPoolMXBean pool : memoryPools) {
            MemoryUsage usage = pool.getUsage();
            System.out.println(pool.getName() + ":");
            System.out.println("  Used: " + usage.getUsed() / 1024 / 1024 + " MB");
            System.out.println("  Committed: " + usage.getCommitted() / 1024 / 1024 + " MB");
            System.out.println("  Max: " + (usage.getMax() == -1 ? "Unlimited" : 
                                          usage.getMax() / 1024 / 1024 + " MB"));
        }
    }
    
    // ç”Ÿæˆå†…å­˜å¿«ç…§
    public static void generateHeapDump() {
        try {
            MBeanServer server = ManagementFactory.getPlatformMBeanServer();
            HotSpotDiagnosticMXBean hotspotMBean = 
                ManagementFactory.newPlatformMXBeanProxy(server,
                    "com.sun.management:type=HotSpotDiagnostic",
                    HotSpotDiagnosticMXBean.class);
            
            String dumpFile = "heapdump_" + System.currentTimeMillis() + ".hprof";
            hotspotMBean.dumpHeap(dumpFile, true);
            System.out.println("Heap dump generated: " + dumpFile);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

**æ€»ç»“ï¼š**
JVMçš„ä¸»è¦ç»„æˆéƒ¨åˆ†ååŒå·¥ä½œï¼Œä¸ºJavaç¨‹åºæä¾›äº†è¿è¡Œç¯å¢ƒï¼š
- **ç±»åŠ è½½å­ç³»ç»Ÿ**ï¼šè´Ÿè´£åŠ è½½ã€é“¾æ¥å’Œåˆå§‹åŒ–ç±»
- **è¿è¡Œæ—¶æ•°æ®åŒº**ï¼šæä¾›ç¨‹åºè¿è¡Œæ‰€éœ€çš„å†…å­˜ç©ºé—´
- **æ‰§è¡Œå¼•æ“**ï¼šè§£é‡Šå’Œç¼–è¯‘æ‰§è¡Œå­—èŠ‚ç 
- **æœ¬åœ°æ–¹æ³•æ¥å£**ï¼šæ”¯æŒè°ƒç”¨æœ¬åœ°æ–¹æ³•

</details>

### 156. Redis é€šå¸¸åº”ç”¨äºå“ªäº›åœºæ™¯ï¼Ÿ
<details>
<summary>å±•å¼€ <span class="badge badge--success">ç®€å•</span> <span class="badge badge--primary">VIP</span> <span class="badge badge--secondary">åç«¯</span> <span class="badge badge--secondary">Redis</span></summary>

**Redisåº”ç”¨åœºæ™¯è¯¦è§£ï¼š**

**1. ç¼“å­˜ï¼ˆCacheï¼‰**
- **é¡µé¢ç¼“å­˜**ï¼šç¼“å­˜æ•´é¡µHTML
- **æ•°æ®ç¼“å­˜**ï¼šç¼“å­˜æ•°æ®åº“æŸ¥è¯¢ç»“æœ
- **å¯¹è±¡ç¼“å­˜**ï¼šç¼“å­˜åºåˆ—åŒ–å¯¹è±¡
- **å¤šçº§ç¼“å­˜**ï¼šä¸æœ¬åœ°ç¼“å­˜é…åˆ

**2. ä¼šè¯å­˜å‚¨ï¼ˆSession Storeï¼‰**
- **Webä¼šè¯**ï¼šå­˜å‚¨ç”¨æˆ·ç™»å½•çŠ¶æ€
- **è´­ç‰©è½¦**ï¼šç”µå•†è´­ç‰©è½¦æ•°æ®
- **ç”¨æˆ·åå¥½**ï¼šä¸ªæ€§åŒ–è®¾ç½®

**3. åˆ†å¸ƒå¼é”**
- **èµ„æºäº’æ–¥**ï¼šé˜²æ­¢å¹¶å‘ä¿®æ”¹
- **ä»»åŠ¡è°ƒåº¦**ï¼šåˆ†å¸ƒå¼ä»»åŠ¡é”
- **é™æµæ§åˆ¶**ï¼šAPIè®¿é—®é™åˆ¶

**4. è®¡æ•°å™¨**
- **è®¿é—®ç»Ÿè®¡**ï¼šé¡µé¢PV/UVç»Ÿè®¡
- **ç‚¹èµæ”¶è—**ï¼šç¤¾äº¤åŠŸèƒ½è®¡æ•°
- **åº“å­˜ç®¡ç†**ï¼šå•†å“åº“å­˜è®¡æ•°

**5. æ¶ˆæ¯é˜Ÿåˆ—**
- **ä»»åŠ¡é˜Ÿåˆ—**ï¼šå¼‚æ­¥ä»»åŠ¡å¤„ç†
- **å‘å¸ƒè®¢é˜…**ï¼šå®æ—¶æ¶ˆæ¯æ¨é€
- **å»¶æ—¶é˜Ÿåˆ—**ï¼šå®šæ—¶ä»»åŠ¡å¤„ç†

**6. æ’è¡Œæ¦œ**
- **æ¸¸æˆæ’è¡Œ**ï¼šåˆ†æ•°æ’åº
- **çƒ­æœæ¦œ**ï¼šå®æ—¶çƒ­ç‚¹
- **é”€é‡æ’è¡Œ**ï¼šå•†å“é”€é‡ç»Ÿè®¡

**7. åœ°ç†ä½ç½®**
- **é™„è¿‘çš„äºº**ï¼šLBSåº”ç”¨
- **é…é€èŒƒå›´**ï¼šå¤–å–é…é€
- **è½¨è¿¹è·Ÿè¸ª**ï¼šä½ç½®è®°å½•

**8. å®æ—¶ç³»ç»Ÿ**
- **åœ¨çº¿çŠ¶æ€**ï¼šç”¨æˆ·åœ¨çº¿æ£€æµ‹
- **å®æ—¶ç»Ÿè®¡**ï¼šç›‘æ§æŒ‡æ ‡
- **æ´»åŠ¨é™æ—¶**ï¼šç§’æ€æ´»åŠ¨

</details>

### 157. è®©ä½ è®¾è®¡ä¸€ä¸ªçŸ­é“¾ç³»ç»Ÿï¼Œæ€ä¹ˆè®¾è®¡ï¼Ÿ
<details>
<summary>å±•å¼€ <span class="badge badge--danger">å›°éš¾</span> <span class="badge badge--primary">VIP</span> <span class="badge badge--secondary">åç«¯</span> <span class="badge badge--secondary">ç³»ç»Ÿè®¾è®¡</span> <span class="badge badge--secondary">åœºæ™¯é¢˜</span></summary>

**çŸ­é“¾ç³»ç»Ÿè®¾è®¡è¦æ±‚ï¼š**
- **é«˜å¹¶å‘**ï¼šæ”¯æŒå¤§é‡çŸ­é“¾ç”Ÿæˆå’Œè®¿é—®
- **é«˜å¯ç”¨**ï¼š7x24å°æ—¶ç¨³å®šæœåŠ¡
- **å”¯ä¸€æ€§**ï¼šçŸ­é“¾ä¸èƒ½é‡å¤
- **æ—¶æ•ˆæ€§**ï¼šæ”¯æŒé“¾æ¥è¿‡æœŸ
- **ç»Ÿè®¡æ€§**ï¼šè®¿é—®æ•°æ®ç»Ÿè®¡

**æ¶æ„è®¾è®¡ï¼š**

**1. æ•´ä½“æ¶æ„**
```
[å®¢æˆ·ç«¯] -> [CDN] -> [è´Ÿè½½å‡è¡¡] -> [APIç½‘å…³] -> [çŸ­é“¾æœåŠ¡é›†ç¾¤]
                                                     â†“
[Redisé›†ç¾¤] <- [çŸ­é“¾æœåŠ¡] -> [MySQLä¸»ä»] -> [å¤§æ•°æ®åˆ†æ]
```

**2. æ ¸å¿ƒç®—æ³•**

**æ–¹æ¡ˆä¸€ï¼šBase62ç¼–ç **
```java
@Service
public class Base62ShortUrlService {
    
    private static final String BASE62 = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";
    private static final int BASE = 62;
    
    @Autowired
    private DistributedIdGenerator idGenerator;
    
    public String generateShortUrl(String longUrl) {
        // ç”Ÿæˆå”¯ä¸€ID
        long id = idGenerator.nextId();
        
        // Base62ç¼–ç 
        String shortCode = encodeBase62(id);
        
        // å­˜å‚¨æ˜ å°„å…³ç³»
        saveMapping(shortCode, longUrl);
        
        return "https://short.ly/" + shortCode;
    }
    
    private String encodeBase62(long num) {
        if (num == 0) return "0";
        
        StringBuilder sb = new StringBuilder();
        while (num > 0) {
            sb.append(BASE62.charAt((int)(num % BASE)));
            num /= BASE;
        }
        return sb.reverse().toString();
    }
}
```

**æ–¹æ¡ˆäºŒï¼šå“ˆå¸Œç®—æ³•**
```java
@Service  
public class HashShortUrlService {
    
    public String generateShortUrl(String longUrl) {
        // MD5å“ˆå¸Œ
        String hash = DigestUtils.md5Hex(longUrl + System.currentTimeMillis());
        
        // å–å‰6ä½ä½œä¸ºçŸ­ç 
        String shortCode = hash.substring(0, 6);
        
        // å†²çªæ£€æµ‹å’Œå¤„ç†
        int retry = 0;
        while (exists(shortCode) && retry < 5) {
            hash = DigestUtils.md5Hex(longUrl + System.currentTimeMillis() + retry);
            shortCode = hash.substring(0, 6);
            retry++;
        }
        
        saveMapping(shortCode, longUrl);
        return "https://short.ly/" + shortCode;
    }
}
```

**3. æ•°æ®å­˜å‚¨**

**MySQLè®¾è®¡**
```sql
-- çŸ­é“¾æ˜ å°„è¡¨
CREATE TABLE short_url_mapping (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    short_code VARCHAR(10) NOT NULL UNIQUE,
    long_url TEXT NOT NULL,
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    expire_time TIMESTAMP NULL,
    creator_id BIGINT,
    status TINYINT DEFAULT 1,
    INDEX idx_short_code (short_code),
    INDEX idx_creator_time (creator_id, create_time)
);

-- è®¿é—®ç»Ÿè®¡è¡¨
CREATE TABLE url_access_stats (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    short_code VARCHAR(10) NOT NULL,
    access_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    ip_address VARCHAR(45),
    user_agent TEXT,
    referer TEXT,
    INDEX idx_short_code_time (short_code, access_time)
);
```

**Redisç¼“å­˜**
```java
@Service
public class ShortUrlCacheService {
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    private static final String URL_CACHE_PREFIX = "short_url:";
    private static final String STATS_PREFIX = "stats:";
    
    public void cacheMapping(String shortCode, String longUrl, int expireHours) {
        String key = URL_CACHE_PREFIX + shortCode;
        redisTemplate.opsForValue().set(key, longUrl, expireHours, TimeUnit.HOURS);
    }
    
    public String getLongUrl(String shortCode) {
        String key = URL_CACHE_PREFIX + shortCode;
        return redisTemplate.opsForValue().get(key);
    }
    
    public void incrementAccessCount(String shortCode) {
        String key = STATS_PREFIX + shortCode;
        redisTemplate.opsForValue().increment(key);
    }
}
```

**4. æ ¸å¿ƒæœåŠ¡å®ç°**
```java
@RestController
@RequestMapping("/api/shorturl")
public class ShortUrlController {
    
    @Autowired
    private ShortUrlService shortUrlService;
    
    // ç”ŸæˆçŸ­é“¾
    @PostMapping("/generate")
    public ResponseEntity<ShortUrlResponse> generateShortUrl(@RequestBody ShortUrlRequest request) {
        try {
            String shortUrl = shortUrlService.generateShortUrl(
                request.getLongUrl(), 
                request.getExpireHours(),
                request.getUserId()
            );
            
            return ResponseEntity.ok(ShortUrlResponse.builder()
                .shortUrl(shortUrl)
                .originalUrl(request.getLongUrl())
                .build());
        } catch (Exception e) {
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                .body(ShortUrlResponse.builder().error("ç”Ÿæˆå¤±è´¥").build());
        }
    }
    
    // è®¿é—®é‡å®šå‘
    @GetMapping("/{shortCode}")
    public ResponseEntity<?> redirect(@PathVariable String shortCode, HttpServletRequest request) {
        try {
            String longUrl = shortUrlService.getLongUrl(shortCode);
            
            if (longUrl == null) {
                return ResponseEntity.notFound().build();
            }
            
            // å¼‚æ­¥è®°å½•è®¿é—®ç»Ÿè®¡
            shortUrlService.recordAccess(shortCode, request);
            
            // é‡å®šå‘
            return ResponseEntity.status(HttpStatus.MOVED_PERMANENTLY)
                .location(URI.create(longUrl))
                .build();
                
        } catch (Exception e) {
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).build();
        }
    }
}
```

**5. é«˜æ€§èƒ½ä¼˜åŒ–**

**åˆ†åº“åˆ†è¡¨**
```java
@Component
public class ShardingStrategy {
    
    private static final int SHARD_COUNT = 64;
    
    public String getShardTableName(String shortCode) {
        int hash = shortCode.hashCode();
        int shardIndex = Math.abs(hash) % SHARD_COUNT;
        return "short_url_mapping_" + String.format("%02d", shardIndex);
    }
    
    public String getStatsTableName(String shortCode) {
        int hash = shortCode.hashCode();
        int shardIndex = Math.abs(hash) % SHARD_COUNT;
        return "url_access_stats_" + String.format("%02d", shardIndex);
    }
}
```

**å¸ƒéš†è¿‡æ»¤å™¨**
```java
@Component
public class BloomFilterService {
    
    private BloomFilter<String> bloomFilter;
    
    @PostConstruct
    public void init() {
        // é¢„æœŸ1000ä¸‡ä¸ªçŸ­ç ï¼Œè¯¯åˆ¤ç‡0.01%
        bloomFilter = BloomFilter.create(
            Funnels.stringFunnel(Charset.defaultCharset()),
            10_000_000,
            0.0001
        );
    }
    
    public boolean mightExist(String shortCode) {
        return bloomFilter.mightContain(shortCode);
    }
    
    public void addToFilter(String shortCode) {
        bloomFilter.put(shortCode);
    }
}
```

**6. ç›‘æ§å‘Šè­¦**
```java
@Component
public class ShortUrlMonitor {
    
    @Autowired
    private MeterRegistry meterRegistry;
    
    public void recordGeneration(boolean success) {
        Counter.builder("shorturl.generation")
            .tag("result", success ? "success" : "failure")
            .register(meterRegistry)
            .increment();
    }
    
    public void recordAccess(String shortCode, long responseTime) {
        Timer.builder("shorturl.access")
            .tag("code", shortCode)
            .register(meterRegistry)
            .record(responseTime, TimeUnit.MILLISECONDS);
    }
    
    @Scheduled(fixedRate = 60000) // æ¯åˆ†é’Ÿæ£€æŸ¥
    public void checkSystemHealth() {
        // æ£€æŸ¥æ•°æ®åº“è¿æ¥
        // æ£€æŸ¥Redisè¿æ¥  
        // æ£€æŸ¥é”™è¯¯ç‡
        // å‘é€å‘Šè­¦
    }
}
```

**æ‰©å±•åŠŸèƒ½ï¼š**
- **è‡ªå®šä¹‰çŸ­é“¾**ï¼šæ”¯æŒç”¨æˆ·è‡ªå®šä¹‰çŸ­ç 
- **æ‰¹é‡ç”Ÿæˆ**ï¼šæ‰¹é‡å¤„ç†é•¿é“¾æ¥
- **è®¿é—®æ§åˆ¶**ï¼šå¯†ç ä¿æŠ¤ã€è®¿é—®é™åˆ¶
- **æ•°æ®åˆ†æ**ï¼šè¯¦ç»†çš„è®¿é—®ç»Ÿè®¡å’Œåˆ†æ

</details>

### 158. ä»€ä¹ˆæ˜¯å¾ªç¯ä¾èµ–ï¼ˆå¸¸é—®ï¼‰ï¼Ÿ
<details>
<summary>å±•å¼€ <span class="badge badge--info">ä¸­ç­‰</span> <span class="badge badge--secondary">åç«¯</span> <span class="badge badge--secondary">Spring</span></summary>

**å¾ªç¯ä¾èµ–å®šä¹‰ï¼š**
å¾ªç¯ä¾èµ–æ˜¯æŒ‡ä¸¤ä¸ªæˆ–å¤šä¸ªå¯¹è±¡ä¹‹é—´ç›¸äº’ä¾èµ–ï¼Œå½¢æˆé—­ç¯çš„æƒ…å†µã€‚åœ¨Springä¸­ï¼Œæœ€å¸¸è§çš„æ˜¯Beanä¹‹é—´çš„ç›¸äº’å¼•ç”¨ã€‚

**å¾ªç¯ä¾èµ–ç±»å‹ï¼š**

**1. æ„é€ å™¨å¾ªç¯ä¾èµ–**
```java
// æ— æ³•è§£å†³çš„å¾ªç¯ä¾èµ–
@Component
public class ServiceA {
    private ServiceB serviceB;
    
    public ServiceA(ServiceB serviceB) {  // æ„é€ å™¨æ³¨å…¥
        this.serviceB = serviceB;
    }
}

@Component  
public class ServiceB {
    private ServiceA serviceA;
    
    public ServiceB(ServiceA serviceA) {  // æ„é€ å™¨æ³¨å…¥
        this.serviceA = serviceA;
    }
}
// ç»“æœï¼šBeanCurrentlyInCreationException
```

**2. Setterå¾ªç¯ä¾èµ–**
```java
// Springå¯ä»¥è§£å†³çš„å¾ªç¯ä¾èµ–
@Component
public class ServiceA {
    
    @Autowired
    private ServiceB serviceB;  // Setteræ³¨å…¥
    
    public void doSomething() {
        serviceB.process();
    }
}

@Component
public class ServiceB {
    
    @Autowired
    private ServiceA serviceA;  // Setteræ³¨å…¥
    
    public void process() {
        serviceA.doSomething();
    }
}
```

**Springè§£å†³å¾ªç¯ä¾èµ–çš„æœºåˆ¶ï¼š**

**ä¸‰çº§ç¼“å­˜**
```java
// Springå†…éƒ¨çš„ä¸‰çº§ç¼“å­˜æœºåˆ¶
public class DefaultSingletonBeanRegistry {
    
    // ä¸€çº§ç¼“å­˜ï¼šå®Œæ•´çš„å•ä¾‹å¯¹è±¡
    private final Map<String, Object> singletonObjects = new ConcurrentHashMap<>(256);
    
    // äºŒçº§ç¼“å­˜ï¼šæ—©æœŸæš´éœ²çš„å¯¹è±¡ï¼ˆå·²å®ä¾‹åŒ–ä½†æœªå®Œæˆå±æ€§æ³¨å…¥ï¼‰
    private final Map<String, Object> earlySingletonObjects = new HashMap<>(16);
    
    // ä¸‰çº§ç¼“å­˜ï¼šå•ä¾‹å·¥å‚
    private final Map<String, ObjectFactory<?>> singletonFactories = new HashMap<>(16);
    
    // æ­£åœ¨åˆ›å»ºçš„Beanåç§°
    private final Set<String> singletonsCurrentlyInCreation = Collections.newSetFromMap(new ConcurrentHashMap<>(16));
}
```

**è§£å†³è¿‡ç¨‹ç¤ºä¾‹ï¼š**
```java
// æ¨¡æ‹ŸSpringåˆ›å»ºBeançš„è¿‡ç¨‹
public class CircularDependencyResolver {
    
    private Map<String, Object> singletonObjects = new ConcurrentHashMap<>();
    private Map<String, Object> earlySingletonObjects = new HashMap<>();
    private Map<String, ObjectFactory<?>> singletonFactories = new HashMap<>();
    private Set<String> singletonsCurrentlyInCreation = new HashSet<>();
    
    public Object getBean(String beanName) {
        // 1. ä»ä¸€çº§ç¼“å­˜è·å–
        Object singletonObject = singletonObjects.get(beanName);
        if (singletonObject != null) {
            return singletonObject;
        }
        
        // 2. æ£€æŸ¥æ˜¯å¦æ­£åœ¨åˆ›å»ºä¸­
        if (singletonsCurrentlyInCreation.contains(beanName)) {
            // ä»äºŒçº§ç¼“å­˜è·å–
            singletonObject = earlySingletonObjects.get(beanName);
            if (singletonObject == null) {
                // ä»ä¸‰çº§ç¼“å­˜è·å–
                ObjectFactory<?> factory = singletonFactories.get(beanName);
                if (factory != null) {
                    singletonObject = factory.getObject();
                    // ç§»åˆ°äºŒçº§ç¼“å­˜
                    earlySingletonObjects.put(beanName, singletonObject);
                    singletonFactories.remove(beanName);
                }
            }
            return singletonObject;
        }
        
        // 3. åˆ›å»ºæ–°çš„Bean
        return createBean(beanName);
    }
    
    private Object createBean(String beanName) {
        // æ ‡è®°ä¸ºæ­£åœ¨åˆ›å»º
        singletonsCurrentlyInCreation.add(beanName);
        
        try {
            // 1. å®ä¾‹åŒ–
            Object bean = instantiate(beanName);
            
            // 2. æå‰æš´éœ²åˆ°ä¸‰çº§ç¼“å­˜
            singletonFactories.put(beanName, () -> getEarlyBeanReference(beanName, bean));
            
            // 3. å±æ€§æ³¨å…¥
            populateBean(bean);
            
            // 4. åˆå§‹åŒ–
            initializeBean(bean);
            
            // 5. æ·»åŠ åˆ°ä¸€çº§ç¼“å­˜
            singletonObjects.put(beanName, bean);
            earlySingletonObjects.remove(beanName);
            singletonFactories.remove(beanName);
            
            return bean;
        } finally {
            singletonsCurrentlyInCreation.remove(beanName);
        }
    }
}
```

**å¾ªç¯ä¾èµ–çš„è§£å†³æ–¹æ¡ˆï¼š**

**1. ä½¿ç”¨@Lazyæ³¨è§£**
```java
@Component
public class ServiceA {
    
    @Autowired
    @Lazy  // å»¶è¿ŸåŠ è½½ï¼Œæ‰“ç ´å¾ªç¯
    private ServiceB serviceB;
    
    public void doSomething() {
        serviceB.process();
    }
}

@Component
public class ServiceB {
    
    @Autowired
    private ServiceA serviceA;
    
    public void process() {
        serviceA.doSomething();
    }
}
```

**2. ä½¿ç”¨@PostConstruct**
```java
@Component
public class ServiceA {
    
    @Autowired
    private ApplicationContext applicationContext;
    
    private ServiceB serviceB;
    
    @PostConstruct
    public void init() {
        this.serviceB = applicationContext.getBean(ServiceB.class);
    }
}
```

**3. å®ç°ApplicationContextAware**
```java
@Component
public class ServiceA implements ApplicationContextAware {
    
    private ApplicationContext applicationContext;
    private ServiceB serviceB;
    
    @Override
    public void setApplicationContext(ApplicationContext applicationContext) {
        this.applicationContext = applicationContext;
    }
    
    public ServiceB getServiceB() {
        if (serviceB == null) {
            serviceB = applicationContext.getBean(ServiceB.class);
        }
        return serviceB;
    }
}
```

**4. é‡æ–°è®¾è®¡æ¶æ„**
```java
// å¼•å…¥ä¸­é—´å±‚æ‰“ç ´å¾ªç¯
@Component
public class ServiceA {
    
    @Autowired
    private CommonService commonService;
    
    public void doSomething() {
        commonService.processForA();
    }
}

@Component
public class ServiceB {
    
    @Autowired
    private CommonService commonService;
    
    public void process() {
        commonService.processForB();
    }
}

@Component
public class CommonService {
    // å…±åŒçš„ä¸šåŠ¡é€»è¾‘
}
```

**æœ€ä½³å®è·µï¼š**
- é¿å…æ„é€ å™¨å¾ªç¯ä¾èµ–
- ä¼˜å…ˆä½¿ç”¨Setteræ³¨å…¥
- åˆç†ä½¿ç”¨@Lazyæ³¨è§£
- é‡æ–°è®¾è®¡ç±»ä¹‹é—´çš„ä¾èµ–å…³ç³»
- ä½¿ç”¨äº‹ä»¶é©±åŠ¨æ¨¡å¼è§£è€¦

</details>

### 159. JVM åƒåœ¾å›æ”¶è°ƒä¼˜çš„ä¸»è¦ç›®æ ‡æ˜¯ä»€ä¹ˆï¼Ÿ
<details>
<summary>å±•å¼€ <span class="badge badge--info">ä¸­ç­‰</span> <span class="badge badge--primary">VIP</span> <span class="badge badge--secondary">JVM</span> <span class="badge badge--secondary">Java</span></summary>

**GCè°ƒä¼˜ä¸»è¦ç›®æ ‡ï¼š**

**1. é™ä½GCåœé¡¿æ—¶é—´**
- å‡å°‘STWï¼ˆStop-The-Worldï¼‰æ—¶é—´
- æé«˜åº”ç”¨å“åº”é€Ÿåº¦
- æ”¹å–„ç”¨æˆ·ä½“éªŒ

**2. æé«˜ååé‡**
- å‡å°‘GCé¢‘ç‡
- é™ä½GCå¼€é”€å æ¯”
- æé«˜æ•´ä½“æ€§èƒ½

**3. å‡å°‘å†…å­˜å ç”¨**
- ä¼˜åŒ–å †å†…å­˜ä½¿ç”¨
- é¿å…å†…å­˜æ³„æ¼
- åˆç†é…ç½®å„ä»£å¤§å°

**è°ƒä¼˜ç­–ç•¥ï¼š**

**Young GCä¼˜åŒ–**
```bash
# å¹´è½»ä»£è°ƒä¼˜å‚æ•°
-Xmn2g                    # å¹´è½»ä»£å¤§å°
-XX:SurvivorRatio=8       # Eden:Survivor = 8:1:1
-XX:MaxTenuringThreshold=15 # æ™‹å‡è€å¹´ä»£çš„å¹´é¾„é˜ˆå€¼
-XX:PretenureSizeThreshold=1m # å¤§å¯¹è±¡ç›´æ¥è¿›è€å¹´ä»£
```

**Old GCä¼˜åŒ–**
```bash
# è€å¹´ä»£è°ƒä¼˜å‚æ•°
-XX:+UseG1GC              # ä½¿ç”¨G1æ”¶é›†å™¨
-XX:MaxGCPauseMillis=200  # æœ€å¤§åœé¡¿æ—¶é—´ç›®æ ‡
-XX:G1HeapRegionSize=16m  # G1 Regionå¤§å°
-XX:G1NewSizePercent=30   # å¹´è½»ä»£åˆå§‹å æ¯”
-XX:G1MaxNewSizePercent=40 # å¹´è½»ä»£æœ€å¤§å æ¯”
```

**ç›‘æ§å’Œåˆ†æå·¥å…·ï¼š**
```java
// GCæ—¥å¿—åˆ†æ
public class GCAnalyzer {
    
    public void analyzeGCLogs() {
        // ä½¿ç”¨jstatç›‘æ§GC
        // jstat -gc -t pid 1s
        
        // ä½¿ç”¨jmapåˆ†æå †å†…å­˜
        // jmap -histo pid
        // jmap -dump:format=b,file=heap.hprof pid
        
        // ä½¿ç”¨MATåˆ†æå†…å­˜æ³„æ¼
        // Eclipse Memory Analyzer Tool
    }
    
    // ç¨‹åºå†…ç›‘æ§GC
    public void monitorGC() {
        List<GarbageCollectorMXBean> gcBeans = ManagementFactory.getGarbageCollectorMXBeans();
        
        for (GarbageCollectorMXBean gcBean : gcBeans) {
            System.out.println("GC Name: " + gcBean.getName());
            System.out.println("Collection Count: " + gcBean.getCollectionCount());
            System.out.println("Collection Time: " + gcBean.getCollectionTime() + " ms");
        }
    }
}
```

**è°ƒä¼˜æ­¥éª¤ï¼š**
1. **ç›‘æ§ç°çŠ¶**ï¼šæ”¶é›†GCæ—¥å¿—å’Œæ€§èƒ½æŒ‡æ ‡
2. **åˆ†æé—®é¢˜**ï¼šè¯†åˆ«æ€§èƒ½ç“¶é¢ˆ
3. **åˆ¶å®šç­–ç•¥**ï¼šé€‰æ‹©åˆé€‚çš„æ”¶é›†å™¨å’Œå‚æ•°
4. **æµ‹è¯•éªŒè¯**ï¼šåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯æ•ˆæœ
5. **ä¸Šçº¿ç›‘æ§**ï¼šæŒç»­ç›‘æ§å’Œè°ƒæ•´

</details>

### 160. Redis ä¸­çš„ Big Key é—®é¢˜æ˜¯ä»€ä¹ˆï¼Ÿå¦‚ä½•è§£å†³ï¼Ÿ
<details>
<summary>å±•å¼€ <span class="badge badge--info">ä¸­ç­‰</span> <span class="badge badge--primary">VIP</span> <span class="badge badge--secondary">åç«¯</span> <span class="badge badge--secondary">Redis</span></summary>

**Big Keyå®šä¹‰ï¼š**
- **Stringç±»å‹**ï¼švalueå¤§äº10KB
- **Hash/List/Set/ZSet**ï¼šå…ƒç´ ä¸ªæ•°è¶…è¿‡5000
- **å†…å­˜å ç”¨**ï¼šå•ä¸ªkeyå ç”¨å†…å­˜è¶…è¿‡1MB

**Big Keyçš„å±å®³ï¼š**

**1. ç½‘ç»œé˜»å¡**
```
# å¤§keyä¼ è¾“å ç”¨å¸¦å®½
GET large_key  # ä¼ è¾“10MBæ•°æ®
HGETALL large_hash  # è¿”å›10ä¸‡ä¸ªå­—æ®µ
```

**2. è¶…æ—¶é˜»å¡**
```
# åˆ é™¤å¤§keyå¯¼è‡´é˜»å¡
DEL large_list  # åˆ é™¤100ä¸‡å…ƒç´ çš„åˆ—è¡¨
EXPIRE large_set 0  # è¿‡æœŸåˆ é™¤å¤§é›†åˆ
```

**3. å†…å­˜ä¸å‡**
- æŸä¸ªRedisèŠ‚ç‚¹å†…å­˜å ç”¨è¿‡é«˜
- é›†ç¾¤èŠ‚ç‚¹è´Ÿè½½ä¸å‡è¡¡

**æ£€æµ‹Big Keyï¼š**

**1. redis-cliæ‰«æ**
```bash
# æ‰«æbig key
redis-cli --bigkeys -h 127.0.0.1 -p 6379

# è‡ªå®šä¹‰é˜ˆå€¼æ‰«æ
redis-cli --bigkeys --bigkeys-threshold=1000000
```

**2. ç›‘æ§è„šæœ¬**
```python
import redis

def find_big_keys():
    r = redis.Redis(host='localhost', port=6379)
    
    # æ‰«ææ‰€æœ‰key
    for key in r.scan_iter():
        key_type = r.type(key).decode()
        size = 0
        
        if key_type == 'string':
            size = len(r.get(key) or b'')
        elif key_type == 'hash':
            size = r.hlen(key)
        elif key_type == 'list':
            size = r.llen(key)
        elif key_type in ['set', 'zset']:
            size = r.scard(key) if key_type == 'set' else r.zcard(key)
        
        # åˆ¤æ–­æ˜¯å¦ä¸ºbig key
        if (key_type == 'string' and size > 10*1024) or \
           (key_type in ['hash', 'list', 'set', 'zset'] and size > 5000):
            print(f"Big Key: {key}, Type: {key_type}, Size: {size}")
```

**è§£å†³æ–¹æ¡ˆï¼š**

**1. æ‹†åˆ†å¤§key**
```java
// æ‹†åˆ†å¤§Hash
public class HashSplitter {
    
    public void splitLargeHash(String largeKey) {
        // åŸkey: user:1001
        // æ‹†åˆ†ä¸º: user:1001:0, user:1001:1, user:1001:2...
        
        Map<String, String> largeHash = redisTemplate.opsForHash().entries(largeKey);
        int batchSize = 100;
        int batchIndex = 0;
        
        Map<String, String> batch = new HashMap<>();
        for (Map.Entry<String, String> entry : largeHash.entrySet()) {
            batch.put(entry.getKey(), entry.getValue());
            
            if (batch.size() >= batchSize) {
                String newKey = largeKey + ":" + batchIndex++;
                redisTemplate.opsForHash().putAll(newKey, batch);
                batch.clear();
            }
        }
        
        // ä¿å­˜å‰©ä½™æ•°æ®
        if (!batch.isEmpty()) {
            String newKey = largeKey + ":" + batchIndex;
            redisTemplate.opsForHash().putAll(newKey, batch);
        }
        
        // åˆ é™¤åŸkey
        redisTemplate.delete(largeKey);
    }
}
```

**2. åˆ†é¡µè¯»å–**
```java
// åˆ†é¡µè·å–å¤§é›†åˆ
public class PaginatedReader {
    
    public List<String> getListByPage(String key, int page, int pageSize) {
        int start = page * pageSize;
        int end = start + pageSize - 1;
        return redisTemplate.opsForList().range(key, start, end);
    }
    
    public Set<String> getSetByPage(String key, int count) {
        return redisTemplate.opsForSet().distinctRandomMembers(key, count);
    }
    
    public Map<String, String> getHashByPattern(String key, String pattern) {
        Cursor<Map.Entry<String, String>> cursor = redisTemplate.opsForHash()
            .scan(key, ScanOptions.scanOptions().match(pattern).count(100).build());
        
        Map<String, String> result = new HashMap<>();
        while (cursor.hasNext()) {
            Map.Entry<String, String> entry = cursor.next();
            result.put(entry.getKey(), entry.getValue());
        }
        return result;
    }
}
```

**3. å¼‚æ­¥åˆ é™¤**
```java
// å¼‚æ­¥åˆ é™¤å¤§key
public class AsyncDeleter {
    
    public void asyncDeleteLargeKey(String key) {
        String keyType = redisTemplate.type(key).code();
        
        switch (keyType) {
            case "hash":
                asyncDeleteHash(key);
                break;
            case "list":
                asyncDeleteList(key);
                break;
            case "set":
                asyncDeleteSet(key);
                break;
            case "zset":
                asyncDeleteZSet(key);
                break;
            default:
                redisTemplate.delete(key);
        }
    }
    
    private void asyncDeleteHash(String key) {
        // ä½¿ç”¨HSCAN + HDELåˆ†æ‰¹åˆ é™¤
        Cursor<Map.Entry<String, String>> cursor = redisTemplate.opsForHash()
            .scan(key, ScanOptions.scanOptions().count(100).build());
        
        while (cursor.hasNext()) {
            List<String> fields = new ArrayList<>();
            for (int i = 0; i < 100 && cursor.hasNext(); i++) {
                fields.add(cursor.next().getKey());
            }
            redisTemplate.opsForHash().delete(key, fields.toArray());
        }
        
        redisTemplate.delete(key);
    }
    
    private void asyncDeleteList(String key) {
        // ä½¿ç”¨LTRIMé€æ­¥ç¼©çŸ­åˆ—è¡¨
        while (redisTemplate.opsForList().size(key) > 0) {
            redisTemplate.opsForList().trim(key, 100, -1);
        }
        redisTemplate.delete(key);
    }
}
```

**4. ä½¿ç”¨UNLINKå‘½ä»¤**
```bash
# ä½¿ç”¨UNLINKä»£æ›¿DEL
UNLINK large_key  # å¼‚æ­¥åˆ é™¤ï¼Œä¸é˜»å¡
```

**é¢„é˜²æªæ–½ï¼š**

**1. è®¾è®¡è§„èŒƒ**
```java
// keyè®¾è®¡è§„èŒƒ
public class KeyDesignGuidelines {
    
    // 1. æ§åˆ¶valueå¤§å°
    private static final int MAX_STRING_SIZE = 10 * 1024; // 10KB
    private static final int MAX_COLLECTION_SIZE = 5000;   // 5000ä¸ªå…ƒç´ 
    
    // 2. ä½¿ç”¨åˆé€‚çš„æ•°æ®ç»“æ„
    public void useAppropriateDataStructure() {
        // å°‘é‡å­—æ®µç”¨Hash
        // å¤§é‡å­—æ®µè€ƒè™‘æ‹†åˆ†æˆ–ä½¿ç”¨String + JSON
        
        // æœ‰åºæ•°æ®ç”¨ZSet
        // æ— åºæ•°æ®ç”¨Set
        
        // é˜Ÿåˆ—ç”¨List
        // æ ˆç”¨List
    }
    
    // 3. è®¾ç½®è¿‡æœŸæ—¶é—´
    public void setExpiration(String key, Object value) {
        redisTemplate.opsForValue().set(key, value, 3600, TimeUnit.SECONDS);
    }
}
```

**2. ç›‘æ§å‘Šè­¦**
```java
@Component
public class BigKeyMonitor {
    
    @Scheduled(fixedRate = 3600000) // æ¯å°æ—¶æ£€æŸ¥
    public void scanBigKeys() {
        // æ‰«æå¤§keyå¹¶å‘Šè­¦
        List<String> bigKeys = findBigKeys();
        
        if (!bigKeys.isEmpty()) {
            alertService.sendAlert("å‘ç°Big Key", 
                "å‘ç° " + bigKeys.size() + " ä¸ªBig Key: " + String.join(", ", bigKeys));
        }
    }
}
```

**æœ€ä½³å®è·µï¼š**
- **é¢„é˜²ä¸ºä¸»**ï¼šè®¾è®¡æ—¶é¿å…å¤§key
- **ç›‘æ§é¢„è­¦**ï¼šå®šæœŸæ‰«æå’Œç›‘æ§
- **åˆ†æ‹†ç­–ç•¥**ï¼šåˆç†æ‹†åˆ†å¤§key
- **å¼‚æ­¥æ“ä½œ**ï¼šä½¿ç”¨UNLINKå¼‚æ­¥åˆ é™¤
- **ä¸šåŠ¡ä¼˜åŒ–**ï¼šä»ä¸šåŠ¡å±‚é¢ä¼˜åŒ–æ•°æ®ç»“æ„

</details>
